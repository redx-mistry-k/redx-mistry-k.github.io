<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <title>Delimiter Adder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f4f2ee;
        --bg-card: #fff;
        --bg-input: #fafaf8;
        --bg-output: #f4f2ee;
        --border: #e2dfd8;
        --border-focus: #8b7e6a;
        --text: #2c2825;
        --text-muted: #8b8580;
        --text-label: #5c5650;
        --accent: #5b7a5e;
        --accent-hover: #4a6a4d;
        --accent-text: #fff;
        --highlight: #e8d5a0;
        --highlight-text: #5c4a1e;
        --danger: #c05050;
        --danger-bg: #fff0f0;
        --success-bg: #e8f5e9;
        --star: #d4a017;
        --star-bg: #fff8e1;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 4px 12px rgba(0, 0, 0, 0.03);
        --shadow-lg:
          0 2px 8px rgba(0, 0, 0, 0.06), 0 8px 24px rgba(0, 0, 0, 0.06);
        --radius: 10px;
        --radius-sm: 6px;
        --font: "DM Sans", -apple-system, sans-serif;
        --mono: "JetBrains Mono", monospace;
        --transition: 0.2s ease;
      }
      [data-theme="dark"] {
        --bg: #1a1a1e;
        --bg-card: #242428;
        --bg-input: #2c2c32;
        --bg-output: #1e1e22;
        --border: #3a3a40;
        --border-focus: #a09888;
        --text: #e8e4e0;
        --text-muted: #888580;
        --text-label: #a8a4a0;
        --accent: #7a9e7d;
        --accent-hover: #8db890;
        --accent-text: #1a1a1e;
        --highlight: #5c4a1e;
        --highlight-text: #e8d5a0;
        --danger: #e07070;
        --danger-bg: #3a2020;
        --success-bg: #1e3a20;
        --star: #e8b830;
        --star-bg: #3a3420;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.2), 0 4px 12px rgba(0, 0, 0, 0.15);
        --shadow-lg:
          0 2px 8px rgba(0, 0, 0, 0.3), 0 8px 24px rgba(0, 0, 0, 0.2);
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: var(--font);
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        transition:
          background var(--transition),
          color var(--transition);
        -webkit-font-smoothing: antialiased;
      }
      .app {
        max-width: 820px;
        margin: 0 auto;
        padding: 32px 20px 60px;
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 28px;
      }
      .header-left h1 {
        font-size: 1.35rem;
        font-weight: 700;
        letter-spacing: -0.02em;
      }
      .header-left p {
        font-size: 0.82rem;
        color: var(--text-muted);
        margin-top: 2px;
      }
      .header-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .icon-btn {
        width: 36px;
        height: 36px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        background: var(--bg-card);
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all var(--transition);
      }
      .icon-btn:hover {
        border-color: var(--border-focus);
        color: var(--text);
        background: var(--bg-input);
      }
      .icon-btn.active {
        background: var(--accent);
        color: var(--accent-text);
        border-color: var(--accent);
      }
      .card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 24px;
        box-shadow: var(--shadow);
        margin-bottom: 16px;
        transition: all var(--transition);
      }
      .url-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .star-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: var(--radius-sm);
        transition: all var(--transition);
        display: flex;
        align-items: center;
        gap: 5px;
        font-family: var(--font);
        font-size: 0.75rem;
        color: var(--text-muted);
      }
      .star-btn:hover {
        background: var(--star-bg);
        color: var(--star);
      }
      .star-btn.starred {
        color: var(--star);
      }
      .panel {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }
      .panel.open {
        max-height: 600px;
        overflow-y: auto;
      }
      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .panel-header h3 {
        font-size: 0.85rem;
        font-weight: 600;
      }
      .panel-list {
        list-style: none;
        padding: 0;
      }
      .panel-item {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all var(--transition);
        gap: 10px;
        border-bottom: 1px solid var(--border);
      }
      .panel-item:last-child {
        border-bottom: none;
      }
      .panel-item:hover {
        background: var(--bg-input);
      }
      .panel-item-star {
        color: var(--star);
        flex-shrink: 0;
        font-size: 0.85rem;
      }
      .panel-item-info {
        flex: 1;
        min-width: 0;
      }
      .panel-item-name {
        font-size: 0.82rem;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .panel-item-url {
        font-family: var(--mono);
        font-size: 0.68rem;
        color: var(--text-muted);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-top: 2px;
      }
      .panel-item-time {
        font-size: 0.7rem;
        color: var(--text-muted);
        white-space: nowrap;
        flex-shrink: 0;
      }
      .panel-item-delete {
        font-size: 0.7rem;
        color: var(--danger);
        background: none;
        border: none;
        cursor: pointer;
        padding: 2px 6px;
        flex-shrink: 0;
        opacity: 0;
        transition: opacity var(--transition);
        border-radius: 3px;
      }
      .panel-item:hover .panel-item-delete {
        opacity: 1;
      }
      .panel-item-delete:hover {
        background: var(--danger-bg);
      }
      .panel-empty {
        font-size: 0.8rem;
        color: var(--text-muted);
        text-align: center;
        padding: 20px;
      }
      .clear-all-btn {
        font-size: 0.72rem;
        color: var(--danger);
        background: none;
        border: none;
        cursor: pointer;
        font-family: var(--font);
        padding: 2px 6px;
        border-radius: 3px;
      }
      .clear-all-btn:hover {
        background: var(--danger-bg);
      }
      .filter-block {
        padding: 20px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        margin-bottom: 14px;
        background: var(--bg-input);
        transition: all var(--transition);
      }
      .filter-block:hover {
        border-color: var(--border-focus);
      }
      .filter-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 14px;
      }
      .filter-label {
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--accent);
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }
      .remove-filter-btn {
        font-size: 0.75rem;
        color: var(--danger);
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: var(--radius-sm);
        font-family: var(--font);
        font-weight: 500;
        transition: all var(--transition);
      }
      .remove-filter-btn:hover {
        background: var(--danger-bg);
      }
      .filter-row {
        display: grid;
        grid-template-columns: 1fr 120px;
        gap: 10px;
        margin-bottom: 10px;
      }
      .checkbox-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
      }
      .checkbox-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
        min-height: unset;
        accent-color: var(--accent);
        cursor: pointer;
        padding: 0;
      }
      .checkbox-row label {
        font-size: 0.78rem;
        font-weight: 500;
        color: var(--text-muted);
        margin-bottom: 0;
        cursor: pointer;
        user-select: none;
      }
      label {
        font-size: 0.78rem;
        font-weight: 600;
        color: var(--text-label);
        display: block;
        margin-bottom: 5px;
        letter-spacing: 0.02em;
      }
      textarea,
      input[type="text"],
      select {
        font-family: var(--font);
        font-size: 0.85rem;
        color: var(--text);
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 10px 12px;
        width: 100%;
        transition: all var(--transition);
        outline: none;
      }
      textarea:focus,
      input[type="text"]:focus,
      select:focus {
        border-color: var(--border-focus);
        box-shadow: 0 0 0 3px rgba(91, 122, 94, 0.1);
      }
      textarea {
        resize: vertical;
        min-height: 44px;
        line-height: 1.5;
      }
      select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238B8580' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        padding-right: 30px;
      }
      .url-input,
      .values-input {
        font-family: var(--mono);
        font-size: 0.8rem;
      }
      .btn-primary {
        background: var(--accent);
        color: var(--accent-text);
        border: none;
        border-radius: var(--radius-sm);
        padding: 10px 22px;
        font-family: var(--font);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .btn-primary:hover {
        background: var(--accent-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }
      .btn-primary:active {
        transform: translateY(0);
      }
      .btn-secondary {
        background: transparent;
        color: var(--text-muted);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 8px 16px;
        font-family: var(--font);
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }
      .btn-secondary:hover {
        border-color: var(--border-focus);
        color: var(--text);
      }
      .actions-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 18px;
      }
      .output-section {
        opacity: 0;
        max-height: 0;
        overflow: hidden;
        transition:
          opacity 0.3s ease,
          max-height 0.4s ease;
      }
      .output-section.visible {
        opacity: 1;
        max-height: 1000px;
      }
      .output-label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 5px;
      }
      .output-label label {
        margin-bottom: 0;
      }
      .copy-btn {
        font-size: 0.72rem;
        color: var(--accent);
        background: none;
        border: none;
        cursor: pointer;
        font-family: var(--font);
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        transition: all var(--transition);
      }
      .copy-btn:hover {
        background: var(--success-bg);
      }
      .output-box {
        background: var(--bg-output);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 12px 14px;
        font-family: var(--mono);
        font-size: 0.78rem;
        line-height: 1.6;
        word-break: break-all;
        white-space: pre-wrap;
        color: var(--text);
        max-height: 200px;
        overflow-y: auto;
        transition: all var(--transition);
      }
      .output-box mark {
        background-color: var(--highlight);
        color: var(--highlight-text);
        padding: 1px 4px;
        border-radius: 3px;
      }
      .mb-14 {
        margin-bottom: 14px;
      }
      .url-warning {
        background: var(--danger-bg);
        color: var(--danger);
        border: 1px solid var(--danger);
        border-radius: var(--radius-sm);
        padding: 8px 12px;
        font-size: 0.78rem;
        font-weight: 500;
        margin-bottom: 8px;
      }
      .toast {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%) translateY(80px);
        background: var(--text);
        color: var(--bg);
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.82rem;
        font-weight: 500;
        box-shadow: var(--shadow-lg);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 100;
        pointer-events: none;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      .footer {
        text-align: center;
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 24px;
      }
      .output-box::-webkit-scrollbar {
        width: 5px;
      }
      .output-box::-webkit-scrollbar-track {
        background: transparent;
      }
      .output-box::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
      }
      @media (max-width: 600px) {
        .app {
          padding: 20px 14px 40px;
        }
        .card {
          padding: 18px;
        }
        .filter-row {
          grid-template-columns: 1fr;
        }
        .header {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }
        .actions-row {
          flex-direction: column;
          gap: 10px;
        }
        .actions-row .btn-primary {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="header">
        <div class="header-left">
          <h1>Delimiter Adder</h1>
          <p>Build multi-filter SharePoint URLs fast</p>
        </div>
        <div class="header-actions">
          <button
            class="icon-btn"
            id="favToggle"
            title="Favorites"
            onclick="togglePanel('favPanel', 'favToggle')"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polygon
                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
              />
            </svg>
          </button>
          <button
            class="icon-btn"
            id="historyToggle"
            title="History"
            onclick="togglePanel('historyPanel', 'historyToggle')"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10" />
              <polyline points="12 6 12 12 16 14" />
            </svg>
          </button>
          <button
            class="icon-btn"
            id="themeToggle"
            title="Toggle theme"
            onclick="toggleTheme()"
          >
            <svg
              id="sunIcon"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="5" />
              <line x1="12" y1="1" x2="12" y2="3" />
              <line x1="12" y1="21" x2="12" y2="23" />
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
              <line x1="1" y1="12" x2="3" y2="12" />
              <line x1="21" y1="12" x2="23" y2="12" />
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" /></svg
            ><svg
              id="moonIcon"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              style="display: none"
            >
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
            </svg>
          </button>
        </div>
      </div>

      <div class="panel" id="favPanel">
        <div class="card">
          <div class="panel-header">
            <h3>★ Saved URLs</h3>
            <button class="clear-all-btn" onclick="clearFavorites()">
              Clear all
            </button>
          </div>
          <ul class="panel-list" id="favList">
            <li class="panel-empty">
              No favorites yet. Star a URL to save it.
            </li>
          </ul>
        </div>
      </div>

      <div class="panel" id="historyPanel">
        <div class="card">
          <div class="panel-header">
            <h3>Recent URLs</h3>
            <button class="clear-all-btn" onclick="clearHistory()">
              Clear all
            </button>
          </div>
          <ul class="panel-list" id="historyList">
            <li class="panel-empty">No history yet</li>
          </ul>
        </div>
      </div>

      <div class="card">
        <div class="url-card-header">
          <label for="urlInput" style="margin-bottom: 0">SharePoint URL</label>
          <button
            class="star-btn"
            id="starBtn"
            onclick="toggleFavorite()"
            title="Save to favorites"
          >
            <svg
              id="starEmpty"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polygon
                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
              />
            </svg>
            <svg
              id="starFilled"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="currentColor"
              stroke="currentColor"
              stroke-width="2"
              style="display: none"
            >
              <polygon
                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
              />
            </svg>
            <span id="starLabel">Save</span>
          </button>
        </div>
        <textarea
          id="urlInput"
          class="url-input"
          rows="3"
          placeholder="Paste your SharePoint URL with at least one filter applied..."
        ></textarea>
        <div class="checkbox-row">
          <input type="checkbox" id="clearValuesCheckbox" checked />
          <label for="clearValuesCheckbox"
            >Clear filter values from URL (keep columns & types only)</label
          >
        </div>
      </div>

      <div class="card">
        <div
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
          "
        >
          <label style="margin-bottom: 0">Filters</label>
          <button class="btn-secondary" onclick="addFilter()" id="addFilterBtn">
            <svg
              width="12"
              height="12"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
            >
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            Add Filter
          </button>
        </div>
        <div id="filtersContainer"></div>
        <div class="actions-row">
          <button class="btn-secondary" onclick="resetAll()">
            <svg
              width="12"
              height="12"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="1 4 1 10 7 10" />
              <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
            </svg>
            Reset
          </button>
          <button class="btn-primary" onclick="processUrl()">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
            >
              <path
                d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"
              />
              <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
            </svg>
            Format &amp; Copy URL
          </button>
        </div>
      </div>

      <div class="output-section" id="outputSection">
        <div class="card">
          <div class="mb-14">
            <div class="output-label">
              <label>Encoded Values</label
              ><button class="copy-btn" onclick="copyText('encodedValues')">
                Copy
              </button>
            </div>
            <div id="encodedValues" class="output-box"></div>
          </div>
          <div>
            <div class="output-label">
              <label>Updated URL</label
              ><button class="copy-btn" onclick="copyFinalUrl()">Copy</button>
            </div>
            <div
              id="urlLengthWarning"
              class="url-warning"
              style="display: none"
            ></div>
            <div id="finalUrl" class="output-box"></div>
          </div>
        </div>
      </div>

      <p class="footer">
        Runs entirely in your browser. Nothing is stored or sent anywhere.
      </p>
    </div>
    <div class="toast" id="toast"></div>

    <script>
      const DELIMITER = "%3B%23",
        NUMBER_DECIMALS = 11,
        HISTORY_KEY = "delimiterAdder_history",
        FAVORITES_KEY = "delimiterAdder_favorites",
        THEME_KEY = "delimiterAdder_theme",
        MAX_HISTORY = 15;
      let filterCount = 0,
        finalUrlRaw = "";

      function toggleTheme() {
        const h = document.documentElement,
          n = h.getAttribute("data-theme") === "dark" ? "light" : "dark";
        h.setAttribute("data-theme", n);
        localStorage.setItem(THEME_KEY, n);
        updateThemeIcon(n);
      }
      function updateThemeIcon(t) {
        document.getElementById("sunIcon").style.display =
          t === "dark" ? "none" : "block";
        document.getElementById("moonIcon").style.display =
          t === "dark" ? "block" : "none";
      }
      function loadTheme() {
        const s = localStorage.getItem(THEME_KEY);
        if (s) {
          document.documentElement.setAttribute("data-theme", s);
          updateThemeIcon(s);
        } else if (window.matchMedia("(prefers-color-scheme:dark)").matches) {
          document.documentElement.setAttribute("data-theme", "dark");
          updateThemeIcon("dark");
        }
      }

      let toastTimer;
      function showToast(m) {
        const t = document.getElementById("toast");
        t.textContent = m;
        t.classList.add("show");
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => t.classList.remove("show"), 2200);
      }

      function togglePanel(pid, bid) {
        document.querySelectorAll(".panel").forEach((p) => {
          if (p.id !== pid) p.classList.remove("open");
        });
        document
          .querySelectorAll(".header-actions .icon-btn.active")
          .forEach((b) => {
            if (b.id !== bid) b.classList.remove("active");
          });
        document.getElementById(pid).classList.toggle("open");
        document.getElementById(bid).classList.toggle("active");
      }

      function extractListName(url) {
        const m = url.match(/\/Lists\/([^/?]+)/i);
        if (m) return decodeURIComponent(m[1]).replace(/_/g, " ");
        try {
          const u = new URL(url);
          const p = u.pathname.split("/").filter(Boolean);
          return p[p.length - 1] || u.hostname;
        } catch {
          return "Untitled";
        }
      }
      function escapeHtml(s) {
        return s
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }
      function timeAgo(ts) {
        const d = Date.now() - ts,
          m = Math.floor(d / 6e4);
        if (m < 1) return "just now";
        if (m < 60) return m + "m ago";
        const h = Math.floor(m / 60);
        if (h < 24) return h + "h ago";
        return Math.floor(h / 24) + "d ago";
      }

      // Favorites
      function getFavorites() {
        try {
          return JSON.parse(localStorage.getItem(FAVORITES_KEY)) || [];
        } catch {
          return [];
        }
      }
      function saveFavData(f) {
        localStorage.setItem(FAVORITES_KEY, JSON.stringify(f));
      }
      function isUrlFavorited(u) {
        return u ? getFavorites().some((f) => f.url === u) : false;
      }

      function toggleFavorite() {
        const url = document.getElementById("urlInput").value.trim();
        if (!url) {
          showToast("Paste a URL first");
          return;
        }
        let favs = getFavorites();
        const idx = favs.findIndex((f) => f.url === url);
        if (idx !== -1) {
          favs.splice(idx, 1);
          saveFavData(favs);
          showToast("Removed from favorites");
        } else {
          const name = extractListName(url);
          favs.unshift({ url, name, time: Date.now() });
          saveFavData(favs);
          showToast('Saved "' + name + '" to favorites');
        }
        updateStarButton();
        renderFavorites();
      }

      function updateStarButton() {
        const url = document.getElementById("urlInput").value.trim(),
          isFav = isUrlFavorited(url);
        document.getElementById("starBtn").classList.toggle("starred", isFav);
        document.getElementById("starEmpty").style.display = isFav
          ? "none"
          : "block";
        document.getElementById("starFilled").style.display = isFav
          ? "block"
          : "none";
        document.getElementById("starLabel").textContent = isFav
          ? "Saved"
          : "Save";
      }

      function loadFromFavorite(i) {
        const favs = getFavorites();
        if (favs[i]) {
          document.getElementById("urlInput").value = favs[i].url;
          updateStarButton();
          autoDetectFilters();
          togglePanel("favPanel", "favToggle");
          showToast('Loaded "' + favs[i].name + '"');
        }
      }
      function deleteFavorite(i, e) {
        e.stopPropagation();
        let f = getFavorites();
        f.splice(i, 1);
        saveFavData(f);
        renderFavorites();
        updateStarButton();
        showToast("Removed");
      }
      function clearFavorites() {
        localStorage.removeItem(FAVORITES_KEY);
        renderFavorites();
        updateStarButton();
        showToast("Favorites cleared");
      }

      function renderFavorites() {
        const list = document.getElementById("favList"),
          favs = getFavorites();
        if (!favs.length) {
          list.innerHTML =
            '<li class="panel-empty">No favorites yet. Star a URL to save it.</li>';
          return;
        }
        list.innerHTML = favs
          .map((f, i) => {
            const s =
              f.url.length > 60 ? f.url.substring(0, 60) + "..." : f.url;
            return (
              '<li class="panel-item" onclick="loadFromFavorite(' +
              i +
              ')"><span class="panel-item-star">★</span><div class="panel-item-info"><div class="panel-item-name">' +
              escapeHtml(f.name) +
              '</div><div class="panel-item-url">' +
              escapeHtml(s) +
              '</div></div><span class="panel-item-time">' +
              timeAgo(f.time) +
              '</span><button class="panel-item-delete" onclick="deleteFavorite(' +
              i +
              ',event)" title="Remove">✕</button></li>'
            );
          })
          .join("");
      }

      // History
      function getHistory() {
        try {
          return JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
        } catch {
          return [];
        }
      }
      function saveToHistory(url) {
        let h = getHistory();
        h = h.filter((x) => x.url !== url);
        h.unshift({ url, name: extractListName(url), time: Date.now() });
        if (h.length > MAX_HISTORY) h = h.slice(0, MAX_HISTORY);
        localStorage.setItem(HISTORY_KEY, JSON.stringify(h));
        renderHistory();
      }
      function clearHistory() {
        localStorage.removeItem(HISTORY_KEY);
        renderHistory();
        showToast("History cleared");
      }
      function deleteHistoryItem(i, e) {
        e.stopPropagation();
        let h = getHistory();
        h.splice(i, 1);
        localStorage.setItem(HISTORY_KEY, JSON.stringify(h));
        renderHistory();
      }
      function loadFromHistory(i) {
        const h = getHistory();
        if (h[i]) {
          document.getElementById("urlInput").value = h[i].url;
          updateStarButton();
          autoDetectFilters();
          togglePanel("historyPanel", "historyToggle");
          showToast("Loaded from history");
        }
      }

      function renderHistory() {
        const list = document.getElementById("historyList"),
          hist = getHistory();
        if (!hist.length) {
          list.innerHTML = '<li class="panel-empty">No history yet</li>';
          return;
        }
        list.innerHTML = hist
          .map((h, i) => {
            const s =
              h.url.length > 60 ? h.url.substring(0, 60) + "..." : h.url;
            const n = h.name || extractListName(h.url);
            return (
              '<li class="panel-item" onclick="loadFromHistory(' +
              i +
              ')"><div class="panel-item-info"><div class="panel-item-name">' +
              escapeHtml(n) +
              '</div><div class="panel-item-url">' +
              escapeHtml(s) +
              '</div></div><span class="panel-item-time">' +
              timeAgo(h.time) +
              '</span><button class="panel-item-delete" onclick="deleteHistoryItem(' +
              i +
              ',event)" title="Remove">✕</button></li>'
            );
          })
          .join("");
      }

      // Filters
      function addFilter(fNum) {
        filterCount++;
        const num = fNum || filterCount,
          id = "f_" + Date.now() + "_" + num;
        const b = document.createElement("div");
        b.className = "filter-block";
        b.id = id;
        b.innerHTML =
          '<div class="filter-header"><span class="filter-label">Filter ' +
          num +
          "</span>" +
          (filterCount > 1
            ? '<button class="remove-filter-btn" onclick="removeFilter(\'' +
              id +
              "')\">Remove</button>"
            : "") +
          '</div><div class="filter-row"><div><label>Column Name</label><input type="text" class="filter-column" placeholder="e.g. Study_Status" data-num="' +
          num +
          '"></div><div><label>Type</label><select class="filter-type" data-num="' +
          num +
          '"><option value="Text">Text</option><option value="Number">Number</option><option value="Counter">Counter</option><option value="Calculated">Calculated</option></select></div></div><div><label>Values (one per line)</label><textarea class="values-input filter-values" rows="3" placeholder="value1&#10;value2&#10;value3" data-num="' +
          num +
          '"></textarea></div>';
        document.getElementById("filtersContainer").appendChild(b);
        updateRemoveButtons();
        updateAddFilterButton();
      }

      function removeFilter(id) {
        const el = document.getElementById(id);
        if (el) {
          el.style.opacity = "0";
          el.style.transform = "scale(.97)";
          el.style.transition = "all .2s";
          setTimeout(() => {
            el.remove();
            renumberFilters();
            updateRemoveButtons();
            updateAddFilterButton();
          }, 200);
        }
      }

      function renumberFilters() {
        const blocks = document.querySelectorAll(".filter-block");
        blocks.forEach((b, i) => {
          const n = i + 1;
          b.querySelector(".filter-label").textContent = "Filter " + n;
          b.querySelectorAll("[data-num]").forEach((el) =>
            el.setAttribute("data-num", n),
          );
        });
        filterCount = blocks.length;
      }

      function updateRemoveButtons() {
        const blocks = document.querySelectorAll(".filter-block");
        blocks.forEach((block) => {
          const ex = block.querySelector(".remove-filter-btn");
          if (blocks.length <= 1 && ex) ex.remove();
          if (blocks.length > 1 && !ex) {
            const hdr = block.querySelector(".filter-header"),
              btn = document.createElement("button");
            btn.className = "remove-filter-btn";
            btn.textContent = "Remove";
            btn.onclick = () => removeFilter(block.id);
            hdr.appendChild(btn);
          }
        });
      }

      function updateAddFilterButton() {
        document.getElementById("addFilterBtn").style.display =
          document.querySelectorAll(".filter-block").length >= 5
            ? "none"
            : "inline-flex";
      }

      // Encoding
      function encodeText(v) {
        return encodeURIComponent(v)
          .replace(/\./g, "%2E")
          .replace(/,/g, "%2C")
          .replace(/;/g, "%3B")
          .replace(/-/g, "%2D");
      }
      function encodeNumber(v) {
        const c = v.replace(/,/g, "").trim();
        if (c === "" || isNaN(c)) return null;
        return encodeURIComponent(Number(c).toFixed(NUMBER_DECIMALS)).replace(
          /\./g,
          "%2E",
        );
      }

      // URL helpers
      function parseUrlParts(url) {
        const q = url.indexOf("?");
        if (q === -1) return { base: url, params: [] };
        const params = [];
        for (const p of url.substring(q + 1).split("&")) {
          const e = p.indexOf("=");
          if (e === -1) {
            params.push({ key: p, value: "" });
          } else {
            params.push({ key: p.substring(0, e), value: p.substring(e + 1) });
          }
        }
        return { base: url.substring(0, q), params };
      }
      function rebuildUrl(base, params) {
        return params.length === 0
          ? base
          : base + "?" + params.map((p) => p.key + "=" + p.value).join("&");
      }
      function isFilterParam(key) {
        return /^Filter(Field|Value|Type)s?\d+$/i.test(key);
      }

      // Main process
      function processUrl() {
        const url = document.getElementById("urlInput").value.trim();
        if (!url) {
          showToast("Please paste a URL first");
          return;
        }
        const blocks = document.querySelectorAll(".filter-block");
        if (!blocks.length) {
          showToast("Add at least one filter");
          return;
        }

        const { base, params } = parseUrlParts(url);
        const nonFilter = params.filter((p) => !isFilterParam(p.key));
        let summary = [],
          fParams = [],
          meta = [],
          err = false;

        blocks.forEach((block) => {
          if (err) return;
          const num = block
            .querySelector(".filter-column")
            .getAttribute("data-num");
          const col = block.querySelector(".filter-column").value.trim();
          const type = block.querySelector(".filter-type").value;
          const raw = block.querySelector(".filter-values").value;
          const isNum = type === "Number" || type === "Counter";
          const vals = raw
            .split(/\r?\n/)
            .map((v) => v.trim())
            .filter((v) => v !== "");
          if (!vals.length) {
            showToast("Filter " + num + ": add at least one value");
            err = true;
            return;
          }

          const multi = vals.length > 1;
          const fk = multi ? "FilterFields" + num : "FilterField" + num;
          const vk = multi ? "FilterValues" + num : "FilterValue" + num;
          const tk = multi ? "FilterTypes" + num : "FilterType" + num;

          const enc = [];
          for (const v of vals) {
            const e = isNum ? encodeNumber(v) : encodeText(v);
            if (e === null) {
              showToast('Invalid number: "' + v + '" in Filter ' + num);
              err = true;
              return;
            }
            enc.push(e);
          }
          const joined = enc.join(DELIMITER);
          summary.push("Filter " + num + ": " + joined);

          if (col) fParams.push({ key: fk, value: encodeURIComponent(col) });
          fParams.push({ key: vk, value: joined });
          fParams.push({ key: tk, value: type });
          meta.push({ num, multi, vk, joined });
        });
        if (err) return;

        const all = [...fParams, ...nonFilter];
        finalUrlRaw = rebuildUrl(base, all);
        document.getElementById("encodedValues").textContent =
          summary.join("\n");

        let disp = escapeHtml(finalUrlRaw);
        for (const m of meta) {
          const k = m.vk + "=";
          const idx = disp.indexOf(k);
          if (idx !== -1) {
            const s = idx + k.length,
              a = disp.indexOf("&amp;", s),
              e = a !== -1 ? a : disp.length;
            const v = disp.substring(s, e);
            disp =
              disp.substring(0, s) +
              "<mark>" +
              v +
              "</mark>" +
              disp.substring(e);
          }
          if (m.multi) {
            disp = disp
              .replace(
                new RegExp("FilterFields" + m.num),
                "FilterField<mark>s</mark>" + m.num,
              )
              .replace(
                new RegExp("FilterValues" + m.num),
                "FilterValue<mark>s</mark>" + m.num,
              )
              .replace(
                new RegExp("FilterTypes" + m.num),
                "FilterType<mark>s</mark>" + m.num,
              );
          }
        }
        // URL length warning
        const lenWarn = document.getElementById("urlLengthWarning");
        if (finalUrlRaw.length >= 2000) {
          lenWarn.innerHTML =
            "⚠️ URL is <strong>" +
            finalUrlRaw.length +
            "</strong> characters (SharePoint limit is 2000). It may not work — try reducing filter values.";
          lenWarn.style.display = "block";
        } else {
          lenWarn.style.display = "none";
        }

        document.getElementById("finalUrl").innerHTML = disp;
        document.getElementById("outputSection").classList.add("visible");
        navigator.clipboard
          .writeText(finalUrlRaw)
          .then(() => showToast("URL copied to clipboard!"))
          .catch(() => showToast("Formatted! Click Copy to copy."));
        saveToHistory(finalUrlRaw);
      }

      function copyText(id) {
        navigator.clipboard
          .writeText(document.getElementById(id).textContent)
          .then(() => showToast("Copied!"));
      }
      function copyFinalUrl() {
        if (finalUrlRaw)
          navigator.clipboard
            .writeText(finalUrlRaw)
            .then(() => showToast("URL copied!"));
      }

      function resetAll() {
        document.getElementById("urlInput").value = "";
        document.getElementById("filtersContainer").innerHTML = "";
        document.getElementById("outputSection").classList.remove("visible");
        document.getElementById("encodedValues").textContent = "";
        document.getElementById("finalUrl").innerHTML = "";
        finalUrlRaw = "";
        filterCount = 0;
        updateStarButton();
        addFilter(1);
      }

      // Auto-detect
      function autoDetectFilters() {
        const url = document.getElementById("urlInput").value;
        if (!url) return;
        const clear = document.getElementById("clearValuesCheckbox").checked;
        const indices = new Set();
        const rx = /Filter(?:Field|Value|Type)s?(\d+)=/g;
        let m;
        while ((m = rx.exec(url)) !== null) indices.add(parseInt(m[1]));
        if (!indices.size) return;

        document.getElementById("filtersContainer").innerHTML = "";
        filterCount = 0;
        [...indices]
          .sort((a, b) => a - b)
          .forEach((idx) => {
            addFilter(idx);
            const block = document.querySelector(".filter-block:last-child");
            if (!block) return;
            const fm = url.match(
              new RegExp("FilterFields?" + idx + "=([^&]*)"),
            );
            if (fm)
              block.querySelector(".filter-column").value = decodeURIComponent(
                fm[1],
              );
            const tm = url.match(new RegExp("FilterTypes?" + idx + "=([^&]*)"));
            if (tm) block.querySelector(".filter-type").value = tm[1];
            if (!clear) {
              const vm = url.match(
                new RegExp("FilterValues?" + idx + "=([^&]*)"),
              );
              if (vm) {
                const parts = vm[1].split(/%3B%23/gi);
                block.querySelector(".filter-values").value = parts
                  .map((p) => {
                    try {
                      return decodeURIComponent(p);
                    } catch {
                      return p;
                    }
                  })
                  .join("\n");
              }
            }
          });
        updateStarButton();
      }

      // Init
      loadTheme();
      addFilter(1);
      renderHistory();
      renderFavorites();
      updateStarButton();
      document.getElementById("urlInput").addEventListener("input", () =>
        setTimeout(() => {
          autoDetectFilters();
          updateStarButton();
        }, 100),
      );
      document
        .getElementById("clearValuesCheckbox")
        .addEventListener("change", () => autoDetectFilters());
    </script>
  </body>
</html>
