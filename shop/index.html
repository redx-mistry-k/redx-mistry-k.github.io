<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Restaurant Takeaway Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: #f5f5f5;
      color: #222;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      background: #ffffff;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
      background: #111827;
      color: #f9fafb;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
    }

    header small {
      font-size: 12px;
      opacity: 0.8;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid #eee;
      background: #f9fafb;
    }

    .tab-button {
      flex: 1;
      padding: 10px 8px;
      text-align: center;
      font-size: 14px;
      border: none;
      background: transparent;
      cursor: pointer;
      outline: none;
    }

    .tab-button.active {
      background: #111827;
      color: #f9fafb;
    }

    main {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    h2 {
      font-size: 16px;
      margin: 8px 0 6px;
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    .menu-item {
      background: #f3f4f6;
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
      border: 1px solid transparent;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .menu-item:hover {
      border-color: #111827;
    }

    .menu-item-name {
      font-size: 14px;
      font-weight: 500;
    }

    .menu-item-price {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 2px;
    }

    .badge-veg {
      display: inline-block;
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      background: #dcfce7;
      color: #166534;
      margin-top: 4px;
      align-self: flex-start;
    }

    .badge-nonveg {
      display: inline-block;
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      background: #fee2e2;
      color: #991b1b;
      margin-top: 4px;
      align-self: flex-start;
    }

    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #e5e7eb;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 11px;
      opacity: 0.8;
    }

    .chip {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      align-items: center;
    }

    .chip-preparing {
      background: #e0f2fe;
      color: #075985;
    }

    .chip-ready {
      background: #dcfce7;
      color: #166534;
    }

    .chip-done {
      background: #e5e7eb;
      color: #374151;
    }

    .items-list {
      font-size: 13px;
      margin: 4px 0;
      padding-left: 16px;
    }

    .items-list li {
      margin-bottom: 2px;
    }

    .note {
      font-size: 12px;
      font-style: italic;
      opacity: 0.9;
      margin-top: 4px;
    }

    .total-row {
      font-size: 13px;
      font-weight: 600;
      text-align: right;
      margin-top: 4px;
    }

    .btn-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .btn-primary {
      background: #111827;
      color: #f9fafb;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
    }

    .btn-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
    }

    .btn-info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #3b82f6;
    }

    .btn-whatsapp {
      background: #25d366;
      color: white;
    }

    input, textarea {
      width: 100%;
      padding: 8px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      margin-bottom: 6px;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .cart-empty {
      font-size: 12px;
      opacity: 0.8;
    }

    .cart-items {
      font-size: 13px;
      margin-bottom: 4px;
    }

    .cart-items div {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .highlight {
      font-weight: 600;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    .summary-card {
      background: #f3f4f6;
      border-radius: 10px;
      padding: 8px;
      font-size: 13px;
    }

    .summary-card span {
      display: block;
    }

    .summary-label {
      font-size: 11px;
      opacity: 0.7;
    }

    .summary-value {
      font-size: 16px;
      font-weight: 600;
      margin-top: 2px;
    }

    .small {
      font-size: 11px;
      opacity: 0.8;
    }

    .top-info {
      font-size: 11px;
      opacity: 0.7;
      margin-bottom: 6px;
    }

    .filter-row {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .filter-chip {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      cursor: pointer;
    }

    .filter-chip.active {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    .modal-bill {
      font-family: monospace;
      font-size: 14px;
      line-height: 1.4;
      background: #f9f9f9;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      white-space: pre-wrap;
      overflow-wrap: break-word;
    }

    .phone-input-container {
      margin-bottom: 16px;
    }

    .phone-input {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 8px;
    }

    .phone-input:focus {
      outline: none;
      border-color: #25d366;
    }

    .whatsapp-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .btn-whatsapp-option {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .btn-whatsapp-copy {
      background: #f3f4f6;
      color: #111827;
    }

    .btn-whatsapp-send {
      background: #25d366;
      color: white;
    }

    .btn-icon {
      font-size: 16px;
    }

    .export-modal-content {
      max-width: 500px;
    }

    .export-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .export-option {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .export-option:hover {
      background: #f9fafb;
      border-color: #111827;
    }

    .export-icon {
      font-size: 20px;
      margin-right: 12px;
      width: 40px;
      text-align: center;
    }

    .export-text {
      flex: 1;
    }

    .export-title {
      font-weight: 600;
      font-size: 14px;
    }

    .export-description {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    .date-range-selector {
      margin: 15px 0;
      padding: 10px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .date-range-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .date-input-group {
      flex: 1;
    }

    .date-input-group label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: #666;
    }

    .date-input {
      width: 100%;
      padding: 8px;
      font-size: 13px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
    }

    .export-status {
      text-align: center;
      padding: 10px;
      font-size: 13px;
      color: #666;
    }

    @media (max-width: 500px) {
      main {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Takeaway Manager</h1>
      <small>For small restaurants Â· Runs in browser only</small>
    </header>

    <div class="tabs">
      <button class="tab-button active" data-tab="new-order">New Order</button>
      <button class="tab-button" data-tab="queue">Queue</button>
      <button class="tab-button" data-tab="summary">Summary</button>
    </div>

    <main>
      <!-- New Order Section -->
      <section id="new-order" class="section active">
        <div class="top-info">
          Tap items to add them to the order. Then save the order to the queue.
        </div>

        <h2>Menu</h2>
        <div class="menu-grid" id="menu-grid">
          <!-- Menu items injected by JS -->
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Current Order</div>
              <div class="card-subtitle" id="order-items-count">No items added yet</div>
            </div>
            <div>
              <span class="card-subtitle" id="order-total">Total: â‚¹0</span>
            </div>
          </div>

          <div id="cart-content">
            <p class="cart-empty">Tap any item from the menu above to add it here.</p>
          </div>

          <input id="customer-name" type="text" placeholder="Customer name (optional)" />
          <input id="customer-phone" type="tel" placeholder="Customer phone (optional, for WhatsApp)" />
          <textarea id="order-note" placeholder="Notes (e.g., no onion, extra spicy)"></textarea>

          <div class="btn-row">
            <button class="btn btn-secondary" id="clear-cart-btn">Clear Order</button>
            <button class="btn btn-primary" id="save-order-btn">Save Order to Queue</button>
          </div>
        </div>
      </section>

      <!-- Queue Section -->
      <section id="queue" class="section">
        <div class="top-info">
          View all active orders. Update status as you prepare and hand over.
        </div>

        <div class="filter-row">
          <button class="filter-chip active" data-status="all">All</button>
          <button class="filter-chip" data-status="preparing">Preparing</button>
          <button class="filter-chip" data-status="ready">Ready</button>
        </div>

        <div id="queue-list">
          <!-- Orders rendered here -->
        </div>
      </section>

      <!-- Summary Section -->
      <section id="summary" class="section">
        <div class="top-info">
          This summary is based on all orders stored in this browser. Use "Reset Day" at closing time.
        </div>

        <div class="summary-grid">
          <div class="summary-card">
            <span class="summary-label">Total orders</span>
            <span class="summary-value" id="summary-orders">0</span>
          </div>
          <div class="summary-card">
            <span class="summary-label">Total sales</span>
            <span class="summary-value" id="summary-sales">â‚¹0</span>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Most ordered items</div>
          </div>
          <ul class="items-list" id="summary-items">
            <!-- Popular items list -->
          </ul>
        </div>

        <div class="btn-row">
          <button class="btn btn-info" id="export-sales-btn">
            <span class="btn-icon">ðŸ“Š</span>
            Export Sales Data
          </button>
          <button class="btn btn-danger" id="reset-day-btn">Reset Day (Clear All Orders)</button>
        </div>
        
        <p class="small">Note: Export will download all order data as CSV/Excel file. Reset Day will delete all stored orders from this device. Use at the end of the day.</p>
      </section>
    </main>
  </div>

  <!-- WhatsApp Modal -->
  <div class="modal" id="whatsapp-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Send Bill via WhatsApp</div>
        <button class="modal-close" id="close-modal-btn">&times;</button>
      </div>
      
      <div class="modal-bill" id="bill-preview">
        <!-- Bill preview will be shown here -->
      </div>

      <div class="phone-input-container">
        <label for="phone-number">Customer Phone Number (with country code):</label>
        <input 
          type="tel" 
          id="phone-number" 
          class="phone-input" 
          placeholder="Example: +919876543210"
          value=""
        />
        <p class="small">Leave blank to only copy the bill text</p>
      </div>

      <div class="whatsapp-options">
        <button class="btn-whatsapp-option btn-whatsapp-copy" id="copy-bill-btn">
          <span class="btn-icon">ðŸ“‹</span>
          Copy Bill Text
        </button>
        
        <button class="btn-whatsapp-option btn-whatsapp-send" id="send-whatsapp-btn">
          <span class="btn-icon">ðŸ’¬</span>
          Open WhatsApp
        </button>
      </div>
    </div>
  </div>

  <!-- Export Sales Modal -->
  <div class="modal" id="export-modal">
    <div class="modal-content export-modal-content">
      <div class="modal-header">
        <div class="modal-title">Export Sales Data</div>
        <button class="modal-close" id="close-export-modal-btn">&times;</button>
      </div>

      <div class="date-range-selector">
        <div class="date-range-row">
          <div class="date-input-group">
            <label for="start-date">From Date</label>
            <input type="date" id="start-date" class="date-input">
          </div>
          <div class="date-input-group">
            <label for="end-date">To Date</label>
            <input type="date" id="end-date" class="date-input">
          </div>
        </div>
        <div class="small" style="text-align: center; margin-top: 8px;">
          Leave dates empty to export all orders
        </div>
      </div>

      <div class="export-options">
        <div class="export-option" id="export-csv-option">
          <div class="export-icon">ðŸ“„</div>
          <div class="export-text">
            <div class="export-title">Export as CSV</div>
            <div class="export-description">Comma-separated values file, can be opened in Excel, Google Sheets, etc.</div>
          </div>
        </div>
        
        <div class="export-option" id="export-excel-option">
          <div class="export-icon">ðŸ“Š</div>
          <div class="export-text">
            <div class="export-title">Export as Excel (XLSX)</div>
            <div class="export-description">Microsoft Excel format with formatting</div>
          </div>
        </div>

        <div class="export-option" id="export-details-option">
          <div class="export-icon">ðŸ“‹</div>
          <div class="export-text">
            <div class="export-title">Export Detailed Report</div>
            <div class="export-description">Includes item-level details for each order</div>
          </div>
        </div>
      </div>

      <div class="export-status" id="export-status"></div>
    </div>
  </div>

  <script>
    // ------ CONFIG: MENU ------
    const MENU = [
      { id: 1, name: "Idli (2 pcs)", price: 30, veg: true },
      { id: 2, name: "Dosa", price: 50, veg: true },
      { id: 3, name: "Poori Masala", price: 60, veg: true },
      { id: 4, name: "Veg Fried Rice", price: 90, veg: true },
      { id: 5, name: "Chicken Fried Rice", price: 120, veg: false },
      { id: 6, name: "Egg Fried Rice", price: 100, veg: false },
      { id: 7, name: "Parotta", price: 20, veg: true },
      { id: 8, name: "Chicken Curry", price: 130, veg: false }
    ];

    const STORAGE_KEY = "takeaway_orders_v1";

    let orders = [];
    let cart = [];
    let currentStatusFilter = "all";
    let currentOrderForWhatsApp = null;

    // ------ INIT ------
    function init() {
      renderMenu();
      loadOrders();
      renderCart();
      renderQueue();
      renderSummary();
      setupTabs();
      setupActions();
      setupWhatsAppModal();
      setupExportModal();
    }

    // ------ MENU RENDER ------
    function renderMenu() {
      const menuGrid = document.getElementById("menu-grid");
      menuGrid.innerHTML = "";
      MENU.forEach(item => {
        const div = document.createElement("div");
        div.className = "menu-item";
        div.onclick = () => addToCart(item.id);
        div.innerHTML = `
          <span class="menu-item-name">${item.name}</span>
          <span class="menu-item-price">â‚¹${item.price}</span>
          <span class="${item.veg ? "badge-veg" : "badge-nonveg"}">
            ${item.veg ? "Veg" : "Non-Veg"}
          </span>
        `;
        menuGrid.appendChild(div);
      });
    }

    // ------ CART LOGIC ------
    function addToCart(menuId) {
      const item = MENU.find(m => m.id === menuId);
      if (!item) return;

      const existing = cart.find(ci => ci.id === menuId);
      if (existing) {
        existing.qty += 1;
      } else {
        cart.push({ ...item, qty: 1 });
      }
      renderCart();
    }

    function clearCart() {
      cart = [];
      renderCart();
    }

    function renderCart() {
      const cartContent = document.getElementById("cart-content");
      const countLabel = document.getElementById("order-items-count");
      const totalLabel = document.getElementById("order-total");

      if (cart.length === 0) {
        cartContent.innerHTML = `<p class="cart-empty">Tap any item from the menu above to add it here.</p>`;
        countLabel.textContent = "No items added yet";
        totalLabel.textContent = "Total: â‚¹0";
        return;
      }

      let totalItems = 0;
      let totalPrice = 0;

      const wrapper = document.createElement("div");
      wrapper.className = "cart-items";

      cart.forEach(ci => {
        totalItems += ci.qty;
        totalPrice += ci.qty * ci.price;

        const row = document.createElement("div");
        row.innerHTML = `
          <span>${ci.qty} x ${ci.name}</span>
          <span>â‚¹${ci.qty * ci.price}</span>
        `;
        wrapper.appendChild(row);
      });

      cartContent.innerHTML = "";
      cartContent.appendChild(wrapper);

      countLabel.textContent = `${totalItems} item${totalItems > 1 ? "s" : ""} in this order`;
      totalLabel.textContent = `Total: â‚¹${totalPrice}`;
    }

    // ------ ORDERS: STORAGE ------
    function loadOrders() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        orders = saved ? JSON.parse(saved) : [];
      } catch (e) {
        orders = [];
      }
    }

    function saveOrders() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(orders));
    }

    // ------ SAVE ORDER ------
    function saveOrder() {
      if (cart.length === 0) {
        alert("Add at least one item to the order.");
        return;
      }

      const nameInput = document.getElementById("customer-name");
      const phoneInput = document.getElementById("customer-phone");
      const noteInput = document.getElementById("order-note");

      const createdAt = new Date();
      const orderId = createdAt.getTime();

      const order = {
        id: orderId,
        displayId: "#" + (orders.length + 1),
        customerName: nameInput.value.trim() || "No name",
        customerPhone: phoneInput.value.trim() || "",
        note: noteInput.value.trim(),
        items: cart.map(ci => ({ id: ci.id, name: ci.name, price: ci.price, qty: ci.qty })),
        status: "preparing",
        total: cart.reduce((sum, ci) => sum + ci.qty * ci.price, 0),
        createdAt: createdAt.toISOString()
      };

      orders.push(order);
      saveOrders();
      clearCart();
      nameInput.value = "";
      phoneInput.value = "";
      noteInput.value = "";
      renderQueue();
      renderSummary();

      alert("Order added to queue!");
    }

    // ------ WHATSAPP FUNCTIONALITY ------
    function formatBillForWhatsApp(order) {
      const restaurantName = "Your Restaurant";
      const date = new Date(order.createdAt);
      const formattedDate = date.toLocaleDateString();
      const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      let billText = `*${restaurantName}*\n`;
      billText += `Order ${order.displayId}\n`;
      billText += `Customer: ${order.customerName}\n`;
      billText += `Date: ${formattedDate} ${formattedTime}\n`;
      billText += `Status: ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}\n`;
      billText += `\n*Order Details:*\n`;
      billText += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
      
      order.items.forEach(item => {
        billText += `${item.qty} x ${item.name} = â‚¹${item.price * item.qty}\n`;
      });
      
      billText += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
      billText += `*Subtotal: â‚¹${order.total}*\n`;
      
      // Add note if exists
      if (order.note) {
        billText += `\n*Note:* ${order.note}\n`;
      }
      
      billText += `\nThank you for your order! ðŸ½ï¸\n`;
      billText += `Please show this bill when picking up.\n`;
      
      return billText;
    }

    function showWhatsAppModal(order) {
      currentOrderForWhatsApp = order;
      const billText = formatBillForWhatsApp(order);
      
      // Update bill preview
      document.getElementById('bill-preview').textContent = billText;
      
      // Pre-fill phone number if available
      const phoneInput = document.getElementById('phone-number');
      phoneInput.value = order.customerPhone || '';
      
      // Show modal
      document.getElementById('whatsapp-modal').classList.add('active');
    }

    function setupWhatsAppModal() {
      const modal = document.getElementById('whatsapp-modal');
      const closeBtn = document.getElementById('close-modal-btn');
      const copyBtn = document.getElementById('copy-bill-btn');
      const sendBtn = document.getElementById('send-whatsapp-btn');
      const phoneInput = document.getElementById('phone-number');

      // Close modal
      closeBtn.addEventListener('click', () => {
        modal.classList.remove('active');
      });

      // Close when clicking outside
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });

      // Copy bill text
      copyBtn.addEventListener('click', () => {
        if (!currentOrderForWhatsApp) return;
        
        const billText = formatBillForWhatsApp(currentOrderForWhatsApp);
        navigator.clipboard.writeText(billText).then(() => {
          const originalText = copyBtn.innerHTML;
          copyBtn.innerHTML = '<span class="btn-icon">âœ“</span> Copied!';
          setTimeout(() => {
            copyBtn.innerHTML = originalText;
          }, 2000);
        });
      });

      // Send via WhatsApp
      sendBtn.addEventListener('click', () => {
        if (!currentOrderForWhatsApp) return;
        
        const billText = formatBillForWhatsApp(currentOrderForWhatsApp);
        const phoneNumber = phoneInput.value.trim();
        
        if (!phoneNumber) {
          alert('Please enter a phone number to send via WhatsApp');
          return;
        }

        // Format phone number (remove any non-digit characters except +)
        const formattedPhone = phoneNumber.replace(/[^\d+]/g, '');
        
        // Create WhatsApp URL
        const encodedText = encodeURIComponent(billText);
        const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodedText}`;
        
        // Open WhatsApp in new tab
        window.open(whatsappUrl, '_blank');
        
        // Close modal
        modal.classList.remove('active');
      });
    }

    // ------ EXPORT FUNCTIONALITY ------
    function showExportModal() {
      // Set today's date as default end date
      const today = new Date().toISOString().split('T')[0];
      const startDateInput = document.getElementById('start-date');
      const endDateInput = document.getElementById('end-date');
      
      // Set defaults (last 7 days)
      const lastWeek = new Date();
      lastWeek.setDate(lastWeek.getDate() - 7);
      const lastWeekStr = lastWeek.toISOString().split('T')[0];
      
      startDateInput.value = lastWeekStr;
      endDateInput.value = today;
      
      // Clear status
      document.getElementById('export-status').textContent = '';
      
      // Show modal
      document.getElementById('export-modal').classList.add('active');
    }

    function setupExportModal() {
      const modal = document.getElementById('export-modal');
      const closeBtn = document.getElementById('close-export-modal-btn');
      const exportCsvOption = document.getElementById('export-csv-option');
      const exportExcelOption = document.getElementById('export-excel-option');
      const exportDetailsOption = document.getElementById('export-details-option');
      const exportBtn = document.getElementById('export-sales-btn');

      // Open export modal
      exportBtn.addEventListener('click', showExportModal);

      // Close modal
      closeBtn.addEventListener('click', () => {
        modal.classList.remove('active');
      });

      // Close when clicking outside
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });

      // Export as CSV
      exportCsvOption.addEventListener('click', () => {
        exportSalesData('csv');
      });

      // Export as Excel
      exportExcelOption.addEventListener('click', () => {
        exportSalesData('excel');
      });

      // Export detailed report
      exportDetailsOption.addEventListener('click', () => {
        exportSalesData('detailed');
      });
    }

    function filterOrdersByDate(startDate, endDate) {
      if (!startDate || !endDate) {
        return orders; // Return all orders if no date filter
      }

      const start = new Date(startDate);
      const end = new Date(endDate);
      end.setHours(23, 59, 59, 999); // Include entire end day

      return orders.filter(order => {
        const orderDate = new Date(order.createdAt);
        return orderDate >= start && orderDate <= end;
      });
    }

    function formatCurrency(amount) {
      return 'â‚¹' + amount.toFixed(2);
    }

    function exportSalesData(format) {
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      const statusEl = document.getElementById('export-status');

      // Validate dates if provided
      if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        if (start > end) {
          statusEl.textContent = 'Error: Start date cannot be after end date';
          statusEl.style.color = '#dc2626';
          return;
        }
      }

      const filteredOrders = filterOrdersByDate(startDate, endDate);
      
      if (filteredOrders.length === 0) {
        statusEl.textContent = 'No orders found for the selected date range';
        statusEl.style.color = '#dc2626';
        return;
      }

      statusEl.textContent = 'Preparing export...';
      statusEl.style.color = '#666';

      setTimeout(() => {
        try {
          if (format === 'csv') {
            exportToCSV(filteredOrders);
          } else if (format === 'excel') {
            exportToExcel(filteredOrders);
          } else if (format === 'detailed') {
            exportDetailedReport(filteredOrders);
          }
          
          statusEl.textContent = 'Export completed successfully!';
          statusEl.style.color = '#16a34a';
          
          // Auto-close modal after success
          setTimeout(() => {
            document.getElementById('export-modal').classList.remove('active');
            statusEl.textContent = '';
          }, 1500);
          
        } catch (error) {
          statusEl.textContent = 'Error during export: ' + error.message;
          statusEl.style.color = '#dc2626';
        }
      }, 500);
    }

    function exportToCSV(orders) {
      // Create CSV content
      const headers = ['Order ID', 'Customer Name', 'Phone', 'Date', 'Time', 'Status', 'Items Count', 'Total', 'Note'];
      const rows = orders.map(order => {
        const date = new Date(order.createdAt);
        const dateStr = date.toLocaleDateString();
        const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const itemsCount = order.items.reduce((sum, item) => sum + item.qty, 0);
        
        return [
          order.displayId,
          order.customerName,
          order.customerPhone || '',
          dateStr,
          timeStr,
          order.status.charAt(0).toUpperCase() + order.status.slice(1),
          itemsCount,
          formatCurrency(order.total),
          order.note || ''
        ];
      });

      // Create CSV string
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');

      // Create and download file
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const filename = `sales_export_${new Date().toISOString().split('T')[0]}.csv`;
      
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function exportToExcel(orders) {
      // For Excel export, we'll create a more complex CSV with better formatting
      const headers = ['Order ID', 'Customer', 'Phone', 'Date', 'Time', 'Status', 'Items', 'Quantity', 'Item Total', 'Order Total', 'Notes'];
      
      // Create rows with item-level details
      const rows = [];
      orders.forEach(order => {
        const date = new Date(order.createdAt);
        const dateStr = date.toLocaleDateString();
        const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        order.items.forEach((item, index) => {
          rows.push([
            order.displayId,
            index === 0 ? order.customerName : '', // Only show customer name on first row
            index === 0 ? (order.customerPhone || '') : '',
            index === 0 ? dateStr : '',
            index === 0 ? timeStr : '',
            index === 0 ? (order.status.charAt(0).toUpperCase() + order.status.slice(1)) : '',
            item.name,
            item.qty,
            formatCurrency(item.price * item.qty),
            index === 0 ? formatCurrency(order.total) : '', // Only show total on first row
            index === 0 ? (order.note || '') : ''
          ]);
        });
        
        // Add a separator row between orders
        rows.push(['', '', '', '', '', '', '', '', '', '', '']);
      });

      // Create CSV string
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');

      // Create and download file with .xls extension (can be opened in Excel)
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'application/vnd.ms-excel;charset=utf-8' });
      const link = document.createElement('a');
      const filename = `sales_export_${new Date().toISOString().split('T')[0]}.xls`;
      
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function exportDetailedReport(orders) {
      // Create a comprehensive report with summary
      const date = new Date();
      const exportDate = date.toLocaleDateString();
      const exportTime = date.toLocaleTimeString();
      
      let csvContent = `Restaurant Sales Report\n`;
      csvContent += `Export Date: ${exportDate} ${exportTime}\n`;
      csvContent += `Total Orders: ${orders.length}\n`;
      csvContent += `Total Sales: ${formatCurrency(orders.reduce((sum, o) => sum + o.total, 0))}\n\n`;
      
      // Summary section
      csvContent += `ORDER SUMMARY\n`;
      csvContent += 'Order ID,Customer,Date,Time,Status,Items Count,Total,Phone,Notes\n';
      
      orders.forEach(order => {
        const orderDate = new Date(order.createdAt);
        const itemsCount = order.items.reduce((sum, item) => sum + item.qty, 0);
        
        csvContent += `${order.displayId},"${order.customerName}",${orderDate.toLocaleDateString()},${orderDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })},${order.status.toUpperCase()},${itemsCount},${formatCurrency(order.total)},"${order.customerPhone || ''}","${order.note || ''}"\n`;
      });
      
      csvContent += `\n\nITEM DETAILS\n`;
      csvContent += 'Order ID,Item Name,Quantity,Price,Item Total\n';
      
      // Item details
      orders.forEach(order => {
        order.items.forEach(item => {
          csvContent += `${order.displayId},"${item.name}",${item.qty},${formatCurrency(item.price)},${formatCurrency(item.price * item.qty)}\n`;
        });
      });
      
      csvContent += `\n\nSALES BY ITEM\n`;
      csvContent += 'Item Name,Total Quantity Sold,Total Revenue\n';
      
      // Sales by item summary
      const itemSales = {};
      orders.forEach(order => {
        order.items.forEach(item => {
          if (!itemSales[item.name]) {
            itemSales[item.name] = { quantity: 0, revenue: 0 };
          }
          itemSales[item.name].quantity += item.qty;
          itemSales[item.name].revenue += item.qty * item.price;
        });
      });
      
      Object.entries(itemSales).forEach(([itemName, data]) => {
        csvContent += `"${itemName}",${data.quantity},${formatCurrency(data.revenue)}\n`;
      });

      // Create and download file
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const filename = `detailed_sales_report_${new Date().toISOString().split('T')[0]}.csv`;
      
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    // ------ QUEUE RENDER + STATUS ------
    function setStatusFilter(status) {
      currentStatusFilter = status;
      document.querySelectorAll(".filter-chip").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.status === status);
      });
      renderQueue();
    }

    function renderQueue() {
      const container = document.getElementById("queue-list");
      container.innerHTML = "";

      let filtered = orders;
      if (currentStatusFilter !== "all") {
        filtered = orders.filter(o => o.status === currentStatusFilter);
      }

      if (filtered.length === 0) {
        container.innerHTML = `<p class="small">No orders found for this filter.</p>`;
        return;
      }

      filtered
        .slice()
        .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))
        .forEach(order => {
          const card = document.createElement("div");
          card.className = "card";

          const statusChipClass =
            order.status === "preparing"
              ? "chip chip-preparing"
              : order.status === "ready"
              ? "chip chip-ready"
              : "chip chip-done";

          const statusLabel =
            order.status === "preparing"
              ? "Preparing"
              : order.status === "ready"
              ? "Ready"
              : "Completed";

          const time = new Date(order.createdAt);
          const timeStr = time.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

          card.innerHTML = `
            <div class="card-header">
              <div>
                <div class="card-title">${order.displayId} Â· ${order.customerName}</div>
                <div class="card-subtitle">${timeStr}</div>
              </div>
              <div class="${statusChipClass}">${statusLabel}</div>
            </div>
            <ul class="items-list">
              ${order.items
                .map(it => `<li>${it.qty} x ${it.name} (â‚¹${it.price})</li>`)
                .join("")}
            </ul>
            ${order.note ? `<div class="note">Note: ${order.note}</div>` : ""}
            <div class="total-row">Total: â‚¹${order.total}</div>
          `;

          const btnRow = document.createElement("div");
          btnRow.className = "btn-row";

          // Add WhatsApp button for all orders
          const whatsappBtn = document.createElement("button");
          whatsappBtn.className = "btn btn-whatsapp";
          whatsappBtn.innerHTML = '<span class="btn-icon">ðŸ’¬</span> Send Bill';
          whatsappBtn.onclick = () => showWhatsAppModal(order);
          btnRow.appendChild(whatsappBtn);

          if (order.status === "preparing") {
            const readyBtn = document.createElement("button");
            readyBtn.className = "btn btn-primary";
            readyBtn.textContent = "Mark Ready";
            readyBtn.onclick = () => updateOrderStatus(order.id, "ready");
            btnRow.appendChild(readyBtn);
          }

          if (order.status === "ready") {
            const doneBtn = document.createElement("button");
            doneBtn.className = "btn btn-primary";
            doneBtn.textContent = "Mark Picked Up";
            doneBtn.onclick = () => updateOrderStatus(order.id, "done");
            btnRow.appendChild(doneBtn);
          }

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "btn btn-secondary";
          deleteBtn.textContent = "Remove";
          deleteBtn.onclick = () => deleteOrder(order.id);
          btnRow.appendChild(deleteBtn);

          card.appendChild(btnRow);
          container.appendChild(card);
        });
    }

    function updateOrderStatus(id, status) {
      const order = orders.find(o => o.id === id);
      if (!order) return;
      order.status = status;
      saveOrders();
      renderQueue();
      renderSummary();
    }

    function deleteOrder(id) {
      if (!confirm("Remove this order from queue?")) return;
      orders = orders.filter(o => o.id !== id);
      saveOrders();
      renderQueue();
      renderSummary();
    }

    // ------ SUMMARY ------
    function renderSummary() {
      const totalOrdersEl = document.getElementById("summary-orders");
      const totalSalesEl = document.getElementById("summary-sales");
      const itemsListEl = document.getElementById("summary-items");

      if (orders.length === 0) {
        totalOrdersEl.textContent = "0";
        totalSalesEl.textContent = "â‚¹0";
        itemsListEl.innerHTML = `<li>No orders yet.</li>`;
        return;
      }

      const totalOrders = orders.length;
      const totalSales = orders.reduce((sum, o) => sum + (o.total || 0), 0);

      totalOrdersEl.textContent = totalOrders;
      totalSalesEl.textContent = "â‚¹" + totalSales;

      const itemCountMap = {};
      orders.forEach(order => {
        order.items.forEach(it => {
          if (!itemCountMap[it.name]) {
            itemCountMap[it.name] = 0;
          }
          itemCountMap[it.name] += it.qty;
        });
      });

      const sortedItems = Object.entries(itemCountMap)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6);

      itemsListEl.innerHTML = sortedItems
        .map(([name, qty]) => `<li>${name}: <span class="highlight">${qty}</span> orders</li>`)
        .join("");
    }

    function resetDay() {
      if (!confirm("Reset everything for today? This will clear ALL stored orders.")) return;
      orders = [];
      saveOrders();
      renderQueue();
      renderSummary();
      alert("All orders cleared for a new day.");
    }

    // ------ TABS ------
    function setupTabs() {
      const tabButtons = document.querySelectorAll(".tab-button");
      const sections = document.querySelectorAll(".section");

      tabButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.tab;

          tabButtons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");

          sections.forEach(sec => {
            sec.classList.toggle("active", sec.id === target);
          });
        });
      });
    }

    // ------ ACTIONS + FILTERS ------
    function setupActions() {
      document.getElementById("clear-cart-btn").addEventListener("click", clearCart);
      document.getElementById("save-order-btn").addEventListener("click", saveOrder);
      document.getElementById("reset-day-btn").addEventListener("click", resetDay);
      document.getElementById("export-sales-btn").addEventListener("click", showExportModal);

      document.querySelectorAll(".filter-chip").forEach(btn => {
        btn.addEventListener("click", () => {
          setStatusFilter(btn.dataset.status);
        });
      });
    }

    // Start app
    init();
  </script>
</body>
</html>
