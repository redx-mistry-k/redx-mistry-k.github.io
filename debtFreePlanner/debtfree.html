<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Debt-Free Date & EMI Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #93a1b3;
      --text: #e5e7eb;
      --accent: #22c55e;
      --accent2: #38bdf8;
      --danger: #ef4444;
      --mono: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono","Courier New",monospace;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px; color: var(--text);
      background: radial-gradient(1000px 600px at -10% -20%, rgba(56,189,248,0.08), transparent 40%),
                  radial-gradient(1000px 600px at 110% 120%, rgba(34,197,94,0.08), transparent 40%),
                  linear-gradient(180deg, #0b1220 0%, var(--bg) 100%);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
    }
    h1 { font-size: 1.35rem; margin: 0 0 10px; }
    h2 { font-size: 1.1rem; margin: 16px 0 8px; color: var(--muted); }
    .wrap { max-width: 1200px; margin: 0 auto; display: grid; gap: 16px; grid-template-columns: 1.05fr 1.35fr; }
    @media (max-width: 1024px) { .wrap { grid-template-columns: 1fr; } }
    .card { background: var(--panel); border: 1px solid rgba(148,163,184,0.18); border-radius: 14px; padding: 16px; }
    label { display: block; font-size: 0.87rem; color: var(--muted); margin-bottom: 6px; }
    input, select {
      width: 100%; padding: 10px 12px; border-radius: 10px; background: #0b1020;
      border: 1px solid rgba(148,163,184,0.22); color: var(--text); font-size: 0.95rem;
    }
    .grid { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
    .row { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 640px) { .grid, .row { grid-template-columns: 1fr; } }
    .hint { font-size: 0.8rem; color: var(--muted); }
    button {
      background: linear-gradient(135deg, var(--accent2), var(--accent)); color: #031420; border: none;
      padding: 11px 14px; border-radius: 10px; font-weight: 600; cursor: pointer;
    }
    button.secondary { background: #0b1020; color: var(--text); border: 1px solid rgba(148,163,184,0.25); }
    .badges { display: flex; gap: 8px; flex-wrap: wrap; }
    .badge { border: 1px solid rgba(148,163,184,0.25); color: var(--muted); border-radius: 999px; padding: 4px 8px; font-size: 0.78rem; background: #0b1020; }
    .results { display: grid; gap: 12px; grid-template-columns: repeat(3, 1fr); }
    @media (max-width: 900px) { .results { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 520px) { .results { grid-template-columns: 1fr; } }
    .stat { background: #0b1020; border: 1px solid rgba(148,163,184,0.15); border-radius: 12px; padding: 12px; }
    .stat h3 { margin: 0 0 6px; font-size: 0.9rem; color: var(--muted); }
    .val { font-family: var(--mono); font-size: 1.02rem; }
    .warn { color: var(--danger); font-size: 0.88rem; margin-top: 8px; }
    .hr { height: 1px; background: rgba(148,163,184,0.18); margin: 12px 0; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; overflow: hidden; border-radius: 10px; }
    th, td { border-bottom: 1px solid rgba(148,163,184,0.14); text-align: right; padding: 8px 10px; }
    th { color: var(--muted); background: #0a0f1d; }
    td:first-child, th:first-child { text-align: left; }
    .chart {
      width: 100%; height: 220px; background: #0b1020; border: 1px solid rgba(148,163,184,0.15);
      border-radius: 12px; position: relative; overflow: hidden;
    }
    .chart svg { width: 100%; height: 100%; display: block; }
    .legend { display: flex; gap: 10px; align-items: center; margin-top: 6px; color: var(--muted); font-size: 0.85rem; }
    .dot { width: 12px; height: 12px; border-radius: 3px; display: inline-block; }
    .dot.base { background: var(--accent2); }
    .dot.prep { background: var(--accent); }
    .btns { display:flex; gap:8px; flex-wrap: wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Debt‑Free Planner (EMI, Prepayment, Savings)</h1>
      <div class="grid">
        <div>
          <label for="balance">Current outstanding balance (₹)</label>
          <input id="balance" type="number" min="0" step="0.01" placeholder="e.g., 1000000" />
        </div>
        <div>
          <label for="rate">Annual interest rate (%)</label>
          <input id="rate" type="number" min="0" step="0.0001" placeholder="e.g., 11.5" />
        </div>
        <div>
          <label for="emi">Current monthly EMI (₹)</label>
          <input id="emi" type="number" min="0" step="0.01" placeholder="e.g., 15000" />
        </div>
        <div>
          <label for="start">Start date</label>
          <input id="start" type="date" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <div>
          <label for="income">Monthly income (₹)</label>
          <input id="income" type="number" min="0" step="0.01" placeholder="e.g., 80000" />
        </div>
        <div>
          <label for="expenses">Monthly expenses (₹)</label>
          <input id="expenses" type="number" min="0" step="0.01" placeholder="e.g., 35000" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <div>
          <label for="prepayLump">One‑time prepayment (₹)</label>
          <input id="prepayLump" type="number" min="0" step="0.01" placeholder="e.g., 200000" />
        </div>
        <div>
          <label for="prepayMonth">Apply one‑time at month #</label>
          <input id="prepayMonth" type="number" min="1" step="1" placeholder="e.g., 12" />
        </div>
        <div>
          <label for="extraMonthly">Additional monthly prepayment (₹)</label>
          <input id="extraMonthly" type="number" min="0" step="0.01" placeholder="e.g., 2000" />
        </div>
        <div>
          <label for="extraStart">Extra monthly begins at month #</label>
          <input id="extraStart" type="number" min="1" step="1" placeholder="e.g., 1" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label for="mode">After prepayment, adjust</label>
          <select id="mode">
            <option value="tenure">Reduce tenure (keep EMI)</option>
            <option value="emi">Reduce EMI (keep base payoff date)</option>
          </select>
        </div>
        <div class="hint">
          Prepayment is applied at the start of the specified month; “Reduce EMI” targets the base case payoff date for a fair comparison. 
        </div>
      </div>

      <div class="btns" style="margin-top:12px;">
        <button id="calcBtn">Calculate</button>
        <button id="resetBtn" class="secondary">Reset</button>
        <button id="csvBase" class="secondary">Download Base CSV</button>
        <button id="csvPre" class="secondary">Download Prepay CSV</button>
      </div>

      <div id="msg" class="warn"></div>
    </div>

    <div class="card">
      <div class="badges" id="badges"></div>

      <h2>Base (no prepayment)</h2>
      <div class="results" id="baseStats"></div>

      <h2>With prepayment</h2>
      <div class="results" id="preStats"></div>

      <div class="hr"></div>

      <h2>Comparison chart</h2>
      <div class="chart" id="lineChart"></div>
      <div class="legend"><span class="dot base"></span> Base &nbsp;&nbsp; <span class="dot prep"></span> With prepayment</div>

      <div class="hr"></div>

      <details>
        <summary style="color:var(--muted); cursor:pointer;">Show first 24 rows (base)</summary>
        <div style="overflow:auto;"><table id="baseTable"></table></div>
      </details>

      <details>
        <summary style="color:var(--muted); cursor:pointer;">Show first 24 rows (prepayment)</summary>
        <div style="overflow:auto;"><table id="preTable"></table></div>
      </details>
    </div>
  </div>

  <script>
    // Formatting helpers
    const Rs0 = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 });
    const Rs2 = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 2 });
    const pct = (x) => (x * 100).toFixed(2) + '%';
    const el = (id) => document.getElementById(id);
    const fmtDate = (d) => d.toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' });

    // Math helpers
    const mRate = (annualPct) => (annualPct || 0) / 12 / 100;
    function emiFor(P, annualPct, n) {
      const r = mRate(annualPct);
      if (n <= 0) return 0;
      if (r === 0) return P / n;
      const pow = Math.pow(1 + r, n);
      return P * r * pow / (pow - 1);
    }
    function addMonths(d, m) {
      const x = new Date(d.getTime());
      const day = x.getDate();
      x.setMonth(x.getMonth() + m);
      if (x.getDate() < day) x.setDate(0);
      return x;
    }

    // Core amortization builder (fixed base payment + optional extraMonthly)
    function buildScheduleFixed({ startBalance, annualPct, startDate, basePayment, extraMonthly=0, extraStartMonth=1, maxMonths=3600, prepayEvents={} }) {
      const r = mRate(annualPct);
      const rows = [];
      let bal = startBalance;
      let totalInt = 0, totalPaid = 0;
      let month = 1;
      let negAmCounter = 0;

      while (bal > 0 && month <= maxMonths) {
        // Prepayment at start of this month (if any)
        const preAmt = prepayEvents[month] || 0;
        if (preAmt > 0) {
          bal = Math.max(0, bal - preAmt);
          totalPaid += preAmt; // one-time cash outflow
          if (bal <= 0) {
            // record a zero-payment closure row
            rows.push({ period: month, date: addMonths(startDate, month-1), payment: 0, interest: 0, principal: 0, balance: 0, prepay: preAmt });
            break;
          }
        }

        const dt = addMonths(startDate, month-1);
        const interest = bal * r;
        const extra = month >= extraStartMonth ? extraMonthly : 0;
        const payThisMonth = basePayment + extra;
        let principal = payThisMonth - interest;

        if (principal <= 0) {
          // negative amortization guard
          negAmCounter++;
          principal = 0;
        } else {
          negAmCounter = 0;
        }

        // If last payment would overshoot principal, trim payment
        if (principal > bal) {
          const over = principal - bal;
          // reduce payment by 'over'
          const actualPay = payThisMonth - over;
          principal = bal;
          rows.push({ period: month, date: dt, payment: actualPay, interest, principal, balance: 0, prepay: preAmt });
          totalInt += interest;
          totalPaid += actualPay;
          bal = 0;
          break;
        } else {
          const newBal = bal - principal;
          rows.push({ period: month, date: dt, payment: payThisMonth, interest, principal, balance: newBal, prepay: preAmt });
          totalInt += interest;
          totalPaid += payThisMonth;
          bal = newBal;
        }

        if (negAmCounter >= 12) {
          // likely will never amortize with given cash flow
          return { rows, totalInterest: totalInt, totalPaid, months: rows.length, payoffDate: rows[rows.length-1].date, negativeAmortization: true };
        }

        month++;
      }

      const payoffDate = rows.length ? rows[rows.length-1].date : startDate;
      return { rows, totalInterest: totalInt, totalPaid, months: rows.length, payoffDate, negativeAmortization: false };
    }

    // Build base (uses current EMI) and prepay scenario (lump + recurring)
    function computeAll(inputs) {
      const { balance, annualPct, emi, startDate, prepayLump, prepayMonth, extraMonthly, extraStart, mode } = inputs;

      // Base schedule (no prepayment, no extra)
      const base = buildScheduleFixed({
        startBalance: balance, annualPct, startDate, basePayment: emi
      });

      // If base is non-amortizing, no need to simulate prepay further
      if (base.negativeAmortization) return { base, withPrepay: null };

      // Prepare prepayment events
      const prepayEvents = {};
      if (prepayLump > 0 && prepayMonth > 0) prepayEvents[prepayMonth] = prepayLump;

      // Determine revised basePayment after the first prepayment event if mode = 'emi'
      // We target the base payoff date: monthsLeft = base.months - (prepayMonth-1)
      let basePaymentPre = emi;
      let extraStartMonth = extraStart || 1;

      if ((prepayLump > 0 && prepayMonth > 0) && mode === 'emi') {
        // Simulate up to month-1 to get balance just before prepayment month
        const upTo = buildScheduleFixed({
          startBalance: balance, annualPct, startDate, basePayment: emi, maxMonths: Math.max(1, prepayMonth-1)
        });
        const balBefore = upTo.rows.length ? upTo.rows[upTo.rows.length-1].balance : balance;
        const newBal = Math.max(0, balBefore - prepayLump);
        const monthsLeft = Math.max(1, base.months - (prepayMonth-1));
        basePaymentPre = newBal > 0 ? emiFor(newBal, annualPct, monthsLeft) : 0;
      }

      // Build full prepayment scenario
      const pre = buildScheduleFixed({
        startBalance: balance,
        annualPct,
        startDate,
        basePayment: emi, // start with current EMI
        extraMonthly: 0,  // extra handled after prepayment month if tenure mode, or from extraStart if provided
        prepayEvents
      });

      // If negative (shouldn't happen if base ok), return
      if (pre.negativeAmortization) return { base, withPrepay: pre };

      // Now continue after prepayment month with appropriate payment and extra
      // Strategy: rebuild in two segments to handle payment change and recurring extra
      // Segment A: before change point n0 (min of prepayMonth or extraStart) - already covered above to prepay month if any
      // For simplicity, we will rebuild entire "withPrepay" in one pass using dynamic basePayment:
      function buildWithPrepayDynamic() {
        const rows = [];
        let bal = balance;
        let totalInt = 0, totalPaid = 0;
        const r = mRate(annualPct);
        let negAmCounter = 0;
        let month = 1;
        let currentBasePayment = emi;

        while (bal > 0 && month <= 3600) {
          // Apply one-time prepayment at start
          let preAmt = 0;
          if (prepayLump > 0 && prepayMonth === month) {
            preAmt = prepayLump;
            bal = Math.max(0, bal - preAmt);
            totalPaid += preAmt;
            // After prepayment, adjust base payment if mode = 'emi'
            if (mode === 'emi' && bal > 0) {
              const monthsLeft = Math.max(1, base.months - (month-1));
              currentBasePayment = emiFor(bal, annualPct, monthsLeft);
            }
          }

          if (bal <= 0) {
            rows.push({ period: month, date: addMonths(startDate, month-1), payment: 0, interest: 0, principal: 0, balance: 0, prepay: preAmt });
            break;
          }

          const dt = addMonths(startDate, month-1);
          const extra = (extraMonthly > 0 && month >= (extraStart || 1)) ? extraMonthly : 0;
          // In tenure mode, keep EMI same and extra adds to prepayment each month; in emi mode, EMI may have been reduced, but extra still speeds payoff.
          const payThisMonth = currentBasePayment + extra;
          const interest = bal * r;
          let principal = payThisMonth - interest;

          if (principal <= 0) {
            negAmCounter++;
            principal = 0;
          } else {
            negAmCounter = 0;
          }

          if (principal > bal) {
            const over = principal - bal;
            const actualPay = payThisMonth - over;
            rows.push({ period: month, date: dt, payment: actualPay, interest, principal: bal, balance: 0, prepay: preAmt });
            totalInt += interest;
            totalPaid += actualPay;
            bal = 0;
            break;
          } else {
            const newBal = bal - principal;
            rows.push({ period: month, date: dt, payment: payThisMonth, interest, principal, balance: newBal, prepay: preAmt });
            totalInt += interest;
            totalPaid += payThisMonth;
            bal = newBal;
          }

          if (negAmCounter >= 12) {
            return { rows, totalInterest: totalInt, totalPaid, months: rows.length, payoffDate: rows[rows.length-1].date, negativeAmortization: true };
          }

          month++;
        }
        const payoffDate = rows.length ? rows[rows.length-1].date : startDate;
        return { rows, totalInterest: totalInt, totalPaid, months: rows.length, payoffDate, negativeAmortization: false };
      }

      const withPrepay = buildWithPrepayDynamic();
      return { base, withPrepay };
    }

    // Savings: sum over months of (income - expenses - payment) and also subtract any one-time prepay in that month.
    function computeSavings(rows, income, expenses) {
      let s = 0;
      const m = income - expenses;
      for (const r of rows) {
        s += (m - r.payment);
        if (r.prepay && r.prepay > 0) s -= r.prepay;
      }
      return s;
    }

    // Renderers
    function renderStats(container, sched, income, expenses, extras={}) {
      container.innerHTML = '';
      if (!sched) return;
      const savings = computeSavings(sched.rows, income, expenses);
      const items = [
        { k: 'Months to payoff', v: String(sched.months) },
        { k: 'Debt‑free date', v: fmtDate(sched.payoffDate) },
        { k: 'Total interest', v: Rs0.format(Math.round(sched.totalInterest)) },
        { k: 'Total paid', v: Rs0.format(Math.round(sched.totalPaid)) },
        { k: 'Savings by payoff', v: Rs0.format(Math.round(savings)) }
      ];
      if (extras.interestSaved != null) items.push({ k:'Interest saved vs base', v: Rs0.format(Math.round(extras.interestSaved)) });
      if (extras.monthsSaved != null) items.push({ k:'Months saved vs base', v: String(extras.monthsSaved) });

      for (const it of items) {
        const div = document.createElement('div');
        div.className = 'stat';
        div.innerHTML = `<h3>${it.k}</h3><div class="val">${it.v}</div>`;
        container.appendChild(div);
      }
    }

    function renderTable(container, sched, limit=24) {
      container.innerHTML = '';
      if (!sched) return;
      const rows = sched.rows.slice(0, limit);
      const th = `
        <tr>
          <th>#</th>
          <th>Date</th>
          <th>Payment (₹)</th>
          <th>Interest (₹)</th>
          <th>Principal (₹)</th>
          <th>Prepay (₹)</th>
          <th>Balance (₹)</th>
        </tr>`;
      const trs = rows.map(r => `
        <tr>
          <td>${r.period}</td>
          <td>${fmtDate(r.date)}</td>
          <td>${Rs0.format(Math.round(r.payment))}</td>
          <td>${Rs0.format(Math.round(r.interest))}</td>
          <td>${Rs0.format(Math.round(r.principal))}</td>
          <td>${r.prepay ? Rs0.format(Math.round(r.prepay)) : '-'}</td>
          <td>${Rs0.format(Math.round(r.balance))}</td>
        </tr>`).join('');
      container.innerHTML = th + trs;
    }

    function toCSV(sched) {
      const header = ['Period','Date','Payment','Interest','Principal','Prepay','Balance'];
      const lines = [header.join(',')];
      for (const r of sched.rows) {
        lines.push([
          r.period,
          fmtDate(r.date),
          r.payment.toFixed(2),
          r.interest.toFixed(2),
          r.principal.toFixed(2),
          (r.prepay || 0).toFixed(2),
          r.balance.toFixed(2)
        ].join(','));
      }
      return lines.join('\n');
    }

    // Simple inline SVG line chart for balances (base vs prepay)
    function renderLineChart(container, baseSched, preSched) {
      container.innerHTML = '';
      const w = container.clientWidth || 600;
      const h = container.clientHeight || 220;
      const padL = 40, padR = 12, padT = 12, padB = 24;

      function balances(s) { return s ? [0, ...s.rows.map(r => r.balance)] : []; } // include t0
      const b1 = balances(baseSched);
      const b2 = balances(preSched);
      const maxLen = Math.max(b1.length, b2.length, 2);
      const maxBal = Math.max(b1[0] || 0, b2[0] || 0, ...(b1||[]), ...(b2||[]), 1);

      function scaleX(i) {
        const x0 = padL, x1 = w - padR;
        return x0 + (i / (maxLen - 1)) * (x1 - x0);
      }
      function scaleY(v) {
        const y0 = padT, y1 = h - padB;
        return y1 - (v / maxBal) * (y1 - y0);
      }
      function pathFrom(arr) {
        if (!arr || arr.length === 0) return '';
        let d = `M ${scaleX(0)} ${scaleY(arr[0])}`;
        for (let i=1;i<arr.length;i++) d += ` L ${scaleX(i)} ${scaleY(arr[i])}`;
        return d;
      }

      const svgNS = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('width', w);
      svg.setAttribute('height', h);

      // Axes
      const axis = document.createElementNS(svgNS, 'g');
      const xLine = document.createElementNS(svgNS, 'line');
      xLine.setAttribute('x1', padL); xLine.setAttribute('y1', h - padB);
      xLine.setAttribute('x2', w - padR); xLine.setAttribute('y2', h - padB);
      xLine.setAttribute('stroke', 'rgba(148,163,184,0.4)');
      axis.appendChild(xLine);
      const yLine = document.createElementNS(svgNS, 'line');
      yLine.setAttribute('x1', padL); yLine.setAttribute('y1', padT);
      yLine.setAttribute('x2', padL); yLine.setAttribute('y2', h - padB);
      yLine.setAttribute('stroke', 'rgba(148,163,184,0.4)');
      axis.appendChild(yLine);

      // Gridlines and labels
      for (let i=0;i<=4;i++) {
        const yVal = (maxBal * i) / 4;
        const yy = scaleY(yVal);
        const gl = document.createElementNS(svgNS, 'line');
        gl.setAttribute('x1', padL);
        gl.setAttribute('y1', yy);
        gl.setAttribute('x2', w - padR);
        gl.setAttribute('y2', yy);
        gl.setAttribute('stroke', 'rgba(148,163,184,0.12)');
        axis.appendChild(gl);

        const txt = document.createElementNS(svgNS, 'text');
        txt.setAttribute('x', 4);
        txt.setAttribute('y', yy + 4);
        txt.setAttribute('fill', 'rgba(148,163,184,0.8)');
        txt.setAttribute('font-size', '10');
        txt.textContent = Rs0.format(Math.round(yVal));
        svg.appendChild(txt);
      }

      // Paths
      const p1 = document.createElementNS(svgNS, 'path');
      p1.setAttribute('d', pathFrom(b1));
      p1.setAttribute('fill', 'none');
      p1.setAttribute('stroke', '#38bdf8');
      p1.setAttribute('stroke-width', '2.2');
      svg.appendChild(p1);

      if (preSched) {
        const p2 = document.createElementNS(svgNS, 'path');
        p2.setAttribute('d', pathFrom(b2));
        p2.setAttribute('fill', 'none');
        p2.setAttribute('stroke', '#22c55e');
        p2.setAttribute('stroke-width', '2.2');
        svg.appendChild(p2);
      }

      svg.appendChild(axis);
      container.appendChild(svg);
    }

    function setToday() {
      const t = new Date();
      const yyyy = t.getFullYear();
      const mm = String(t.getMonth()+1).padStart(2, '0');
      const dd = String(t.getDate()).padStart(2, '0');
      el('start').value = `${yyyy}-${mm}-${dd}`;
    }

    function resetAll() {
      ['balance','rate','emi','income','expenses','prepayLump','prepayMonth','extraMonthly','extraStart'].forEach(id => el(id).value = '');
      el('mode').value = 'tenure';
      el('badges').innerHTML = '';
      el('baseStats').innerHTML = '';
      el('preStats').innerHTML = '';
      el('baseTable').innerHTML = '';
      el('preTable').innerHTML = '';
      el('lineChart').innerHTML = '';
      el('msg').textContent = '';
      setToday();
    }

    function calc() {
      const balance = Number(el('balance').value);
      const rate = Number(el('rate').value);
      const payment = Number(el('emi').value);
      const income = Number(el('income').value || 0);
      const expenses = Number(el('expenses').value || 0);
      const prepayLump = Number(el('prepayLump').value || 0);
      const prepayMonth = Number(el('prepayMonth').value || 0);
      const extraMonthly = Number(el('extraMonthly').value || 0);
      const extraStart = Number(el('extraStart').value || 0);
      const mode = el('mode').value;
      const startVal = el('start').value;
      const startDate = startVal ? new Date(startVal + 'T00:00:00') : new Date();

      const msg = el('msg');
      msg.textContent = '';

      if (!(balance > 0) || !(rate >= 0) || !(payment > 0)) {
        msg.textContent = 'Enter a valid outstanding balance (>0), annual interest (≥0), and current monthly EMI (>0).';
        return;
      }
      if (income && expenses && (income - expenses) <= 0) {
        msg.textContent = 'Warning: income − expenses ≤ 0, savings will be non‑positive.';
      }

      const { base, withPrepay } = computeAll({
        balance, annualPct: rate, emi: payment, startDate,
        prepayLump, prepayMonth, extraMonthly, extraStart, mode
      });

      // badges
      el('badges').innerHTML =
        `<span class="badge">Monthly rate: ${pct(mRate(rate))}</span>` +
        `<span class="badge">EMI: ${Rs0.format(Math.round(payment))}</span>` +
        `<span class="badge">Income: ${Rs0.format(Math.round(income))}</span>` +
        `<span class="badge">Expenses: ${Rs0.format(Math.round(expenses))}</span>`;

      // base negative amortization?
      if (base.negativeAmortization) {
        msg.textContent = 'Given EMI does not cover monthly interest for multiple months; loan would not amortize without higher payments or prepayment.';
      }

      // render base
      renderStats(el('baseStats'), base, income, expenses);
      renderTable(el('baseTable'), base, 24);

      // render prepay
      if (withPrepay && !withPrepay.negativeAmortization) {
        const interestSaved = Math.max(0, base.totalInterest - withPrepay.totalInterest);
        const monthsSaved = Math.max(0, base.months - withPrepay.months);
        renderStats(el('preStats'), withPrepay, income, expenses, { interestSaved, monthsSaved });
        renderTable(el('preTable'), withPrepay, 24);
        renderLineChart(el('lineChart'), base, withPrepay);
      } else {
        el('preStats').innerHTML = '<div class="stat"><h3>Info</h3><div class="val">No valid prepayment scenario.</div></div>';
        el('preTable').innerHTML = '';
        renderLineChart(el('lineChart'), base, null);
      }

      // CSV buttons
      el('csvBase').onclick = () => {
        const blob = new Blob([toCSV(base)], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'amortization_base.csv'; a.click();
        URL.revokeObjectURL(url);
      };
      el('csvPre').onclick = () => {
        if (!withPrepay || withPrepay.negativeAmortization) return;
        const blob = new Blob([toCSV(withPrepay)], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'amortization_prepay.csv'; a.click();
        URL.revokeObjectURL(url);
      };
    }

    el('calcBtn').addEventListener('click', calc);
    el('resetBtn').addEventListener('click', resetAll);
    setToday();
  </script>
</body>
</html>
