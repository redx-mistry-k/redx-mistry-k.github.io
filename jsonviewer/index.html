<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>JSON Column Viewer</title>

    <!-- Bootstrap CSS CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      thead th {
        position: sticky;
        top: 0;
        background: #f8f9fa;
        z-index: 1;
      }

      .columns {
        max-height: 260px;
        overflow-y: auto;
      }

      .columns label {
        font-size: 0.85rem;
        white-space: nowrap;
      }
    </style>
  </head>

  <body class="bg-light">
    <!-- Navbar -->
    <nav class="navbar navbar-light bg-white border-bottom">
      <div class="container">
        <span class="navbar-brand mb-0 h6">JSON Viewer</span>

        <a
          href="https://krishnaanalytics.tech/jsonAdder/v2"
          target="_blank"
          class="btn btn-outline-secondary btn-sm"
        >
          Open JSON Adder
        </a>
      </div>
    </nav>

    <div class="container my-4">
      <!-- JSON Input -->
      <div class="card mb-3">
        <div class="card-body">
          <textarea
            id="jsonInput"
            class="form-control"
            rows="8"
            placeholder="Paste JSON array here"
          ></textarea>

          <div class="mt-3 d-flex flex-wrap gap-2">
            <button class="btn btn-primary btn-sm" onclick="loadColumns()">
              Load Columns
            </button>
            <button
              class="btn btn-outline-secondary btn-sm"
              onclick="uncheckAll()"
            >
              Uncheck All
            </button>
            <button
              class="btn btn-outline-secondary btn-sm"
              onclick="checkAll()"
            >
              Check All
            </button>
            <button class="btn btn-success btn-sm" onclick="renderTable()">
              Render Table
            </button>
          </div>

          <div id="error" class="text-danger small mt-2"></div>
        </div>
      </div>

      <!-- Column Selector -->
      <div class="card mb-3 d-none" id="columnCard">
        <div class="card-body">
          <h6 class="mb-2">Select Columns</h6>
          <div
            id="columnContainer"
            class="columns row row-cols-1 row-cols-md-2 row-cols-lg-3 g-2"
          ></div>
        </div>
      </div>

      <!-- Table -->
      <div class="card">
        <div class="card-body p-0">
          <div class="table-responsive">
            <div id="tableContainer"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let jsonData = [];
      let jsonKey = "";

      function getJsonKey(data) {
        return (
          "json_columns_" +
          btoa(JSON.stringify(Object.keys(data[0]))).slice(0, 50)
        );
      }

      function loadColumns() {
        document.getElementById("error").textContent = "";
        document.getElementById("tableContainer").innerHTML = "";

        try {
          const input = document.getElementById("jsonInput").value.trim();
          const parsed = JSON.parse(input);

          if (!Array.isArray(parsed) || parsed.length === 0) {
            throw new Error("JSON must be a non-empty array");
          }

          jsonData = parsed;
          jsonKey = getJsonKey(parsed);

          const columns = Object.keys(parsed[0]);
          const saved = JSON.parse(localStorage.getItem(jsonKey) || "[]");

          const container = document.getElementById("columnContainer");
          container.innerHTML = "";

          columns.forEach((col) => {
            const checked = saved.length ? saved.includes(col) : true;

            const div = document.createElement("div");
            div.className = "col";

            div.innerHTML = `
          <label class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              value="${col}"
              ${checked ? "checked" : ""}
            >
            <span class="form-check-label">${col}</span>
          </label>
        `;

            container.appendChild(div);
          });

          document.getElementById("columnCard").classList.remove("d-none");
        } catch (err) {
          document.getElementById("error").textContent = err.message;
        }
      }

      function uncheckAll() {
        document
          .querySelectorAll("#columnContainer input")
          .forEach((cb) => (cb.checked = false));
      }

      function checkAll() {
        document
          .querySelectorAll("#columnContainer input")
          .forEach((cb) => (cb.checked = true));
      }

      function renderTable() {
        const selectedCols = Array.from(
          document.querySelectorAll("#columnContainer input:checked")
        ).map((cb) => cb.value);

        if (selectedCols.length === 0) return;

        localStorage.setItem(jsonKey, JSON.stringify(selectedCols));

        let html = `<table class="table table-sm table-bordered mb-0">
                  <thead><tr>`;

        selectedCols.forEach((col) => (html += `<th>${col}</th>`));
        html += "</tr></thead><tbody>";

        jsonData.forEach((row) => {
          html += "<tr>";
          selectedCols.forEach((col) => {
            let val = row[col];
            if (val === null || val === undefined) val = "";
            html += `<td>${val}</td>`;
          });
          html += "</tr>";
        });

        html += "</tbody></table>";

        document.getElementById("tableContainer").innerHTML = html;
      }
    </script>
  </body>
</html>
