<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>JSON Superviewer</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
:root {
  --bg: #f5f3ef;
  --bg-card: #ffffff;
  --bg-input: #fafaf8;
  --bg-hover: #f0eee9;
  --bg-header: #1a1a1a;
  --text: #1a1a1a;
  --text-muted: #6b6560;
  --text-header: #ffffff;
  --border: #e0ddd7;
  --border-focus: #b8a990;
  --accent: #c45d3e;
  --accent-hover: #a84e34;
  --accent-light: rgba(196,93,62,0.08);
  --success: #3a7d5c;
  --success-light: rgba(58,125,92,0.08);
  --warning: #c49a3e;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.08);
  --radius: 10px;
  --radius-sm: 6px;
  --mono: 'JetBrains Mono', monospace;
  --sans: 'DM Sans', sans-serif;
  --json-string: #c45d3e;
  --json-number: #3a7d5c;
  --json-bool: #7c5cbf;
  --json-null: #888;
  --json-key: #2a6496;
  --json-bracket: #666;
  --row-stripe: rgba(0,0,0,0.015);
  --scrollbar-thumb: #ccc;
  --scrollbar-track: transparent;
}

[data-theme="dark"] {
  --bg: #131316;
  --bg-card: #1c1c21;
  --bg-input: #22222a;
  --bg-hover: #28282f;
  --bg-header: #0f0f12;
  --text: #e4e2de;
  --text-muted: #8a8780;
  --text-header: #e4e2de;
  --border: #2e2e35;
  --border-focus: #5a5a65;
  --accent: #e07050;
  --accent-hover: #c45d3e;
  --accent-light: rgba(224,112,80,0.1);
  --success: #5cb88a;
  --success-light: rgba(92,184,138,0.1);
  --warning: #e0b84e;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.4);
  --json-string: #e07050;
  --json-number: #5cb88a;
  --json-bool: #a98ade;
  --json-null: #666;
  --json-key: #6aafe6;
  --json-bracket: #888;
  --row-stripe: rgba(255,255,255,0.015);
  --scrollbar-thumb: #444;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--sans);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  transition: background 0.3s, color 0.3s;
}

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--scrollbar-track); }
::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 10px; }

.header {
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}

.header-left { display: flex; align-items: center; gap: 12px; }

.logo {
  font-family: var(--mono);
  font-weight: 700;
  font-size: 1.1rem;
  letter-spacing: -0.5px;
  color: var(--accent);
}
.logo span { color: var(--text-muted); font-weight: 400; }

.header-right { display: flex; align-items: center; gap: 8px; }

.badge {
  font-size: 0.7rem;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 20px;
  background: var(--accent-light);
  color: var(--accent);
  font-family: var(--mono);
}

.btn {
  font-family: var(--sans);
  font-size: 0.8rem;
  font-weight: 600;
  padding: 7px 14px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--text);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: all 0.15s;
  white-space: nowrap;
}
.btn:hover { background: var(--bg-hover); border-color: var(--border-focus); }
.btn:active { transform: scale(0.97); }
.btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
.btn-primary:hover { background: var(--accent-hover); border-color: var(--accent-hover); }
.btn-success { background: var(--success); color: #fff; border-color: var(--success); }
.btn-success:hover { opacity: 0.9; }
.btn-warn { background: var(--warning); color: #fff; border-color: var(--warning); }
.btn-warn:hover { opacity: 0.9; }
.btn-icon {
  width: 34px; height: 34px; padding: 0;
  display: flex; align-items: center; justify-content: center;
  border-radius: var(--radius-sm);
}
.btn-icon i { font-size: 0.9rem; }

.main { display: flex; height: calc(100vh - 56px); }

.panel-left {
  width: 420px; min-width: 320px;
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  background: var(--bg-card);
  transition: width 0.2s;
}
.panel-left.collapsed { width: 0; min-width: 0; overflow: hidden; border-right: none; }

.panel-right { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }

.resizer {
  width: 4px; cursor: col-resize; background: transparent;
  transition: background 0.2s; flex-shrink: 0;
}
.resizer:hover, .resizer.active { background: var(--accent); }

.input-section { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

.input-toolbar {
  padding: 10px 14px; display: flex; flex-wrap: wrap; gap: 6px;
  border-bottom: 1px solid var(--border); background: var(--bg);
}

.input-area { flex: 1; position: relative; overflow: hidden; }

#jsonInput {
  width: 100%; height: 100%; border: none; outline: none; resize: none;
  padding: 14px; font-family: var(--mono); font-size: 0.82rem;
  line-height: 1.6; background: var(--bg-input); color: var(--text); tab-size: 2;
}
#jsonInput::placeholder { color: var(--text-muted); opacity: 0.6; }

.drop-zone {
  position: absolute; inset: 0; background: var(--accent-light);
  border: 2px dashed var(--accent); border-radius: var(--radius);
  display: none; align-items: center; justify-content: center;
  z-index: 10; pointer-events: none;
}
.drop-zone.active { display: flex; }
.drop-zone-text { font-weight: 600; color: var(--accent); font-size: 0.9rem; }

.status-bar {
  padding: 6px 14px; font-size: 0.72rem; font-family: var(--mono);
  color: var(--text-muted); border-top: 1px solid var(--border);
  display: flex; justify-content: space-between; background: var(--bg);
}
.status-valid { color: var(--success); }
.status-invalid { color: var(--accent); }

.table-toolbar {
  padding: 10px 16px; display: flex; align-items: center; gap: 8px;
  border-bottom: 1px solid var(--border); background: var(--bg-card); flex-wrap: wrap;
}

.search-box {
  font-family: var(--sans); font-size: 0.8rem; padding: 7px 12px 7px 32px;
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  background: var(--bg-input); color: var(--text); outline: none;
  width: 220px; transition: border-color 0.2s;
}
.search-box:focus { border-color: var(--accent); }

.search-wrapper { position: relative; }
.search-wrapper i {
  position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
  font-size: 0.75rem; color: var(--text-muted);
}

.table-info {
  font-size: 0.75rem; color: var(--text-muted);
  font-family: var(--mono); margin-left: auto;
}

.col-picker-wrap { position: relative; }

.col-picker-dropdown {
  position: absolute; top: calc(100% + 6px); right: 0;
  width: 280px; max-height: 360px; overflow-y: auto;
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius); box-shadow: var(--shadow-lg);
  z-index: 50; display: none; padding: 8px;
}
.col-picker-dropdown.open { display: block; }
.col-picker-dropdown label {
  display: flex; align-items: center; gap: 8px;
  padding: 5px 8px; font-size: 0.8rem; border-radius: var(--radius-sm);
  cursor: pointer; font-family: var(--mono); transition: background 0.15s;
}
.col-picker-dropdown label:hover { background: var(--bg-hover); }
.col-picker-actions {
  display: flex; gap: 6px; padding: 6px 8px;
  border-bottom: 1px solid var(--border); margin-bottom: 4px;
}

.table-scroll { flex: 1; overflow: auto; position: relative; }

table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
thead { position: sticky; top: 0; z-index: 10; }

thead th {
  background: var(--bg-header); color: var(--text-header);
  font-weight: 600; font-size: 0.72rem; text-transform: uppercase;
  letter-spacing: 0.5px; padding: 10px 14px;
  border-bottom: 2px solid var(--border); text-align: left;
  white-space: nowrap; cursor: pointer; user-select: none;
  position: relative; font-family: var(--mono);
}
thead th:hover { background: #2a2a2a; }
[data-theme="dark"] thead th:hover { background: #1a1a22; }
thead th .sort-icon { margin-left: 6px; opacity: 0.3; font-size: 0.65rem; }
thead th.sorted-asc .sort-icon,
thead th.sorted-desc .sort-icon { opacity: 1; color: var(--accent); }

th .col-filter {
  display: block; margin-top: 6px; width: 100%;
  font-family: var(--mono); font-size: 0.7rem; padding: 3px 6px;
  border: 1px solid rgba(255,255,255,0.15); border-radius: 3px;
  background: rgba(255,255,255,0.08); color: var(--text-header); outline: none;
}
th .col-filter::placeholder { color: rgba(255,255,255,0.3); }
th .col-filter:focus { border-color: var(--accent); background: rgba(255,255,255,0.12); }

tbody tr { transition: background 0.1s; }
tbody tr:nth-child(even) { background: var(--row-stripe); }
tbody tr:hover { background: var(--bg-hover); }

tbody td {
  padding: 8px 14px; border-bottom: 1px solid var(--border);
  max-width: 350px; overflow: hidden; text-overflow: ellipsis;
  white-space: nowrap; cursor: default;
  font-family: var(--mono); font-size: 0.78rem; line-height: 1.5;
}
tbody td:hover { white-space: normal; word-break: break-all; }

/* INLINE EDITING */
tbody td.editable { cursor: cell; }
tbody td.editable:hover {
  outline: 1px dashed var(--border-focus);
  outline-offset: -1px;
}

tbody td.editing {
  padding: 0 !important;
  white-space: normal;
  overflow: visible;
  outline: 2px solid var(--accent) !important;
  outline-offset: -2px;
  background: var(--bg-input) !important;
}

.cell-editor {
  width: 100%; min-height: 28px;
  padding: 8px 14px;
  font-family: var(--mono); font-size: 0.78rem;
  line-height: 1.5; border: none; outline: none;
  background: transparent; color: var(--text);
  resize: none; overflow: hidden;
  display: block;
}

tbody td.dirty { position: relative; }
tbody td.dirty::after {
  content: ''; position: absolute; top: 3px; right: 3px;
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--warning);
}

.row-actions {
  display: flex; gap: 2px; align-items: center;
  position: absolute; right: -2px; top: 50%; transform: translateY(-50%);
}

.row-action-btn {
  width: 20px; height: 20px; border: none; background: transparent;
  color: var(--text-muted); cursor: pointer; border-radius: 3px;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.6rem; transition: all 0.15s; opacity: 0;
}
tr:hover .row-action-btn { opacity: 0.7; }
.row-action-btn:hover { opacity: 1 !important; background: var(--bg-hover); color: #d44; }

td.row-num {
  color: var(--text-muted); font-size: 0.7rem; text-align: right;
  padding-right: 10px; width: 50px; min-width: 50px;
  user-select: none; border-right: 2px solid var(--border);
  position: relative; overflow: visible;
}
th.row-num-header {
  width: 50px; min-width: 50px; text-align: center; cursor: default !important;
}

.edit-count-badge {
  background: var(--warning); color: #fff;
  font-size: 0.65rem; padding: 1px 6px;
  border-radius: 10px; font-family: var(--mono); font-weight: 600;
}

td.cell-string { color: var(--json-string); }
td.cell-number { color: var(--json-number); font-variant-numeric: tabular-nums; }
td.cell-bool { color: var(--json-bool); }
td.cell-null { color: var(--json-null); font-style: italic; }
td.cell-object { color: var(--text-muted); font-size: 0.72rem; }

.nested-toggle {
  cursor: pointer; color: var(--accent); font-size: 0.72rem;
  text-decoration: underline; text-decoration-style: dotted;
}

.pagination-bar {
  padding: 8px 16px; display: flex; align-items: center;
  justify-content: space-between; border-top: 1px solid var(--border);
  background: var(--bg-card); font-size: 0.75rem;
  color: var(--text-muted); font-family: var(--mono);
}
.pagination-bar select {
  font-family: var(--mono); font-size: 0.75rem; padding: 3px 6px;
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  background: var(--bg-input); color: var(--text); outline: none;
}
.page-btns { display: flex; gap: 4px; }
.page-btns button {
  width: 28px; height: 28px; border-radius: var(--radius-sm);
  border: 1px solid var(--border); background: var(--bg-card);
  color: var(--text); cursor: pointer; display: flex;
  align-items: center; justify-content: center; font-size: 0.7rem;
  transition: all 0.15s;
}
.page-btns button:hover { background: var(--bg-hover); }
.page-btns button:disabled { opacity: 0.3; cursor: default; }

.toast-container {
  position: fixed; bottom: 20px; right: 20px; z-index: 9999;
  display: flex; flex-direction: column; gap: 8px;
}
.toast {
  padding: 10px 16px; border-radius: var(--radius-sm);
  font-size: 0.8rem; font-weight: 500; box-shadow: var(--shadow-lg);
  animation: toastIn 0.25s ease; display: flex; align-items: center; gap: 8px;
}
.toast-success { background: var(--success); color: #fff; }
.toast-error { background: var(--accent); color: #fff; }
.toast-info { background: var(--bg-header); color: #fff; }

@keyframes toastIn {
  from { transform: translateY(10px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.empty-state {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; height: 100%; color: var(--text-muted);
  gap: 12px; padding: 40px;
}
.empty-state i { font-size: 2rem; opacity: 0.3; }
.empty-state p { font-size: 0.85rem; text-align: center; line-height: 1.6; }

.kbd {
  display: inline-block; font-family: var(--mono); font-size: 0.68rem;
  padding: 2px 6px; background: var(--bg-hover); border: 1px solid var(--border);
  border-radius: 4px; margin: 0 2px;
}

.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5);
  z-index: 200; display: none; align-items: center; justify-content: center;
}
.modal-overlay.open { display: flex; }

.modal {
  background: var(--bg-card); border-radius: var(--radius);
  box-shadow: var(--shadow-lg); width: 90%; max-width: 500px; padding: 24px;
}
.modal h3 { font-size: 1rem; margin-bottom: 16px; }
.modal pre {
  background: var(--bg-input); padding: 14px; border-radius: var(--radius-sm);
  font-family: var(--mono); font-size: 0.78rem; max-height: 400px;
  overflow: auto; border: 1px solid var(--border);
  white-space: pre-wrap; word-break: break-all;
}

@media (max-width: 800px) {
  .panel-left { width: 100%; min-width: 100%; border-right: none; border-bottom: 1px solid var(--border); max-height: 40vh; }
  .main { flex-direction: column; }
  .resizer { display: none; }
  .search-box { width: 140px; }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="logo">{json}<span>.superviewer</span></div>
    <span class="badge">v2.0</span>
  </div>
  <div class="header-right">
    <button class="btn btn-icon" onclick="toggleTheme()" title="Toggle theme">
      <i class="fas fa-moon" id="themeIcon"></i>
    </button>
    <button class="btn btn-icon" onclick="showShortcuts()" title="Keyboard shortcuts">
      <i class="fas fa-keyboard"></i>
    </button>
  </div>
</div>

<div class="main">
  <div class="panel-left" id="panelLeft">
    <div class="input-toolbar">
      <button class="btn btn-primary" onclick="loadAndRender()" title="Parse & render (Ctrl+Enter)">
        <i class="fas fa-play"></i> Render
      </button>
      <button class="btn" onclick="formatJSON()" title="Beautify JSON">
        <i class="fas fa-magic"></i> Format
      </button>
      <button class="btn" onclick="minifyJSON()">
        <i class="fas fa-compress-alt"></i> Minify
      </button>
      <button class="btn" onclick="clearInput()">
        <i class="fas fa-trash-alt"></i> Clear
      </button>
      <label class="btn" style="margin:0;">
        <i class="fas fa-file-upload"></i> Upload
        <input type="file" accept=".json,.txt,.csv" style="display:none" onchange="handleFileUpload(event)">
      </label>
    </div>
    <div class="input-area" id="inputArea">
      <textarea id="jsonInput" spellcheck="false" placeholder='Paste your JSON here, drag & drop a file, or click Upload.

Example:
[
  { "id": 1, "name": "Alice", "role": "Engineer" },
  { "id": 2, "name": "Bob", "role": "Designer" }
]

Shortcuts: Ctrl+Enter to render, Ctrl+Shift+F to format'></textarea>
      <div class="drop-zone" id="dropZone">
        <span class="drop-zone-text"><i class="fas fa-file-import"></i>&nbsp; Drop JSON file here</span>
      </div>
    </div>
    <div class="status-bar">
      <span id="jsonStatus">Ready</span>
      <span id="jsonSize"></span>
    </div>
  </div>

  <div class="resizer" id="resizer"></div>

  <div class="panel-right">
    <div class="table-toolbar" id="tableToolbar" style="display:none;">
      <button class="btn btn-icon" onclick="togglePanel()" title="Toggle JSON panel">
        <i class="fas fa-columns"></i>
      </button>

      <div class="search-wrapper">
        <i class="fas fa-search"></i>
        <input type="text" class="search-box" id="globalSearch" placeholder="Search all data..." oninput="applyFilters()">
      </div>

      <div class="col-picker-wrap">
        <button class="btn" onclick="toggleColPicker()">
          <i class="fas fa-th-list"></i> Columns
        </button>
        <div class="col-picker-dropdown" id="colPicker"></div>
      </div>

      <button class="btn" onclick="toggleColFilters()" title="Toggle column filters">
        <i class="fas fa-filter"></i> Filters
      </button>

      <!-- Edit action buttons -->
      <button class="btn btn-warn" onclick="undoEdit()" id="undoBtn" style="display:none;" title="Undo last edit">
        <i class="fas fa-undo"></i> Undo <span id="editBadge" class="edit-count-badge">0</span>
      </button>
      <button class="btn" onclick="addRow()" id="addRowBtn" style="display:none;" title="Add a new empty row">
        <i class="fas fa-plus-circle"></i> Add Row
      </button>
      <button class="btn btn-success" onclick="syncToJSON()" id="syncBtn" style="display:none;" title="Sync edits back to JSON panel">
        <i class="fas fa-sync-alt"></i> Sync to JSON
      </button>

      <div style="display:flex;gap:4px;margin-left:auto;">
        <button class="btn" onclick="exportCSV()" title="Export CSV"><i class="fas fa-file-csv"></i> CSV</button>
        <button class="btn" onclick="exportJSON()" title="Export filtered JSON"><i class="fas fa-file-code"></i> JSON</button>
        <button class="btn" onclick="copyTable()" title="Copy table to clipboard"><i class="fas fa-copy"></i> Copy</button>
      </div>

      <div class="table-info" id="tableInfo"></div>
    </div>

    <div class="table-scroll" id="tableScroll">
      <div class="empty-state" id="emptyState">
        <i class="fas fa-table"></i>
        <p>Paste a JSON array in the left panel and click <strong>Render</strong>.<br>
        <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span> to render &nbsp;|&nbsp;
        Click any cell to edit it inline.</p>
      </div>
      <div id="tableContainer"></div>
    </div>

    <div class="pagination-bar" id="paginationBar" style="display:none;">
      <div style="display:flex;align-items:center;gap:8px;">
        <span>Rows per page:</span>
        <select id="pageSize" onchange="changePageSize()">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
          <option value="250">250</option>
          <option value="0">All</option>
        </select>
      </div>
      <span id="pageInfo"></span>
      <div class="page-btns">
        <button onclick="goPage('first')"><i class="fas fa-angle-double-left"></i></button>
        <button onclick="goPage('prev')"><i class="fas fa-angle-left"></i></button>
        <button onclick="goPage('next')"><i class="fas fa-angle-right"></i></button>
        <button onclick="goPage('last')"><i class="fas fa-angle-double-right"></i></button>
      </div>
    </div>
  </div>
</div>

<!-- SHORTCUTS MODAL -->
<div class="modal-overlay" id="shortcutsModal">
  <div class="modal">
    <h3><i class="fas fa-keyboard"></i>&nbsp; Keyboard Shortcuts</h3>
    <div style="display:grid; grid-template-columns: auto 1fr; gap: 8px 20px; font-size: 0.85rem;">
      <span class="kbd">Ctrl + Enter</span><span>Render table</span>
      <span class="kbd">Ctrl + Shift + F</span><span>Format / beautify JSON</span>
      <span class="kbd">Ctrl + Shift + M</span><span>Minify JSON</span>
      <span class="kbd">Ctrl + Shift + K</span><span>Clear input</span>
      <span class="kbd">Ctrl + Shift + D</span><span>Toggle dark mode</span>
      <span class="kbd">Ctrl + Z</span><span>Undo last cell edit (when not typing)</span>
      <span>While editing a cell:</span><span></span>
      <span class="kbd">Enter</span><span>Commit &amp; move down</span>
      <span class="kbd">Tab</span><span>Commit &amp; move right</span>
      <span class="kbd">Shift + Tab</span><span>Commit &amp; move left</span>
      <span class="kbd">Escape</span><span>Cancel edit</span>
    </div>
    <div style="margin-top: 16px; text-align: right;">
      <button class="btn" onclick="closeShortcuts()">Close</button>
    </div>
  </div>
</div>

<!-- CELL DETAIL MODAL -->
<div class="modal-overlay" id="cellModal">
  <div class="modal">
    <h3 id="cellModalTitle">Cell Value</h3>
    <pre id="cellModalContent"></pre>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
      <button class="btn" onclick="copyCellValue()"><i class="fas fa-copy"></i> Copy</button>
      <button class="btn" onclick="closeCellModal()">Close</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
// ==================== STATE ====================
let jsonData = [];
let allColumns = [];
let selectedColumns = [];
let filteredData = [];
let sortCol = null;
let sortDir = 'asc';
let currentPage = 1;
let showColFiltersFlag = false;

// Edit state
let editHistory = [];   // [{rowIdx, col, oldVal, newVal}]
let dirtyCells = new Set(); // "rowIdx:col"
let currentEditCell = null;

// ==================== THEME ====================
function toggleTheme() {
  const html = document.documentElement;
  const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('json-sv-theme', next);
  document.getElementById('themeIcon').className = next === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
}
(function initTheme() {
  const saved = localStorage.getItem('json-sv-theme');
  if (saved) {
    document.documentElement.setAttribute('data-theme', saved);
    document.getElementById('themeIcon').className = saved === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
  }
})();

// ==================== TOAST ====================
function toast(msg, type = 'info') {
  const container = document.getElementById('toastContainer');
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
  el.innerHTML = `<i class="fas fa-${icon}"></i> ${msg}`;
  container.appendChild(el);
  setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 2500);
}

// ==================== JSON INPUT ====================
function getInput() { return document.getElementById('jsonInput').value.trim(); }

function updateStatus() {
  const input = getInput();
  const statusEl = document.getElementById('jsonStatus');
  const sizeEl = document.getElementById('jsonSize');
  if (!input) { statusEl.textContent = 'Ready'; statusEl.className = ''; sizeEl.textContent = ''; return; }
  sizeEl.textContent = formatBytes(new Blob([input]).size);
  try {
    const parsed = JSON.parse(input);
    statusEl.textContent = Array.isArray(parsed) ? `✓ Valid · ${parsed.length} items` : '✓ Valid JSON (not an array)';
    statusEl.className = 'status-valid';
  } catch (e) {
    statusEl.textContent = `✗ ${e.message.substring(0, 60)}`;
    statusEl.className = 'status-invalid';
  }
}
document.getElementById('jsonInput').addEventListener('input', debounce(updateStatus, 300));

function formatJSON() {
  try { const p = JSON.parse(getInput()); document.getElementById('jsonInput').value = JSON.stringify(p, null, 2); updateStatus(); toast('Formatted', 'success'); }
  catch { toast('Invalid JSON', 'error'); }
}
function minifyJSON() {
  try { const p = JSON.parse(getInput()); document.getElementById('jsonInput').value = JSON.stringify(p); updateStatus(); toast('Minified', 'success'); }
  catch { toast('Invalid JSON', 'error'); }
}
function clearInput() {
  document.getElementById('jsonInput').value = '';
  jsonData = []; filteredData = []; allColumns = []; selectedColumns = [];
  editHistory = []; dirtyCells.clear(); currentEditCell = null;
  document.getElementById('tableContainer').innerHTML = '';
  document.getElementById('tableToolbar').style.display = 'none';
  document.getElementById('paginationBar').style.display = 'none';
  document.getElementById('emptyState').style.display = 'flex';
  updateStatus();
}

// ==================== FILE HANDLING ====================
function handleFileUpload(e) { const f = e.target.files[0]; if (f) readFile(f); e.target.value = ''; }
function readFile(file) {
  const r = new FileReader();
  r.onload = (e) => { document.getElementById('jsonInput').value = e.target.result; updateStatus(); toast(`Loaded: ${file.name}`, 'success'); };
  r.readAsText(file);
}
const inputArea = document.getElementById('inputArea');
const dropZone = document.getElementById('dropZone');
inputArea.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('active'); });
inputArea.addEventListener('dragleave', () => dropZone.classList.remove('active'));
inputArea.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('active'); const f = e.dataTransfer.files[0]; if (f) readFile(f); });

// ==================== LOAD & RENDER ====================
function loadAndRender() {
  const input = getInput();
  if (!input) { toast('Paste some JSON first', 'error'); return; }
  try {
    let parsed = JSON.parse(input);
    if (!Array.isArray(parsed)) {
      if (typeof parsed === 'object' && parsed !== null) parsed = [parsed];
      else throw new Error('JSON must be an array or object');
    }
    if (!parsed.length) throw new Error('Array is empty');

    jsonData = parsed;
    allColumns = Array.from(new Set(parsed.flatMap(o => Object.keys(o))));
    const savedKey = getStorageKey();
    const saved = JSON.parse(localStorage.getItem(savedKey) || 'null');
    selectedColumns = saved && saved.length ? saved.filter(c => allColumns.includes(c)) : [...allColumns];
    sortCol = null; sortDir = 'asc'; currentPage = 1;
    editHistory = []; dirtyCells.clear(); currentEditCell = null;

    buildColPicker();
    applyFilters();
    document.getElementById('tableToolbar').style.display = 'flex';
    document.getElementById('emptyState').style.display = 'none';
    toast(`Loaded ${parsed.length} rows · ${allColumns.length} columns`, 'success');
  } catch (e) { toast(e.message, 'error'); }
}
function getStorageKey() { return 'jsv_cols_' + btoa(JSON.stringify(allColumns)).slice(0, 40); }

// ==================== COLUMN PICKER ====================
function buildColPicker() {
  const c = document.getElementById('colPicker');
  c.innerHTML = `<div class="col-picker-actions">
    <button class="btn" style="font-size:0.72rem;padding:4px 10px;" onclick="pickAll()">All</button>
    <button class="btn" style="font-size:0.72rem;padding:4px 10px;" onclick="pickNone()">None</button>
  </div>`;
  allColumns.forEach(col => {
    const label = document.createElement('label');
    label.innerHTML = `<input type="checkbox" value="${esc(col)}" ${selectedColumns.includes(col) ? 'checked' : ''} onchange="updateSelectedColumns()"> ${esc(col)}`;
    c.appendChild(label);
  });
}
function toggleColPicker() { document.getElementById('colPicker').classList.toggle('open'); }
function pickAll() { selectedColumns = [...allColumns]; buildColPicker(); applyFilters(); }
function pickNone() { selectedColumns = []; buildColPicker(); applyFilters(); }
function updateSelectedColumns() {
  selectedColumns = Array.from(document.querySelectorAll('#colPicker input:checked')).map(cb => cb.value);
  localStorage.setItem(getStorageKey(), JSON.stringify(selectedColumns));
  applyFilters();
}

// ==================== FILTERING & SORTING ====================
function applyFilters() {
  const globalQ = document.getElementById('globalSearch').value.toLowerCase();
  const colFilters = {};
  document.querySelectorAll('.col-filter').forEach(inp => { const v = inp.value.toLowerCase().trim(); if (v) colFilters[inp.dataset.col] = v; });

  filteredData = jsonData.filter(row => {
    if (globalQ && !selectedColumns.some(col => String(row[col] ?? '').toLowerCase().includes(globalQ))) return false;
    for (const [col, q] of Object.entries(colFilters)) {
      if (!String(row[col] ?? '').toLowerCase().includes(q)) return false;
    }
    return true;
  });

  if (sortCol) {
    filteredData.sort((a, b) => {
      let va = a[sortCol] ?? '', vb = b[sortCol] ?? '';
      const na = Number(va), nb = Number(vb);
      if (!isNaN(na) && !isNaN(nb) && String(va).trim() !== '' && String(vb).trim() !== '') return sortDir === 'asc' ? na - nb : nb - na;
      const sa = String(va).toLowerCase(), sb = String(vb).toLowerCase();
      return sortDir === 'asc' ? sa.localeCompare(sb) : sb.localeCompare(sa);
    });
  }
  currentPage = 1;
  renderTable();
}

function toggleSort(col) {
  if (sortCol === col) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
  else { sortCol = col; sortDir = 'asc'; }
  applyFilters();
}

// ==================== RENDER TABLE ====================
function renderTable() {
  // Commit any open edit first
  commitCurrentEdit();

  if (!selectedColumns.length) {
    document.getElementById('tableContainer').innerHTML = '<div class="empty-state"><p>Select at least one column.</p></div>';
    document.getElementById('paginationBar').style.display = 'none';
    return;
  }

  const pageSize = parseInt(document.getElementById('pageSize').value);
  const total = filteredData.length;
  const totalPages = pageSize === 0 ? 1 : Math.max(1, Math.ceil(total / pageSize));
  if (currentPage > totalPages) currentPage = totalPages;
  const start = pageSize === 0 ? 0 : (currentPage - 1) * pageSize;
  const end = pageSize === 0 ? total : Math.min(start + pageSize, total);
  const pageData = filteredData.slice(start, end);

  let html = '<table><thead><tr><th class="row-num-header">#</th>';
  selectedColumns.forEach(col => {
    const sc = sortCol === col ? (sortDir === 'asc' ? 'sorted-asc' : 'sorted-desc') : '';
    const arrow = sortCol === col ? (sortDir === 'asc' ? '▲' : '▼') : '▲';
    html += `<th class="${sc}" onclick="toggleSort('${escAttr(col)}')">
      ${esc(col)}<span class="sort-icon">${arrow}</span>
      ${showColFiltersFlag ? `<input class="col-filter" data-col="${escAttr(col)}" placeholder="Filter..." onclick="event.stopPropagation()" oninput="applyFilters()">` : ''}
    </th>`;
  });
  html += '</tr></thead><tbody>';

  pageData.forEach((row, i) => {
    const ri = jsonData.indexOf(row); // real index in jsonData
    html += `<tr data-ri="${ri}">`;
    html += `<td class="row-num"><span>${start + i + 1}</span>
      <div class="row-actions"><button class="row-action-btn" onclick="deleteRow(${ri})" title="Delete row"><i class="fas fa-times"></i></button></div>
    </td>`;
    selectedColumns.forEach(col => {
      const val = row[col];
      const isObj = val !== null && val !== undefined && typeof val === 'object';
      const dirty = dirtyCells.has(`${ri}:${col}`) ? ' dirty' : '';
      const { cellHtml, cellClass } = formatCell(val, col, ri);
      if (isObj) {
        html += `<td class="${cellClass}${dirty}" data-ri="${ri}" data-col="${escAttr(col)}" ondblclick="showCellDetail('${escAttr(col)}',${ri})">${cellHtml}</td>`;
      } else {
        html += `<td class="${cellClass} editable${dirty}" data-ri="${ri}" data-col="${escAttr(col)}" onclick="startEdit(this)">${cellHtml}</td>`;
      }
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  document.getElementById('tableContainer').innerHTML = html;

  // Info
  const info = total === jsonData.length ? `${total} rows` : `${total} of ${jsonData.length} rows`;
  document.getElementById('tableInfo').textContent = `${info} · ${selectedColumns.length} cols`;

  // Edit UI
  updateEditUI();

  // Pagination
  if (pageSize > 0 && total > pageSize) {
    document.getElementById('paginationBar').style.display = 'flex';
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    const btns = document.querySelectorAll('.page-btns button');
    btns[0].disabled = btns[1].disabled = currentPage === 1;
    btns[2].disabled = btns[3].disabled = currentPage === totalPages;
  } else {
    document.getElementById('paginationBar').style.display = 'none';
  }
}

function formatCell(val, col, rowIdx) {
  if (val === null || val === undefined) return { cellHtml: '<span style="opacity:0.4">null</span>', cellClass: 'cell-null' };
  if (typeof val === 'boolean') return { cellHtml: `<span>${val}</span>`, cellClass: 'cell-bool' };
  if (typeof val === 'number') return { cellHtml: String(val), cellClass: 'cell-number' };
  if (typeof val === 'object') {
    const isArr = Array.isArray(val);
    return { cellHtml: `<span class="nested-toggle" onclick="event.stopPropagation();showCellDetail('${escAttr(col)}',${rowIdx})">${isArr ? `[${val.length} items]` : `{${Object.keys(val).length} keys}`}</span>`, cellClass: 'cell-object' };
  }
  const str = String(val);
  if (/^https?:\/\//i.test(str)) return { cellHtml: `<a href="${escAttr(str)}" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:underline;" onclick="event.stopPropagation()">${esc(str.length > 50 ? str.substring(0, 50) + '...' : str)}</a>`, cellClass: 'cell-string' };
  return { cellHtml: esc(str), cellClass: 'cell-string' };
}

// ==================== INLINE EDITING ====================
function startEdit(td) {
  if (td.classList.contains('editing')) return;

  // Commit previous
  commitCurrentEdit();

  const ri = parseInt(td.dataset.ri);
  const col = td.dataset.col;
  const val = jsonData[ri]?.[col];

  if (val !== null && val !== undefined && typeof val === 'object') {
    showCellDetail(col, ri);
    return;
  }

  currentEditCell = td;
  td.classList.add('editing');

  const displayVal = val === null || val === undefined ? '' : String(val);

  const input = document.createElement('textarea');
  input.className = 'cell-editor';
  input.value = displayVal;
  input.rows = 1;
  td.textContent = '';
  td.appendChild(input);
  input.focus();
  input.select();

  function autoResize() { input.style.height = 'auto'; input.style.height = input.scrollHeight + 'px'; }
  input.addEventListener('input', autoResize);
  autoResize();

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      commitEdit(td);
      moveToCell(td, 'down');
    } else if (e.key === 'Tab') {
      e.preventDefault();
      commitEdit(td);
      moveToCell(td, e.shiftKey ? 'left' : 'right');
    } else if (e.key === 'Escape') {
      cancelEdit(td);
    }
  });

  input.addEventListener('blur', () => {
    setTimeout(() => { if (td.classList.contains('editing')) commitEdit(td); }, 120);
  });
}

function commitCurrentEdit() {
  if (currentEditCell && currentEditCell.classList.contains('editing')) {
    commitEdit(currentEditCell);
  }
}

function commitEdit(td) {
  if (!td.classList.contains('editing')) return;
  const input = td.querySelector('.cell-editor');
  if (!input) return;

  const ri = parseInt(td.dataset.ri);
  const col = td.dataset.col;
  const oldVal = jsonData[ri]?.[col];
  let newVal = input.value;

  // Type coercion
  if (newVal === '') newVal = null;
  else if (newVal === 'true') newVal = true;
  else if (newVal === 'false') newVal = false;
  else if (newVal === 'null') newVal = null;
  else if (!isNaN(Number(newVal)) && newVal.trim() !== '') newVal = Number(newVal);

  const changed = !Object.is(oldVal === undefined ? null : oldVal, newVal);

  if (changed) {
    editHistory.push({ ri, col, oldVal, newVal });
    dirtyCells.add(`${ri}:${col}`);
    if (jsonData[ri] === undefined) jsonData[ri] = {};
    jsonData[ri][col] = newVal;
  }

  td.classList.remove('editing');
  currentEditCell = null;

  // Re-render cell content
  const { cellHtml, cellClass } = formatCell(jsonData[ri]?.[col], col, ri);
  const dirty = dirtyCells.has(`${ri}:${col}`) ? ' dirty' : '';
  td.className = `${cellClass} editable${dirty}`;
  td.innerHTML = cellHtml;
  td.onclick = function() { startEdit(this); };

  updateEditUI();
}

function cancelEdit(td) {
  const ri = parseInt(td.dataset.ri);
  const col = td.dataset.col;
  td.classList.remove('editing');
  currentEditCell = null;
  const { cellHtml, cellClass } = formatCell(jsonData[ri]?.[col], col, ri);
  const dirty = dirtyCells.has(`${ri}:${col}`) ? ' dirty' : '';
  td.className = `${cellClass} editable${dirty}`;
  td.innerHTML = cellHtml;
  td.onclick = function() { startEdit(this); };
}

function moveToCell(fromTd, direction) {
  const row = fromTd.parentElement;
  const cells = Array.from(row.querySelectorAll('td.editable'));
  const idx = cells.indexOf(fromTd);

  if (direction === 'right') {
    if (idx < cells.length - 1) { cells[idx + 1].click(); }
    else {
      const nextRow = row.nextElementSibling;
      if (nextRow) { const c = nextRow.querySelectorAll('td.editable'); if (c.length) c[0].click(); }
    }
  } else if (direction === 'left') {
    if (idx > 0) { cells[idx - 1].click(); }
    else {
      const prevRow = row.previousElementSibling;
      if (prevRow) { const c = prevRow.querySelectorAll('td.editable'); if (c.length) c[c.length - 1].click(); }
    }
  } else if (direction === 'down') {
    const nextRow = row.nextElementSibling;
    if (nextRow) {
      const c = nextRow.querySelectorAll('td.editable');
      if (c[idx]) c[idx].click();
    }
  }
}

// ==================== UNDO ====================
function undoEdit() {
  if (!editHistory.length) return;
  const last = editHistory.pop();
  jsonData[last.ri][last.col] = last.oldVal;

  // Check if there are any remaining edits for this cell
  const stillDirty = editHistory.some(e => e.ri === last.ri && e.col === last.col);
  if (!stillDirty) dirtyCells.delete(`${last.ri}:${last.col}`);

  toast(`Undid edit on "${last.col}" row ${last.ri + 1}`, 'info');
  renderTable();
}

// ==================== ADD / DELETE ROWS ====================
function addRow() {
  const newRow = {};
  allColumns.forEach(col => newRow[col] = null);
  jsonData.push(newRow);
  applyFilters();
  toast('Row added', 'success');

  // Scroll to bottom
  const scroll = document.getElementById('tableScroll');
  const ps = parseInt(document.getElementById('pageSize').value);
  if (ps > 0) {
    const totalPages = Math.ceil(filteredData.length / ps);
    currentPage = totalPages;
    renderTable();
  }
  setTimeout(() => scroll.scrollTop = scroll.scrollHeight, 50);
}

function deleteRow(ri) {
  if (!confirm(`Delete row ${ri + 1}?`)) return;
  jsonData.splice(ri, 1);
  // Clean up edit history and dirty cells referencing this row
  editHistory = editHistory.filter(e => e.ri !== ri).map(e => {
    if (e.ri > ri) e.ri--;
    return e;
  });
  const newDirty = new Set();
  dirtyCells.forEach(key => {
    const [r, c] = key.split(':');
    const rn = parseInt(r);
    if (rn < ri) newDirty.add(key);
    else if (rn > ri) newDirty.add(`${rn - 1}:${c}`);
  });
  dirtyCells = newDirty;
  applyFilters();
  toast('Row deleted', 'info');
}

// ==================== SYNC TO JSON ====================
function syncToJSON() {
  document.getElementById('jsonInput').value = JSON.stringify(jsonData, null, 2);
  editHistory = [];
  dirtyCells.clear();
  updateStatus();
  updateEditUI();
  renderTable();
  toast('JSON panel updated with all edits', 'success');
}

function updateEditUI() {
  const count = editHistory.length;
  document.getElementById('undoBtn').style.display = count > 0 ? 'inline-flex' : 'none';
  document.getElementById('syncBtn').style.display = count > 0 || dirtyCells.size > 0 ? 'inline-flex' : 'none';
  document.getElementById('addRowBtn').style.display = jsonData.length ? 'inline-flex' : 'none';
  const badge = document.getElementById('editBadge');
  badge.textContent = count;
  badge.style.display = count > 0 ? 'inline' : 'none';
}

// ==================== CELL DETAIL MODAL ====================
function showCellDetail(col, ri) {
  const val = jsonData[ri]?.[col];
  document.getElementById('cellModalTitle').textContent = `${col} [Row ${ri + 1}]`;
  document.getElementById('cellModalContent').textContent = typeof val === 'object' ? JSON.stringify(val, null, 2) : String(val ?? 'null');
  document.getElementById('cellModal').classList.add('open');
}
function closeCellModal() { document.getElementById('cellModal').classList.remove('open'); }
function copyCellValue() { navigator.clipboard.writeText(document.getElementById('cellModalContent').textContent); toast('Copied', 'success'); }

// ==================== COL FILTERS ====================
function toggleColFilters() { showColFiltersFlag = !showColFiltersFlag; renderTable(); }

// ==================== PAGINATION ====================
function goPage(dir) {
  const ps = parseInt(document.getElementById('pageSize').value);
  const tp = Math.max(1, Math.ceil(filteredData.length / ps));
  if (dir === 'first') currentPage = 1;
  else if (dir === 'prev') currentPage = Math.max(1, currentPage - 1);
  else if (dir === 'next') currentPage = Math.min(tp, currentPage + 1);
  else if (dir === 'last') currentPage = tp;
  renderTable();
}
function changePageSize() { currentPage = 1; renderTable(); }

// ==================== EXPORT ====================
function exportCSV() {
  if (!filteredData.length) { toast('No data', 'error'); return; }
  const rows = filteredData.map(row =>
    selectedColumns.map(h => { let v = row[h]; if (v == null) v = ''; if (typeof v === 'object') v = JSON.stringify(v); return `"${String(v).replace(/"/g, '""')}"`; }).join(',')
  );
  downloadFile([selectedColumns.map(h => `"${h}"`).join(','), ...rows].join('\n'), 'data.csv', 'text/csv');
  toast('CSV exported', 'success');
}
function exportJSON() {
  if (!filteredData.length) { toast('No data', 'error'); return; }
  const out = filteredData.map(row => { const o = {}; selectedColumns.forEach(c => o[c] = row[c]); return o; });
  downloadFile(JSON.stringify(out, null, 2), 'data.json', 'application/json');
  toast('JSON exported', 'success');
}
function copyTable() {
  const table = document.querySelector('#tableContainer table');
  if (!table) { toast('No table', 'error'); return; }
  const rows = Array.from(table.querySelectorAll('tr')).map(tr =>
    Array.from(tr.querySelectorAll('th, td')).slice(1).map(c => c.innerText.replace(/\s+/g, ' ').trim()).join('\t')
  );
  navigator.clipboard.writeText(rows.join('\n'));
  toast('Table copied', 'success');
}
function downloadFile(content, filename, type) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content], { type }));
  a.download = filename; a.click();
}

// ==================== PANEL / RESIZER ====================
function togglePanel() { document.getElementById('panelLeft').classList.toggle('collapsed'); }
const resizer = document.getElementById('resizer');
const panelLeft = document.getElementById('panelLeft');
let isResizing = false;
resizer.addEventListener('mousedown', () => {
  isResizing = true; resizer.classList.add('active');
  document.addEventListener('mousemove', onResize);
  document.addEventListener('mouseup', stopResize);
});
function onResize(e) { if (isResizing) panelLeft.style.width = Math.max(200, Math.min(800, e.clientX)) + 'px'; }
function stopResize() { isResizing = false; resizer.classList.remove('active'); document.removeEventListener('mousemove', onResize); document.removeEventListener('mouseup', stopResize); }

// ==================== SHORTCUTS ====================
function showShortcuts() { document.getElementById('shortcutsModal').classList.add('open'); }
function closeShortcuts() { document.getElementById('shortcutsModal').classList.remove('open'); }

document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.key === 'Enter') { e.preventDefault(); loadAndRender(); }
  if (e.ctrlKey && e.shiftKey && e.key === 'F') { e.preventDefault(); formatJSON(); }
  if (e.ctrlKey && e.shiftKey && e.key === 'M') { e.preventDefault(); minifyJSON(); }
  if (e.ctrlKey && e.shiftKey && e.key === 'K') { e.preventDefault(); clearInput(); }
  if (e.ctrlKey && e.shiftKey && e.key === 'D') { e.preventDefault(); toggleTheme(); }
  // Ctrl+Z for undo (only when not in a text field)
  if (e.ctrlKey && e.key === 'z' && !e.shiftKey && document.activeElement.tagName !== 'TEXTAREA' && document.activeElement.tagName !== 'INPUT') {
    e.preventDefault(); undoEdit();
  }
  if (e.key === 'Escape') { closeShortcuts(); closeCellModal(); document.getElementById('colPicker').classList.remove('open'); }
});

document.addEventListener('click', (e) => {
  if (!e.target.closest('.col-picker-wrap') && document.getElementById('colPicker').classList.contains('open')) {
    document.getElementById('colPicker').classList.remove('open');
  }
});

// ==================== UTILITIES ====================
function esc(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }
function escAttr(str) { return String(str).replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/</g, '&lt;'); }
function formatBytes(b) { if (b < 1024) return b + ' B'; if (b < 1048576) return (b / 1024).toFixed(1) + ' KB'; return (b / 1048576).toFixed(1) + ' MB'; }
function debounce(fn, d) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), d); }; }

updateStatus();
</script>
</body>
</html>
