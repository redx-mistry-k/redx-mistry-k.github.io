<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON Step Adder</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #f6f7fb 0%, #f0f4f8 100%);
      padding: 20px;
      margin: 0;
      color: #334155;
      line-height: 1.5;
      min-height: 100vh;
    }

    .container {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
      margin-bottom: 24px;
      width: 100%;
      max-width: 1400px;
      margin-left: auto;
      margin-right: auto;
    }

    h2 {
      color: #1e293b;
      margin-top: 0;
      margin-bottom: 24px;
      font-size: 26px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h2:before {
      content: "üìä";
      font-size: 28px;
    }

    h3 {
      color: #475569;
      margin-top: 0;
      margin-bottom: 18px;
      font-size: 18px;
      font-weight: 600;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
    }

    h4 {
      margin-top: 0;
      margin-bottom: 14px;
      font-size: 15px;
      font-weight: 600;
    }

    label {
      display: block;
      font-weight: 600;
      color: #475569;
      margin-bottom: 8px;
      font-size: 14px;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      padding: 14px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      margin-bottom: 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: #f8fafc;
      transition: all 0.2s ease;
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: #3b82f6;
      background: white;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    textarea#output {
      background: #f1f5f9;
      border-color: #cbd5e1;
      font-size: 12px;
      line-height: 1.4;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-width: 120px;
      height: 40px;
    }

    button:first-of-type {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
    }

    button.copy-btn {
      background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
      color: white;
    }

    button.format-toggle {
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
      color: white;
      min-width: 140px;
    }

    button.undo-btn {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      color: white;
      min-width: 120px;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .format-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #e0e7ff;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      color: #4f46e5;
      margin-left: auto;
    }

    .format-indicator.compact {
      background: #fef3c7;
      color: #d97706;
    }

    .sort-indicator {
      display: inline-block;
      font-size: 10px;
      opacity: 0.5;
      margin-left: 4px;
    }

    .sort-indicator.asc:after {
      content: "‚Üë";
    }

    .sort-indicator.desc:after {
      content: "‚Üì";
    }

    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: white;
      margin-bottom: 16px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      font-size: 13px;
    }

    th, td {
      border: 1px solid #e2e8f0;
      padding: 10px 14px;
      text-align: left;
      word-break: break-word;
    }

    th {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      font-weight: 700;
      color: #475569;
      border-bottom: 2px solid #e2e8f0;
      position: relative;
      user-select: none;
      white-space: nowrap;
      cursor: pointer;
    }

    th:hover {
      background: #e2e8f0;
    }

    td.editable {
      background: #fefce8;
      transition: background 0.2s;
    }

    td.editable:focus {
      background: #fff;
      outline: 2px solid #fbbf24;
      outline-offset: -2px;
    }

    td.readonly {
      background: #f8fafc;
      color: #64748b;
      font-weight: 600;
    }

    td.error {
      background: #fee2e2;
      border-color: #fca5a5;
    }

    td.error:focus {
      outline: 2px solid #ef4444;
    }

    tr:hover td {
      background: #f1f5f9;
    }

    .box {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 18px;
      margin-bottom: 18px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
      transition: transform 0.2s ease;
    }

    .box:hover {
      transform: translateY(-1px);
    }

    .box.added {
      border-top: 4px solid #10b981;
    }

    .box.added h4 {
      color: #10b981;
    }

    .box.updated {
      border-top: 4px solid #f59e0b;
    }

    .box.updated h4 {
      color: #f59e0b;
    }

    .box.edited {
      border-top: 4px solid #6366f1;
    }

    .box.edited h4 {
      color: #6366f1;
    }

    .panel {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 18px;
      margin-top: 20px;
      font-size: 13px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
    }

    .ok {
      color: #10b981;
      font-weight: 600;
      padding: 8px 14px;
      background: #d1fae5;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .warn {
      color: #f59e0b;
      font-weight: 600;
      padding: 8px 14px;
      background: #fef3c7;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .err {
      color: #ef4444;
      font-weight: 600;
      padding: 8px 14px;
      background: #fee2e2;
      border-radius: 6px;
    }

    .info {
      color: #3b82f6;
      font-weight: 600;
      padding: 8px 14px;
      background: #dbeafe;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
      white-space: nowrap;
    }

    .badge-added {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-updated {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-edited {
      background: #e0e7ff;
      color: #3730a3;
    }

    .input-section {
      margin-bottom: 24px;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .section-title i {
      font-size: 18px;
    }

    .instructions {
      background: #f0f9ff;
      border-left: 4px solid #0ea5e9;
      padding: 16px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 20px;
      font-size: 13px;
      color: #475569;
    }

    .instructions ul {
      margin: 8px 0;
      padding-left: 20px;
    }

    .instructions li {
      margin-bottom: 6px;
    }

    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      border-top: 4px solid #e2e8f0;
    }

    .stat-card.added {
      border-color: #10b981;
    }

    .stat-card.updated {
      border-color: #f59e0b;
    }

    .stat-card.edited {
      border-color: #6366f1;
    }

    .stat-number {
      font-size: 24px;
      font-weight: 700;
      margin: 8px 0;
      line-height: 1.2;
    }

    .stat-added { color: #10b981; }
    .stat-updated { color: #f59e0b; }
    .stat-edited { color: #6366f1; }

    .stat-label {
      font-size: 12px;
      color: #64748b;
      font-weight: 600;
    }

    .empty-state {
      text-align: center;
      padding: 30px 20px;
      color: #94a3b8;
    }

    .empty-state i {
      font-size: 36px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 14px;
      margin: 0;
    }

    /* Tablet styles (768px - 1024px) */
    @media (max-width: 1024px) {
      .container {
        padding: 20px;
        border-radius: 10px;
      }
      
      .grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .stats {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .button-group {
        flex-wrap: wrap;
      }
      
      .format-indicator {
        margin-left: 0;
        margin-top: 8px;
      }
    }

    /* Mobile styles (< 768px) */
    @media (max-width: 768px) {
      body {
        padding: 12px;
      }
      
      .container {
        padding: 16px;
        border-radius: 10px;
      }
      
      h2 {
        font-size: 22px;
        margin-bottom: 20px;
      }
      
      h2:before {
        font-size: 24px;
      }
      
      h3 {
        font-size: 17px;
        margin-bottom: 16px;
      }
      
      h4 {
        font-size: 15px;
        margin-bottom: 12px;
      }
      
      textarea {
        padding: 12px;
        font-size: 14px;
        min-height: 100px;
      }
      
      .button-group {
        flex-direction: column;
        gap: 8px;
        align-items: stretch;
      }
      
      button {
        width: 100%;
        height: 44px;
        font-size: 15px;
        min-width: 0;
      }
      
      .format-toggle, .undo-btn {
        order: 3;
      }
      
      .format-indicator {
        order: 4;
        justify-content: center;
        margin: 8px 0 0 0;
      }
      
      table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        font-size: 14px;
      }
      
      th, td {
        padding: 12px;
        min-width: 80px;
      }
      
      .box {
        padding: 16px;
        margin-bottom: 16px;
      }
      
      .panel {
        padding: 16px;
      }
      
      .instructions {
        padding: 14px;
        font-size: 14px;
      }
      
      .stat-card {
        padding: 14px;
      }
      
      .stat-number {
        font-size: 22px;
      }
      
      .mobile-action-bar {
        display: flex;
      }
    }

    /* Small mobile styles (< 480px) */
    @media (max-width: 480px) {
      .container {
        padding: 14px;
      }
      
      h2 {
        font-size: 20px;
      }
      
      textarea {
        font-size: 16px; /* Prevent zoom on iOS */
      }
      
      .stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .empty-state {
        padding: 20px 16px;
      }
      
      .empty-state i {
        font-size: 32px;
      }
    }

    /* Mobile Action Bar */
    .mobile-action-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 12px 16px;
      border-top: 1px solid #e2e8f0;
      display: none;
      justify-content: space-between;
      gap: 10px;
      z-index: 100;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 768px) {
      .mobile-action-bar {
        display: flex;
      }
      
      body {
        padding-bottom: 80px; /* Space for fixed action bar */
      }
    }

    /* Hide/show for different screens */
    @media (max-width: 768px) {
      .desktop-only {
        display: none !important;
      }
    }

    @media (min-width: 769px) {
      .mobile-only {
        display: none !important;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <h2>JSON Step Adder</h2>

  <div class="instructions">
    <p><strong>How to use:</strong></p>
    <ul>
      <li>Paste your existing JSON array in the first textarea</li>
      <li>Enter new step numbers (comma or newline separated) in the second textarea</li>
      <li>Click "Add Steps" to process and update your data</li>
      <li>Edit any cell directly (except "Steps" column)</li>
      <li>Click table headers to sort columns</li>
      <li>Use Undo button to revert to loaded state</li>
      <li>Toggle between formatted and minified JSON output</li>
    </ul>
  </div>

  <div class="input-section">
    <div class="section-title">
      <span>üì•</span>
      <label><strong>Existing JSON</strong></label>
    </div>
    <textarea id="jsonInput" placeholder='[{"Date": "2023-10-01", "IsCompleted": 1, "Steps": 100, "UpdatedBy": "System"}, ...]'></textarea>
    <div class="button-group desktop-only">
      <button onclick="loadInput()">
        <span>üìã</span>
        Load Input
      </button>
      <button class="undo-btn" onclick="undoChanges()" id="undoBtn" disabled>
        <span>‚Ü∂</span>
        Undo Changes
      </button>
    </div>
  </div>

  <div class="input-section">
    <div class="section-title">
      <span>‚ú®</span>
      <label><strong>New Steps</strong></label>
    </div>
    <textarea id="stepsInput" placeholder="Enter step numbers separated by commas or new lines&#10;Example: 101, 102, 103"></textarea>
    
    <div class="button-group desktop-only">
      <button onclick="addSteps()">
        <span>‚ûï</span>
        Add Steps
      </button>
      <button class="copy-btn" onclick="copyOutput()">
        <span>üìã</span>
        Copy Output
      </button>
      <button class="format-toggle" onclick="toggleFormat()">
        <span id="formatIcon">üìÑ</span>
        <span id="formatText">Minify</span>
      </button>
      <div class="format-indicator" id="formatIndicator">
        <span>üìÑ</span>
        <span>Formatted</span>
      </div>
    </div>
  </div>

  <div class="input-section">
    <div class="section-title">
      <span>üì§</span>
      <label><strong>JSON Output</strong></label>
    </div>
    <div class="button-group mobile-only">
      <button onclick="loadInput()">
        <span>üìã</span>
        Load
      </button>
      <button onclick="addSteps()">
        <span>‚ûï</span>
        Add Steps
      </button>
      <button class="copy-btn" onclick="copyOutput()">
        <span>üìã</span>
        Copy
      </button>
      <button class="undo-btn" onclick="undoChanges()" id="undoBtnMobile" disabled>
        <span>‚Ü∂</span>
        Undo
      </button>
      <button class="format-toggle" onclick="toggleFormat()">
        <span id="formatIconMobile">üìÑ</span>
        <span id="formatTextMobile">Minify</span>
      </button>
    </div>
    <div class="format-indicator mobile-only" id="formatIndicatorMobile">
      <span>üìÑ</span>
      <span>Formatted</span>
    </div>
    <textarea id="output" readonly placeholder="Output JSON will appear here..."></textarea>
  </div>
</div>

<div class="container">
  <div class="stats" id="statsContainer">
    <!-- Stats will be populated by JavaScript -->
  </div>

  <div class="grid">
    <!-- MAIN TABLE -->
    <div>
      <h3>Main Data (Editable) <span class="status-badge badge-edited" id="mainCount">0 rows</span></h3>
      <div id="tableContainer" class="card">
        <div class="empty-state">
          <div>üìä</div>
          <p>No data loaded. Paste JSON and click "Load Input" to begin.</p>
        </div>
      </div>
    </div>

    <!-- SIDE TABLES -->
    <div>
      <div class="box added">
        <h4>‚ûï Added Steps <span class="status-badge badge-added" id="addedCount">0</span></h4>
        <div id="addedTable" class="empty-state">
          <div>üÜï</div>
          <p>New steps will appear here</p>
        </div>
      </div>

      <div class="box updated">
        <h4>üîÑ Updated Steps <span class="status-badge badge-updated" id="updatedCount">0</span></h4>
        <div id="updatedTable" class="empty-state">
          <div>üìù</div>
          <p>Updated steps will appear here</p>
        </div>
      </div>

      <div class="box edited">
        <h4>‚úèÔ∏è Edited Steps <span class="status-badge badge-edited" id="editedCount">0</span></h4>
        <div id="editedTable" class="empty-state">
          <div>‚úèÔ∏è</div>
          <p>Manually edited steps will appear here</p>
        </div>
      </div>
    </div>
  </div>

  <div id="summary" class="panel">
    <div class="empty-state">
      <div>üìà</div>
      <p>Summary will appear here after adding steps</p>
    </div>
  </div>
</div>

<!-- Mobile Action Bar -->
<div class="mobile-action-bar mobile-only">
  <button onclick="loadInput()">
    <span>üìã</span>
    Load
  </button>
  <button onclick="addSteps()">
    <span>‚ûï</span>
    Add Steps
  </button>
  <button class="copy-btn" onclick="copyOutput()">
    <span>üìã</span>
    Copy
  </button>
</div>

<script>
let data = [];
let originalData = []; // Store for undo functionality
let rowStatus = {}; // keyed by Steps
let isMinified = false; // Track current format
let currentSort = { column: null, direction: 'asc' }; // Track sorting state
let cellErrors = {}; // Track cell validation errors: {rowIndex_columnName: errorMessage}

function today() {
  return new Date().toISOString().split("T")[0];
}

/* ---------- FORMAT TOGGLE ---------- */
function toggleFormat() {
  isMinified = !isMinified;
  updateFormatUI();
  syncOutput();
}

function updateFormatUI() {
  const formatIcon = document.getElementById('formatIcon');
  const formatText = document.getElementById('formatText');
  const formatIndicator = document.getElementById('formatIndicator');
  
  const formatIconMobile = document.getElementById('formatIconMobile');
  const formatTextMobile = document.getElementById('formatTextMobile');
  const formatIndicatorMobile = document.getElementById('formatIndicatorMobile');
  
  if (isMinified) {
    // Update desktop UI
    if (formatIcon) formatIcon.textContent = 'üì¶';
    if (formatText) formatText.textContent = 'Format';
    if (formatIndicator) {
      formatIndicator.innerHTML = '<span>üì¶</span><span>Minified</span>';
      formatIndicator.classList.add('compact');
    }
    
    // Update mobile UI
    if (formatIconMobile) formatIconMobile.textContent = 'üì¶';
    if (formatTextMobile) formatTextMobile.textContent = 'Format';
    if (formatIndicatorMobile) {
      formatIndicatorMobile.innerHTML = '<span>üì¶</span><span>Minified</span>';
      formatIndicatorMobile.classList.add('compact');
    }
  } else {
    // Update desktop UI
    if (formatIcon) formatIcon.textContent = 'üìÑ';
    if (formatText) formatText.textContent = 'Minify';
    if (formatIndicator) {
      formatIndicator.innerHTML = '<span>üìÑ</span><span>Formatted</span>';
      formatIndicator.classList.remove('compact');
    }
    
    // Update mobile UI
    if (formatIconMobile) formatIconMobile.textContent = 'üìÑ';
    if (formatTextMobile) formatTextMobile.textContent = 'Minify';
    if (formatIndicatorMobile) {
      formatIndicatorMobile.innerHTML = '<span>üìÑ</span><span>Formatted</span>';
      formatIndicatorMobile.classList.remove('compact');
    }
  }
}

/* ---------- SORTING LOGIC ---------- */
function sortTable(column) {
  if (!data.length) return;
  
  // Toggle direction if same column, otherwise start with ascending
  if (currentSort.column === column) {
    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort.column = column;
    currentSort.direction = 'asc';
  }
  
  // Create a copy to sort
  const sortedData = [...data];
  
  sortedData.sort((a, b) => {
    const aVal = a[column];
    const bVal = b[column];
    
    // Handle null/undefined values
    if (aVal === null || aVal === undefined) return 1;
    if (bVal === null || bVal === undefined) return -1;
    
    // Handle numeric sorting for Steps and IsCompleted
    if (column === 'Steps' || column === 'IsCompleted') {
      const numA = Number(aVal);
      const numB = Number(bVal);
      return currentSort.direction === 'asc' ? numA - numB : numB - numA;
    }
    
    // Handle date sorting
    if (column === 'Date') {
      const dateA = new Date(aVal);
      const dateB = new Date(bVal);
      return currentSort.direction === 'asc' ? dateA - dateB : dateB - dateA;
    }
    
    // Default string sorting
    const strA = String(aVal).toLowerCase();
    const strB = String(bVal).toLowerCase();
    return currentSort.direction === 'asc' 
      ? strA.localeCompare(strB) 
      : strB.localeCompare(strA);
  });
  
  data = sortedData;
  renderTable();
}

/* ---------- VALIDATION FUNCTIONS ---------- */
function validateDate(dateString) {
  if (!dateString || dateString.trim() === '') return null; // Empty is allowed
  
  // Simple yyyy-mm-dd validation
  const regex = /^\d{4}-\d{2}-\d{2}$/;
  if (!regex.test(dateString)) {
    return 'Date must be in YYYY-MM-DD format';
  }
  
  // Check if it's a valid date
  const date = new Date(dateString);
  if (isNaN(date.getTime())) {
    return 'Invalid date';
  }
  
  // Check if date string matches parsed date (prevents 2023-13-01)
  const [year, month, day] = dateString.split('-').map(Number);
  if (date.getFullYear() !== year || 
      date.getMonth() + 1 !== month || 
      date.getDate() !== day) {
    return 'Invalid date (month/day out of range)';
  }
  
  return null; // Valid
}

function validateIsCompleted(value) {
  if (value === null || value === '') return null; // Empty is allowed
  
  const num = Number(value);
  if (isNaN(num)) {
    return 'Must be a number (0 or 1)';
  }
  
  if (num !== 0 && num !== 1) {
    return 'Must be 0 or 1';
  }
  
  return null; // Valid
}

function validateSteps(value) {
  if (value === null || value === '') {
    return 'Step number is required';
  }
  
  const num = Number(value);
  if (isNaN(num)) {
    return 'Must be a number';
  }
  
  if (!Number.isInteger(num)) {
    return 'Must be an integer';
  }
  
  if (num < 0) {
    return 'Must be positive';
  }
  
  return null; // Valid
}

/* ---------- DUPLICATE DETECTION ---------- */
function detectDuplicates() {
  const stepCounts = {};
  const duplicates = [];
  
  data.forEach(row => {
    const step = row.Steps;
    if (step !== null && step !== undefined) {
      stepCounts[step] = (stepCounts[step] || 0) + 1;
    }
  });
  
  for (const [step, count] of Object.entries(stepCounts)) {
    if (count > 1) {
      duplicates.push(Number(step));
    }
  }
  
  return duplicates;
}

/* ---------- UNDO FUNCTIONALITY ---------- */
function undoChanges() {
  if (originalData.length === 0) return;
  
  // Restore original data
  data = JSON.parse(JSON.stringify(originalData));
  rowStatus = {};
  cellErrors = {};
  
  // Update UI
  renderTable();
  updateUndoButton();
  
  summary.innerHTML = `
    <div class="info">
      <span>‚Ü∂</span>
      Changes undone. Restored to loaded state.
    </div>
  `;
}

function updateUndoButton() {
  const hasChanges = JSON.stringify(data) !== JSON.stringify(originalData);
  const undoBtn = document.getElementById('undoBtn');
  const undoBtnMobile = document.getElementById('undoBtnMobile');
  
  if (undoBtn) undoBtn.disabled = !hasChanges;
  if (undoBtnMobile) undoBtnMobile.disabled = !hasChanges;
}

/* ---------- RENDER STATS ---------- */
function renderStats() {
  const added = data.filter(r => rowStatus[r.Steps] === "added").length;
  const updated = data.filter(r => rowStatus[r.Steps] === "updated").length;
  const edited = data.filter(r => rowStatus[r.Steps] === "edited").length;
  const total = data.length;

  document.getElementById("mainCount").textContent = `${total} rows`;
  document.getElementById("addedCount").textContent = added;
  document.getElementById("updatedCount").textContent = updated;
  document.getElementById("editedCount").textContent = edited;

  const statsContainer = document.getElementById("statsContainer");
  statsContainer.innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Total Rows</div>
      <div class="stat-number">${total}</div>
      <small>All steps</small>
    </div>
    <div class="stat-card added">
      <div class="stat-label">Added</div>
      <div class="stat-number stat-added">${added}</div>
      <small>New steps</small>
    </div>
    <div class="stat-card updated">
      <div class="stat-label">Updated</div>
      <div class="stat-number stat-updated">${updated}</div>
      <small>Existing steps</small>
    </div>
    <div class="stat-card edited">
      <div class="stat-label">Edited</div>
      <div class="stat-number stat-edited">${edited}</div>
      <small>Manual edits</small>
    </div>
  `;
}

/* ---------- TABLE RENDER ---------- */
function renderTable() {
  renderMainTable();
  renderSideTables();
  syncOutput();
  renderStats();
  updateUndoButton();
}

function renderMainTable() {
  const container = document.getElementById("tableContainer");
  
  if (!data.length) {
    container.innerHTML = `
      <div class="empty-state">
        <div>üìä</div>
        <p>No data loaded. Paste JSON and click "Load Input" to begin.</p>
      </div>
    `;
    return;
  }

  const cols = Object.keys(data[0]);
  let html = "<table><thead><tr>";

  cols.forEach(c => {
    const sortIndicator = currentSort.column === c 
      ? `<span class="sort-indicator ${currentSort.direction}"></span>`
      : '';
    html += `<th onclick="sortTable('${c}')">${c}${sortIndicator}</th>`;
  });
  
  html += "</tr></thead><tbody>";

  data.forEach((row, i) => {
    const status = rowStatus[row.Steps];
    html += "<tr>";
    cols.forEach(col => {
      const editable = col !== "Steps";
      const statusClass = status ? `status-${status}` : "";
      const errorKey = `${i}_${col}`;
      const hasError = cellErrors[errorKey];
      const cellClass = `${editable ? "editable" : "readonly"} ${statusClass} ${hasError ? "error" : ""}`;
      
      html += `
        <td class="${cellClass}"
            contenteditable="${editable}"
            onblur="updateCell(${i}, '${col}', this.innerText)"
            title="${hasError || (editable ? "Click to edit" : "Read-only")}">
          ${row[col] ?? ""}
        </td>`;
    });
    html += "</tr>";
  });

  html += "</tbody></table>";
  container.innerHTML = html;
}

/* ---------- SIDE TABLES ---------- */
function renderSideTables() {
  renderStatusTable("added", "addedTable", "üÜï", "New steps will appear here");
  renderStatusTable("updated", "updatedTable", "üìù", "Updated steps will appear here");
  renderStatusTable("edited", "editedTable", "‚úèÔ∏è", "Manually edited steps will appear here");
}

function renderStatusTable(status, containerId, icon, emptyMessage) {
  const rows = data.filter(r => rowStatus[r.Steps] === status);
  const container = document.getElementById(containerId);

  if (!rows.length) {
    container.innerHTML = `
      <div class="empty-state">
        <div>${icon}</div>
        <p>${emptyMessage}</p>
      </div>
    `;
    return;
  }

  const cols = Object.keys(rows[0]);
  let html = "<table><thead><tr>";
  cols.forEach(c => html += `<th>${c}</th>`);
  html += "</tr></thead><tbody>";

  rows.forEach(row => {
    html += "<tr>";
    cols.forEach(c => {
      const cellValue = row[c] ?? "";
      html += `<td>${cellValue}</td>`;
    });
    html += "</tr>";
  });

  html += "</tbody></table>";
  container.innerHTML = html;
}

/* ---------- CELL UPDATE ---------- */
function updateCell(index, column, value) {
  if (column === "Steps") return;

  value = value.trim();
  const errorKey = `${index}_${column}`;
  
  // Clear previous error
  delete cellErrors[errorKey];
  
  // Validate based on column type
  let validationError = null;
  
  if (column === "Date") {
    validationError = validateDate(value);
  } else if (column === "IsCompleted") {
    validationError = validateIsCompleted(value);
  }
  
  if (validationError) {
    // Show error but don't update the data
    cellErrors[errorKey] = validationError;
    renderTable();
    
    // Show error in summary
    summary.innerHTML = `
      <div class="err">
        <span>‚ùå</span>
        Validation error in row ${index + 1}, ${column}: ${validationError}
      </div>
      ${summary.innerHTML}
    `;
    return;
  }
  
  // Update the data
  if (value === "") {
    data[index][column] = null;
  } else if (column === "IsCompleted") {
    // Clamp to 0 or 1
    const num = Number(value);
    data[index][column] = num === 0 ? 0 : 1;
  } else {
    data[index][column] = value;
  }

  if (!rowStatus[data[index].Steps]) {
    rowStatus[data[index].Steps] = "edited";
  }

  renderTable();
}

/* ---------- LOAD INPUT ---------- */
function loadInput() {
  try {
    data = JSON.parse(jsonInput.value);
    if (!Array.isArray(data)) throw "";
    
    // Store original for undo
    originalData = JSON.parse(JSON.stringify(data));
    
    // Clear states
    rowStatus = {};
    cellErrors = {};
    currentSort = { column: null, direction: 'asc' };
    
    // Check for duplicate steps
    const duplicates = detectDuplicates();
    if (duplicates.length > 0) {
      summary.innerHTML = `
        <div class="warn">
          <span>‚ö†Ô∏è</span>
          Duplicate step numbers detected: ${duplicates.join(", ")}
        </div>
      `;
    } else {
      summary.innerHTML = `
        <div class="ok">
          <span>‚úÖ</span>
          Successfully loaded ${data.length} rows
        </div>
      `;
    }
    
    renderTable();
    updateUndoButton();
    
  } catch {
    summary.innerHTML = `<div class="err">
      <span>‚ùå</span>
      Invalid JSON. Please check your input.
    </div>`;
  }
}

/* ---------- ADD / UPDATE ---------- */
function addSteps() {
  const steps = stepsInput.value
    .split(/[\n,]+/)
    .map(s => s.trim())
    .filter(Boolean);

  if (steps.length === 0) {
    summary.innerHTML = `<div class="warn">
      <span>‚ö†Ô∏è</span>
      No steps provided. Please enter step numbers.
    </div>`;
    return;
  }

  const added = [];
  const updated = [];
  const skipped = [];
  const t = today();

  steps.forEach(s => {
    const step = Number(s);
    let found = false;

    data.forEach(row => {
      if (row.Steps === step) {
        found = true;
        const blockers = [];
        if (row.Date !== null) blockers.push("Date");
        if (row.IsCompleted !== null) blockers.push("IsCompleted");
        if (row.UpdatedBy !== null) blockers.push("UpdatedBy");

        if (!blockers.length) {
          row.Date = t;
          row.IsCompleted = 1;
          row.UpdatedBy = "System";
          rowStatus[step] = "updated";
          updated.push(step);
        } else {
          skipped.push({ step, blockers });
        }
      }
    });

    if (!found) {
      data.push({
        Date: t,
        IsCompleted: 1,
        Steps: step,
        UpdatedBy: "System"
      });
      rowStatus[step] = "added";
      added.push(step);
    }
  });

  renderTable();

  let html = "";
  if (added.length) html += `<div class="ok"><span>‚úÖ</span> Added: ${added.join(", ")}</div>`;
  if (updated.length) html += `<div class="ok"><span>üîÑ</span> Updated: ${updated.join(", ")}</div>`;
  if (skipped.length) {
    html += `<div class="warn"><span>‚ö†Ô∏è</span> Skipped:</div><ul>`;
    skipped.forEach(s =>
      html += `<li>Step ${s.step} (has ${s.blockers.join(", ")})</li>`
    );
    html += "</ul>";
  }

  if (!html) {
    html = `<div class="warn"><span>‚ÑπÔ∏è</span> No changes were made.</div>`;
  }

  summary.innerHTML = html;
}

/* ---------- OUTPUT ---------- */
function syncOutput() {
  if (isMinified) {
    // Minified JSON (no spaces, single line)
    output.value = JSON.stringify(data);
  } else {
    // Formatted JSON with indentation
    output.value = JSON.stringify(data, null, 2);
  }
}

function copyOutput() {
  navigator.clipboard.writeText(output.value);
  
  // Update all copy buttons with success state
  const copyButtons = document.querySelectorAll('.copy-btn');
  copyButtons.forEach(btn => {
    const originalHTML = btn.innerHTML;
    const isMobile = btn.innerHTML.includes('Copy</span>');
    
    btn.innerHTML = isMinified 
      ? '<span>‚úì</span> Copied Minified!' 
      : '<span>‚úì</span> Copied Formatted!';
    
    setTimeout(() => {
      btn.innerHTML = originalHTML;
    }, 2000);
  });
  
  // Show a brief notification in the summary panel
  const currentSummary = summary.innerHTML;
  const formatType = isMinified ? "minified" : "formatted";
  summary.innerHTML = `
    <div class="ok">
      <span>‚úì</span>
      Copied ${formatType} JSON to clipboard
    </div>
    ${currentSummary}
  `;
}

/* ---------- INITIALIZATION ---------- */
document.addEventListener('DOMContentLoaded', function() {
  // Initialize format UI
  updateFormatUI();
  
  // Adjust layout on orientation change
  window.addEventListener('orientationchange', function() {
    setTimeout(renderTable, 100);
  });
});
</script>

</body>
</html>
