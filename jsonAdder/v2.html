<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JSON Step Adder</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f6f7fb;
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }

    textarea {
      width: 100%;
      min-height: 140px;
      padding: 10px;
      font-family: monospace;
      font-size: 14px;
      margin-bottom: 12px;
    }

    button {
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 4px;
      margin-right: 8px;
    }

    .copy-btn { background: #16a34a; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      background: white;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      font-size: 13px;
      text-align: left;
    }

    th {
      background: #f1f5f9;
      cursor: pointer;
      user-select: none;
    }

    th.sort-asc::after { content: " ‚ñ≤"; }
    th.sort-desc::after { content: " ‚ñº"; }

    tr.highlight {
      background-color: #fff7cc;
    }

    .panel {
      background: #fff;
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 12px;
      font-size: 13px;
    }

    .ok { color: green; }
    .warn { color: #b45309; }
    .err { color: red; }
  </style>
</head>
<body>

<h2>JSON Step Adder</h2>

<label><strong>Existing JSON</strong></label>
<textarea id="jsonInput"></textarea>
<button onclick="loadInput()">Load Input Preview</button>

<div id="tableContainer"></div>

<label><strong>New Steps (comma or new line separated)</strong></label>
<textarea id="stepsInput"></textarea>

<button onclick="addSteps()">Add Steps</button>
<button class="copy-btn" onclick="copyOutput()">Copy Output</button>

<label><strong>JSON Output</strong></label>
<textarea id="output" readonly></textarea>
<button onclick="loadOutput()">Load Output Preview</button>

<div id="summary" class="panel"></div>

<script>
let data = [];
let highlighted = new Set();
let sortState = {};

function today() {
  return new Date().toISOString().split("T")[0];
}

/* ---------- TABLE RENDER ---------- */
function renderTable(rows) {
  const container = document.getElementById("tableContainer");
  container.innerHTML = "";
  if (!rows.length) return;

  const cols = Object.keys(rows[0]);
  let html = "<table><thead><tr>";

  cols.forEach(c => {
    html += `<th onclick="sortBy('${c}')">${c}</th>`;
  });

  html += "</tr></thead><tbody>";

  rows.forEach((r, i) => {
    html += `<tr class="${highlighted.has(i) ? "highlight" : ""}">`;
    cols.forEach(c => html += `<td>${r[c] ?? ""}</td>`);
    html += "</tr>";
  });

  html += "</tbody></table>";
  container.innerHTML = html;
}

/* ---------- SORTING ---------- */
function sortBy(column) {
  const dir = sortState[column] === "asc" ? "desc" : "asc";
  sortState = { [column]: dir };

  data.sort((a, b) => {
    const x = a[column] ?? "";
    const y = b[column] ?? "";
    if (!isNaN(x) && !isNaN(y)) return dir === "asc" ? x - y : y - x;
    return dir === "asc"
      ? String(x).localeCompare(String(y))
      : String(y).localeCompare(String(x));
  });

  renderTable(data);
}

/* ---------- LOAD INPUT ---------- */
function loadInput() {
  try {
    data = JSON.parse(jsonInput.value);
    if (!Array.isArray(data)) throw "";
    highlighted.clear();
    renderTable(data);
    summary.innerHTML = "";
  } catch {
    summary.innerHTML = "<span class='err'>Invalid input JSON</span>";
  }
}

/* ---------- ADD / UPDATE STEPS ---------- */
function addSteps() {
  if (!data.length) return;

  const steps = stepsInput.value
    .split(/[\n,]+/)
    .map(s => s.trim())
    .filter(Boolean);

  const added = [];
  const updated = [];
  const skipped = [];

  const t = today();

  steps.forEach(s => {
    const step = Number(s);
    let handled = false;

    data.forEach((row, i) => {
      if (row.Steps === step) {
        const blockers = [];
        if (row.Date !== null) blockers.push("Date");
        if (row.IsCompleted !== null) blockers.push("IsCompleted");
        if (row.UpdatedBy !== null) blockers.push("UpdatedBy");

        if (blockers.length === 0) {
          row.Date = t;
          row.IsCompleted = 1;
          row.UpdatedBy = "System";
          highlighted.add(i);
          updated.push(step);
        } else {
          skipped.push({ step, blockers });
        }
        handled = true;
      }
    });

    if (!handled) {
      data.push({
        Date: t,
        IsCompleted: 1,
        Steps: step,
        UpdatedBy: "System"
      });
      highlighted.add(data.length - 1);
      added.push(step);
    }
  });

  output.value = JSON.stringify(data, null, 2);

  /* ---------- SUMMARY ---------- */
  let html = "";
  if (added.length)
    html += `<div class="ok">‚úÖ Added: ${added.join(", ")}</div>`;
  if (updated.length)
    html += `<div class="ok">üîÑ Updated: ${updated.join(", ")}</div>`;
  if (skipped.length) {
    html += `<div class="warn">‚ö†Ô∏è Skipped:</div><ul>`;
    skipped.forEach(s =>
      html += `<li>Step ${s.step} (has data in: ${s.blockers.join(", ")})</li>`
    );
    html += "</ul>";
  }

  summary.innerHTML = html;
}

/* ---------- OUTPUT PREVIEW ---------- */
function loadOutput() {
  try {
    const parsed = JSON.parse(output.value);
    if (!Array.isArray(parsed)) throw "";
    renderTable(parsed);
  } catch {
    summary.innerHTML = "<span class='err'>Invalid output JSON</span>";
  }
}

/* ---------- COPY ---------- */
function copyOutput() {
  navigator.clipboard.writeText(output.value);
}
</script>

</body>
</html>
