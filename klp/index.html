<!DOCTYPE html>
<html>
  <head>
    <title>KLP ‚Äì Home</title>
    <meta charset="utf-8" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <!-- Load shared JS -->
    <script src="klp.js"></script>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">KLP</a>
        <div>
          <a class="btn btn-sm btn-outline-light me-2" href="submit.html">
            Submit
          </a>
          <a class="btn btn-sm btn-outline-light me-2" href="my-items.html">
            My Knowledge
          </a>
          <a class="btn btn-sm btn-outline-light me-2" href="approval.html">
            Approvals
          </a>
          <button class="btn btn-sm btn-danger" onclick="logout()">
            Logout
          </button>
        </div>
      </div>
    </nav>

    <!-- MAIN -->
    <div class="container">
      <input
        id="search"
        class="form-control mb-4"
        placeholder="Search knowledge..."
      />

      <div id="results" class="row g-3"></div>
    </div>

    <!-- PAGE SCRIPT -->
    <script>
      const results = document.getElementById("results");
      let allItems = [];

      // Render cards
      function render(items) {
        results.innerHTML = "";

        if (items.length === 0) {
          results.innerHTML =
            '<div class="text-muted">No knowledge items found.</div>';
          return;
        }

        items.forEach((i) => {
          results.innerHTML += `
            <div class="col-md-4">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h5 class="card-title">${i.title}</h5>
                  <p class="text-muted mb-1">${i.system || ""}</p>
                  <span class="badge bg-${
                    i.status === "Approved" ? "success" : "secondary"
                  }">
                    ${i.status}
                  </span>
                </div>
                <div class="card-footer bg-white">
                  <a href="detail.html?id=${i.id}" class="btn btn-sm btn-primary">
                    View
                  </a>
                </div>
              </div>
            </div>
          `;
        });
      }

      // Search handler
      document.getElementById("search").oninput = (e) => {
        const q = e.target.value.toLowerCase();
        render(
          allItems.filter((i) =>
            i.title.toLowerCase().includes(q)
          )
        );
      };

      // Page init
      async function init() {
        await requireAuth();              // üîê Cloudflare Access check
        allItems = await getKnowledge();  // üì° Fetch from Worker
        render(allItems);
      }

      init();
    </script>
  </body>
</html>
