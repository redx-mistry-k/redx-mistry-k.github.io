<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Touch Bracelet - Stay Connected</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
      .heart-beat {
        animation: heartbeat 1.5s infinite;
      }
      @keyframes heartbeat {
        0% {
          transform: scale(1);
        }
        25% {
          transform: scale(1.1);
        }
        50% {
          transform: scale(1);
        }
        75% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }
      .gradient-bg {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      }
    </style>
  </head>
  <body class="gradient-bg min-h-screen font-sans">
    <div id="app" class="container mx-auto px-4 py-8">
      <!-- Initial Connection Screen -->
      <div
        id="connectionScreen"
        class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl p-6 text-center"
        data-aos="fade-up"
      >
        <div class="flex justify-center mb-6">
          <i data-feather="heart" class="text-pink-500 w-12 h-12"></i>
        </div>
        <h1 class="text-2xl font-bold text-gray-800 mb-4">
          Connect With Your Partner
        </h1>
        <p class="text-gray-600 mb-6">
          Share this unique code with your partner to connect your bracelets
        </p>

        <div class="bg-gray-100 p-4 rounded-lg mb-6">
          <p class="text-sm text-gray-500 mb-2">Your Connection Code</p>
          <p
            id="connectionCode"
            class="text-2xl font-mono font-bold text-indigo-600"
          >
            L0V3-8R4C3
          </p>
        </div>

        <div class="mb-6">
          <p class="text-gray-600 mb-2">Or enter your partner's code:</p>
          <div class="flex">
            <input
              type="text"
              id="partnerCode"
              class="flex-grow px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder="Partner's Code"
            />
            <button
              onclick="connectPartner()"
              class="bg-indigo-600 text-white px-4 py-2 rounded-r-lg hover:bg-indigo-700 transition"
            >
              Connect
            </button>
          </div>
        </div>

        <p class="text-xs text-gray-400">
          Once connected, touching your bracelet will send the current time to
          your partner
        </p>
      </div>

      <!-- Connected Bracelet Screen (hidden by default) -->
      <div
        id="braceletScreen"
        class="hidden max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl p-6 text-center"
        data-aos="fade-up"
      >
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center">
            <i data-feather="user" class="text-indigo-500 mr-2"></i>
            <span id="partnerName" class="font-medium">Partner</span>
          </div>
          <div class="text-sm text-gray-500" id="connectionStatus">
            Connected
          </div>
        </div>

        <div class="relative mb-8">
          <div
            id="bracelet"
            class="mx-auto w-48 h-48 rounded-full bg-gradient-to-br from-pink-200 to-indigo-200 flex items-center justify-center cursor-pointer hover:shadow-lg transition-all duration-300 heart-beat"
            onclick="sendTouch()"
          >
            <i data-feather="heart" class="text-pink-500 w-16 h-16"></i>
          </div>
          <div class="absolute -bottom-4 left-0 right-0 text-center">
            <p class="text-xs text-gray-500">
              Tap the bracelet to send your touch
            </p>
          </div>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg">
          <h3 class="text-lg font-medium text-gray-800 mb-2">
            Last Touch Received
          </h3>
          <div id="lastTouch" class="text-2xl font-bold text-indigo-600">
            No touches yet
          </div>
          <p id="touchTime" class="text-sm text-gray-500 mt-1"></p>
        </div>

        <div class="mt-6 text-center">
          <button
            onclick="disconnect()"
            class="text-indigo-600 hover:text-indigo-800 text-sm flex items-center justify-center mx-auto"
          >
            <i data-feather="log-out" class="mr-1 w-4 h-4"></i> Disconnect
          </button>
        </div>
      </div>
    </div>

    <!-- Firebase SDK (ES Modules) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
      import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

      // Initialize libraries
      AOS.init();
      feather.replace();

      // ðŸ”¥ Your Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyCoYRPn4ywytxBRczKpaaDiK1EHWCs6on4",
        authDomain: "coupletouch-k.firebaseapp.com",
        databaseURL: "https://coupletouch-k-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "coupletouch-k",
        storageBucket: "coupletouch-k.firebasestorage.app",
        messagingSenderId: "20044776718",
        appId: "1:20044776718:web:c3b9c8cb1839c4d809035f"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      let isConnected = false;
      let sessionCode = "";
      let userId = Math.random().toString(36).substring(2, 8);

      function generateConnectionCode() {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let result = "";
        for (let i = 0; i < 8; i++) {
          result += chars.charAt(Math.floor(Math.random() * chars.length));
          if (i === 3) result += "-";
        }
        document.getElementById("connectionCode").textContent = result;
        return result;
      }

      window.connectPartner = function() {
        const code = document.getElementById("partnerCode").value.trim();
        if (code.length === 8 || (code.length === 9 && code[4] === "-")) {
          sessionCode = code.replace("-", "");
          isConnected = true;

          // Save presence
          set(ref(db, "sessions/" + sessionCode + "/users/" + userId), true);

          document.getElementById("connectionScreen").classList.add("hidden");
          document.getElementById("braceletScreen").classList.remove("hidden");
          document.getElementById("partnerName").textContent = "Partner";

          // Listen for partner touches
          onValue(ref(db, "sessions/" + sessionCode + "/lastTouch"), (snapshot) => {
            const data = snapshot.val();
            if (data && data.user !== userId) {
              document.getElementById("lastTouch").textContent = "â¤ï¸ Touch Received";
              document.getElementById("touchTime").textContent = formatTime(new Date(data.time));
            }
          });
        } else {
          alert("Please enter a valid 8-character code");
        }
      }

      window.sendTouch = function() {
        if (!isConnected) return;
        const now = new Date();
        set(ref(db, "sessions/" + sessionCode + "/lastTouch"), {
          time: now.getTime(),
          user: userId
        });

        document.getElementById("lastTouch").textContent = "â¤ï¸ Touch Sent";
        document.getElementById("touchTime").textContent = formatTime(now);

        const bracelet = document.getElementById("bracelet");
        bracelet.classList.remove("heart-beat");
        bracelet.classList.add("animate-ping");
        setTimeout(() => {
          bracelet.classList.remove("animate-ping");
          bracelet.classList.add("heart-beat");
        }, 1000);
      }

      function formatTime(date) {
        return (
          date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }) +
          " on " +
          date.toLocaleDateString([], {
            weekday: "long",
            month: "short",
            day: "numeric",
          })
        );
      }

      window.disconnect = function() {
        isConnected = false;
        if (sessionCode) {
          remove(ref(db, "sessions/" + sessionCode + "/users/" + userId));
        }
        sessionCode = "";

        document.getElementById("connectionScreen").classList.remove("hidden");
        document.getElementById("braceletScreen").classList.add("hidden");
        document.getElementById("partnerCode").value = "";
        document.getElementById("lastTouch").textContent = "No touches yet";
        document.getElementById("touchTime").textContent = "";
      }

      window.onload = function () {
        generateConnectionCode();
      }
    </script>
  </body>
</html>