<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Touch Bracelet - Stay Connected</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <!-- Firebase App (required for Firebase products) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
      .heart-beat {
        animation: heartbeat 1.5s infinite;
      }
      @keyframes heartbeat {
        0% {
          transform: scale(1);
        }
        25% {
          transform: scale(1.1);
        }
        50% {
          transform: scale(1);
        }
        75% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }
      .gradient-bg {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      }
      .animate-ping {
        animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;
      }
      @keyframes ping {
        75%, 100% {
          transform: scale(1.5);
          opacity: 0;
        }
      }
      .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 10px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body class="gradient-bg min-h-screen font-sans">
    <div id="app" class="container mx-auto px-4 py-8">
      <!-- Initial Connection Screen -->
      <div
        id="connectionScreen"
        class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl p-6 text-center"
        data-aos="fade-up"
      >
        <div class="flex justify-center mb-6">
          <i data-feather="heart" class="text-pink-500 w-12 h-12"></i>
        </div>
        <h1 class="text-2xl font-bold text-gray-800 mb-4">
          Connect With Your Partner
        </h1>
        <p class="text-gray-600 mb-6">
          Share this unique code with your partner to connect your bracelets
        </p>

        <div class="bg-gray-100 p-4 rounded-lg mb-6">
          <p class="text-sm text-gray-500 mb-2">Your Connection Code</p>
          <p
            id="connectionCode"
            class="text-2xl font-mono font-bold text-indigo-600"
          >
            Generating...
          </p>
        </div>

        <div class="mb-6">
          <p class="text-gray-600 mb-2">Or enter your partner's code:</p>
          <div class="flex">
            <input
              type="text"
              id="partnerCode"
              class="flex-grow px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder="Partner's Code"
            />
            <button
              onclick="connectPartner()"
              class="bg-indigo-600 text-white px-4 py-2 rounded-r-lg hover:bg-indigo-700 transition flex items-center"
              id="connectButton"
            >
              Connect
            </button>
          </div>
        </div>

        <p class="text-xs text-gray-400">
          Once connected, touching your bracelet will send the current time to
          your partner
        </p>
      </div>

      <!-- Connected Bracelet Screen (hidden by default) -->
      <div
        id="braceletScreen"
        class="hidden max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl p-6 text-center"
        data-aos="fade-up"
      >
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center">
            <i data-feather="user" class="text-indigo-500 mr-2"></i>
            <span id="partnerName" class="font-medium">Partner</span>
          </div>
          <div class="text-sm text-gray-500" id="connectionStatus">
            Connected
          </div>
        </div>

        <div class="relative mb-8">
          <div
            id="bracelet"
            class="mx-auto w-48 h-48 rounded-full bg-gradient-to-br from-pink-200 to-indigo-200 flex items-center justify-center cursor-pointer hover:shadow-lg transition-all duration-300 heart-beat"
            onclick="sendTouch()"
          >
            <i data-feather="heart" class="text-pink-500 w-16 h-16"></i>
          </div>
          <div class="absolute -bottom-4 left-0 right-0 text-center">
            <p class="text-xs text-gray-500">
              Tap the bracelet to send your touch
            </p>
          </div>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg">
          <h3 class="text-lg font-medium text-gray-800 mb-2">
            Last Touch Received
          </h3>
          <div id="lastTouch" class="text-2xl font-bold text-indigo-600">
            No touches yet
          </div>
          <p id="touchTime" class="text-sm text-gray-500 mt-1"></p>
        </div>

        <div class="mt-6 text-center">
          <button
            onclick="disconnect()"
            class="text-indigo-600 hover:text-indigo-800 text-sm flex items-center justify-center mx-auto"
          >
            <i data-feather="log-out" class="mr-1 w-4 h-4"></i> Disconnect
          </button>
        </div>
      </div>
    </div>

    <script>
      // Initialize libraries
      AOS.init();
      feather.replace();

      // Firebase configuration - Replace with your project's config
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
      };
      
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      // Connection management
      let isConnected = false;
      let myConnectionCode = "";
      let partnerCode = "";
      let partnerName = "";
      let lastTouchTime = null;
      let connectionListener = null;
      let touchListener = null;

      // Generate random connection code
      function generateConnectionCode() {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let result = "";
        for (let i = 0; i < 8; i++) {
          result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
      }

      // Format code with hyphen
      function formatCode(code) {
        return code.substring(0, 4) + "-" + code.substring(4);
      }

      // Connect with partner
      function connectPartner() {
        const inputCode = document.getElementById("partnerCode").value.trim();
        const code = inputCode.replace("-", "");
        
        if (code.length !== 8) {
          alert("Please enter a valid 8-character code");
          return;
        }
        
        // Show loading state
        const connectButton = document.getElementById("connectButton");
        connectButton.innerHTML = 'Connecting <span class="loading-spinner"></span>';
        connectButton.disabled = true;
        
        partnerCode = code;
        
        // Check if partner exists in database
        database.ref('users/' + partnerCode).once('value')
          .then((snapshot) => {
            if (snapshot.exists()) {
              // Partner exists, establish connection
              establishConnection();
            } else {
              // Partner doesn't exist
              alert("No partner found with that code. Please check the code and try again.");
              connectButton.innerHTML = 'Connect';
              connectButton.disabled = false;
            }
          })
          .catch((error) => {
            console.error("Error checking partner:", error);
            alert("Error connecting to partner. Please try again.");
            connectButton.innerHTML = 'Connect';
            connectButton.disabled = false;
          });
      }

      // Establish connection with partner
      function establishConnection() {
        // Set up connection in database
        database.ref('connections/' + myConnectionCode + '_' + partnerCode).set({
          user1: myConnectionCode,
          user2: partnerCode,
          connectedAt: new Date().toISOString()
        });
        
        // Set up connection listener for partner's touches
        touchListener = database.ref('touches/' + myConnectionCode).on('value', (snapshot) => {
          if (snapshot.exists()) {
            const touchData = snapshot.val();
            processIncomingTouch(touchData);
            
            // Clear the touch after processing
            database.ref('touches/' + myConnectionCode).remove();
          }
        });
        
        // Get partner's name
        database.ref('users/' + partnerCode + '/name').once('value')
          .then((snapshot) => {
            partnerName = snapshot.exists() ? snapshot.val() : "Partner";
            document.getElementById("partnerName").textContent = partnerName;
            
            isConnected = true;
            
            // Show bracelet screen
            document.getElementById("connectionScreen").classList.add("hidden");
            document.getElementById("braceletScreen").classList.remove("hidden");
            
            // Reset connect button
            const connectButton = document.getElementById("connectButton");
            connectButton.innerHTML = 'Connect';
            connectButton.disabled = false;
            
            alert(`Connected with ${partnerName}!`);
          });
      }

      // Process incoming touch
      function processIncomingTouch(touchData) {
        const receivedTime = new Date(touchData.timestamp);
        lastTouchTime = receivedTime;
        
        document.getElementById("lastTouch").textContent = "❤️ Touch Received";
        document.getElementById("touchTime").textContent = formatTime(receivedTime);
        
        // Visual feedback for received touch
        const bracelet = document.getElementById("bracelet");
        bracelet.classList.remove("heart-beat");
        bracelet.classList.add("animate-ping");
        setTimeout(() => {
          bracelet.classList.remove("animate-ping");
          bracelet.classList.add("heart-beat");
        }, 1000);
      }

      // Send touch to partner
      function sendTouch() {
        if (!isConnected) {
          alert("You are not connected to a partner");
          return;
        }

        const now = new Date();
        
        // Send touch to partner via database
        database.ref('touches/' + partnerCode).set({
          from: myConnectionCode,
          to: partnerCode,
          timestamp: now.toISOString()
        });

        // Visual feedback
        const bracelet = document.getElementById("bracelet");
        bracelet.classList.remove("heart-beat");
        bracelet.classList.add("animate-ping");
        setTimeout(() => {
          bracelet.classList.remove("animate-ping");
          bracelet.classList.add("heart-beat");
        }, 1000);
      }

      // Format time display
      function formatTime(date) {
        return (
          date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }) +
          " on " +
          date.toLocaleDateString([], {
            weekday: "long",
            month: "short",
            day: "numeric",
          })
        );
      }

      // Disconnect from partner
      function disconnect() {
        if (isConnected) {
          // Remove connection from database
          database.ref('connections/' + myConnectionCode + '_' + partnerCode).remove();
          
          // Remove touch listener
          if (touchListener) {
            database.ref('touches/' + myConnectionCode).off('value', touchListener);
          }
        }
        
        // Remove user from database
        database.ref('users/' + myConnectionCode).remove();
        
        isConnected = false;
        partnerCode = "";
        partnerName = "";
        lastTouchTime = null;

        document.getElementById("connectionScreen").classList.remove("hidden");
        document.getElementById("braceletScreen").classList.add("hidden");
        document.getElementById("partnerCode").value = "";
        document.getElementById("lastTouch").textContent = "No touches yet";
        document.getElementById("touchTime").textContent = "";
      }

      // Initialize
      window.onload = function () {
        // Generate a connection code
        myConnectionCode = generateConnectionCode();
        document.getElementById("connectionCode").textContent = formatCode(myConnectionCode);
        
        // Register user in database
        database.ref('users/' + myConnectionCode).set({
          name: "User " + myConnectionCode.substring(0, 4),
          connected: false,
          createdAt: new Date().toISOString()
        });

        // Check if URL has partner code (for demo purposes)
        const urlParams = new URLSearchParams(window.location.search);
        const partner = urlParams.get("partner");
        if (partner) {
          document.getElementById("partnerCode").value = partner;
          // Don't auto-connect, let user click connect
        }
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
          disconnect();
        });
      };
    </script>
  </body>
</html>