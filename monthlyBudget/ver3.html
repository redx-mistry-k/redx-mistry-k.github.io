<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monthly Budget Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f7f9fc;
        color: #333;
        line-height: 1.6;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
        color: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      h1 {
        font-size: 2.2rem;
        margin-bottom: 10px;
      }

      h2 {
        font-size: 1.5rem;
        margin: 25px 0 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #4b6cb7;
        color: #2c3e50;
      }

      .summary-cards {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        flex: 1;
        min-width: 250px;
        text-align: center;
      }

      .card h3 {
        color: #4b6cb7;
        margin-bottom: 15px;
      }

      .card p {
        font-size: 1.8rem;
        font-weight: bold;
        color: #2c3e50;
      }

      .card .percentage {
        color: #27ae60;
        font-size: 1.2rem;
        margin-top: 10px;
      }

      .form-container {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
      }

      form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }
      #category {
        min-width: 180px;
        padding: 8px;
        display: block;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #2c3e50;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
      }

      button {
        background: #4b6cb7;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: background 0.3s;
      }

      button:hover {
        background: #3a5795;
      }
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        align-items: end;
      }
      .form-grid > div {
        display: flex;
        flex-direction: column;
      }

      .form-button-container {
        display: flex;
        justify-content: flex-end;
        align-items: center;
      }

      .diagram-container {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
        overflow: hidden;
      }

      #sankeyDiagram {
        width: 100%;
        height: 400px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      }

      th,
      td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      th {
        background-color: #4b6cb7;
        color: white;
        font-weight: 600;
      }

      tr:nth-child(even) {
        background-color: #f8f9fa;
      }

      tr:hover {
        background-color: #f1f3f5;
      }

      .income-amount {
        color: #27ae60;
        font-weight: bold;
      }

      .expense-amount {
        color: #e74c3c;
        font-weight: bold;
      }

      .actions button {
        padding: 8px 12px;
        font-size: 0.9rem;
        margin-right: 5px;
      }

      .delete-btn {
        background: #e74c3c;
      }

      .delete-btn:hover {
        background: #c0392b;
      }

      @media (max-width: 768px) {
        .summary-cards {
          flex-direction: column;
        }

        form {
          grid-template-columns: 1fr;
        }

        th,
        td {
          padding: 10px;
        }
      }

      form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
      }

      .form-button-container {
        grid-column: 1 / -1;
        display: flex;
        justify-content: center;
        margin-top: 10px;
      }

      .node-label {
        font-weight: bold;
        font-size: 12px;
        fill: #2c3e50;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Monthly Budget with Sankey Diagram</h1>
      <p>Visualize how your income flows to expenses and savings</p>
    </header>

    <div class="summary-cards">
      <div class="card">
        <h3>Total Income</h3>
        <p id="totalIncome">₹0.00</p>
      </div>
      <div class="card">
        <h3>Total Expenses</h3>
        <p id="totalExpenses">₹0.00</p>
      </div>
      <div class="card">
        <h3>Balance</h3>
        <p id="balance">₹0.00</p>
        <div class="percentage" id="savingsRate">Savings Rate: 0%</div>
      </div>
    </div>

    <div class="form-container">
      <h2>Add New Budget Item</h2>
      <p>Enter your income or expense details below</p>
      <form id="budgetForm">
        <!-- Added the missing id attribute here -->
        <div class="form-grid">
          <div>
            <label for="type">Type</label>
            <select id="type" required>
              <option value="Income">Income</option>
              <option value="Expense">Expense</option>
            </select>
          </div>

          <div>
            <label for="category">Category</label>
            <select id="category" required></select>
          </div>

          <div>
            <label for="amount">Amount (₹)</label>
            <input
              type="number"
              id="amount"
              placeholder="Enter amount"
              required
            />
          </div>

          <div>
            <label for="date">Date</label>
            <input type="date" id="date" required />
          </div>

          <div class="form-button-container">
            <button type="submit">Add Item</button>
          </div>
        </div>
      </form>
    </div>

    <div class="diagram-container">
      <h2>Budget Flow Diagram</h2>
      <p>Visualizing how your income is allocated to expenses and savings:</p>
      <div id="sankeyDiagram"></div>
    </div>
    <div id="sankeyLabels" class="diagram-labels"></div>

    <h2>Your Budget Items</h2>
    <table>
      <thead>
        <tr>
          <th>TYPE</th>
          <th>CATEGORY</th>
          <th>AMOUNT</th>
          <th>DATE</th>
          <th>ACTIONS</th>
        </tr>
      </thead>
      <tbody id="budgetTable">
        <!-- Budget items will be dynamically added here -->
      </tbody>
    </table>

    <script>
      // Define income and expense categories
      const incomeCategories = [
        "Salary",
        "Freelance",
        "Investments",
        "Gifts",
        "Other Income",
      ];

      const expenseCategories = [
        "Housing",
        "Utilities",
        "Food",
        "Transportation",
        "Healthcare",
        "Entertainment",
        "Education",
        "Shopping",
        "Other Expenses",
      ];
      const typeSelect = document.getElementById("type");
      const categorySelect = document.getElementById("category");

      function updateCategoryOptions() {
        categorySelect.innerHTML = ""; // clear old options
        let categories =
          typeSelect.value === "Income" ? incomeCategories : expenseCategories;

        categories.forEach((cat) => {
          let option = document.createElement("option");
          option.value = cat;
          option.textContent = cat;
          categorySelect.appendChild(option);
        });
      }

      // Listen for changes
      typeSelect.addEventListener("change", updateCategoryOptions);

      // Run once at page load to initialize
      updateCategoryOptions();

      // Budget data storage - load from localStorage or use default
      let budgetData = JSON.parse(localStorage.getItem("budgetData")) || [
        {
          type: "Income",
          category: "Salary",
          amount: 88000,
          date: new Date().toISOString().split("T")[0],
        },
        {
          type: "Expense",
          category: "Housing",
          amount: 8860,
          date: new Date().toISOString().split("T")[0],
        },
        {
          type: "Expense",
          category: "Utilities",
          amount: 2500,
          date: new Date().toISOString().split("T")[0],
        },
        {
          type: "Expense",
          category: "Other Expenses",
          amount: 18000,
          date: new Date().toISOString().split("T")[0],
        },
      ];

      // Save data to localStorage
      function saveToLocalStorage() {
        localStorage.setItem("budgetData", JSON.stringify(budgetData));
      }

      // Format currency in Indian Rupees
      function formatCurrency(amount) {
        return new Intl.NumberFormat("en-IN", {
          style: "currency",
          currency: "INR",
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }).format(amount);
      }

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        // Set today's date as default for the date input
        document.getElementById("date").valueAsDate = new Date();

        // Initialize category dropdown
        updateCategories();

        // Render initial budget table
        renderBudgetTable();

        // Calculate and render initial Sankey diagram
        updateSankeyDiagram();

        // Update summary cards
        updateSummaryCards();

        // Form submission handler
        document
          .getElementById("budgetForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();

            const type = document.getElementById("type").value;
            const category = document.getElementById("category").value;
            const amount = parseFloat(document.getElementById("amount").value);
            const date = document.getElementById("date").value;

            // Add new item to budget data
            budgetData.push({ type, category, amount, date });

            // Save to localStorage
            saveToLocalStorage();

            // Re-render the table and diagram
            renderBudgetTable();
            updateSankeyDiagram();
            updateSummaryCards();

            // Reset form
            this.reset();
            document.getElementById("date").valueAsDate = new Date();
            updateCategories();
          });

        // Update categories when type changes
        document
          .getElementById("type")
          .addEventListener("change", updateCategories);
      });

      // Update category dropdown based on type selection
      function updateCategories() {
        const type = document.getElementById("type").value;
        const categorySelect = document.getElementById("category");

        // Clear existing options
        categorySelect.innerHTML = "";

        // Add appropriate options based on type
        const categories =
          type === "Income" ? incomeCategories : expenseCategories;

        categories.forEach((category) => {
          const option = document.createElement("option");
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        });
      }

      // Function to render the budget table
      function renderBudgetTable() {
        const table = document.getElementById("budgetTable");
        table.innerHTML = "";

        // Sort by date (newest first)
        const sortedData = [...budgetData].sort(
          (a, b) => new Date(b.date) - new Date(a.date)
        );

        sortedData.forEach((item, index) => {
          const row = document.createElement("tr");

          const formattedDate = new Date(item.date).toLocaleDateString(
            "en-GB",
            {
              day: "2-digit",
              month: "short",
              year: "numeric",
            }
          );

          row.innerHTML = `
                    <td><strong>${item.type}</strong></td>
                    <td>${item.category}</td>
                    <td class="${item.type.toLowerCase()}-amount">${formatCurrency(
            item.amount
          )}</td>
                    <td>${formattedDate}</td>
                    <td class="actions">
                        <button class="delete-btn" data-index="${index}">Delete</button>
                    </td>
                `;

          table.appendChild(row);
        });

        // Add event listeners to delete buttons
        document.querySelectorAll(".delete-btn").forEach((button) => {
          button.addEventListener("click", function () {
            const index = parseInt(this.getAttribute("data-index"));
            budgetData.splice(index, 1);

            // Save to localStorage
            saveToLocalStorage();

            renderBudgetTable();
            updateSankeyDiagram();
            updateSummaryCards();
          });
        });
      }

      // Function to update summary cards
      function updateSummaryCards() {
        const totalIncome = budgetData
          .filter((item) => item.type === "Income")
          .reduce((sum, item) => sum + item.amount, 0);

        const totalExpenses = budgetData
          .filter((item) => item.type === "Expense")
          .reduce((sum, item) => sum + item.amount, 0);

        const balance = totalIncome - totalExpenses;
        const savingsRate =
          totalIncome > 0 ? ((balance / totalIncome) * 100).toFixed(1) : 0;

        document.getElementById("totalIncome").textContent =
          formatCurrency(totalIncome);
        document.getElementById("totalExpenses").textContent =
          formatCurrency(totalExpenses);
        document.getElementById("balance").textContent =
          formatCurrency(balance);
        document.getElementById(
          "savingsRate"
        ).textContent = `Savings Rate: ${savingsRate}%`;
      }

      // Function to update the Sankey diagram
      function updateSankeyDiagram() {
        // Clear previous diagram
        d3.select("#sankeyDiagram").selectAll("*").remove();

        // Calculate totals
        const totalIncome = budgetData
          .filter((item) => item.type === "Income")
          .reduce((sum, item) => sum + item.amount, 0);

        // If no income, don't render the diagram
        if (totalIncome <= 0) {
          d3.select("#sankeyDiagram")
            .append("div")
            .style("text-align", "center")
            .style("padding", "50px")
            .style("color", "#666")
            .text("Add income data to see the budget flow diagram");
          return;
        }

        const expensesByCategory = {};
        budgetData
          .filter((item) => item.type === "Expense")
          .forEach((item) => {
            expensesByCategory[item.category] =
              (expensesByCategory[item.category] || 0) + item.amount;
          });

        const totalExpenses = Object.values(expensesByCategory).reduce(
          (sum, amount) => sum + amount,
          0
        );
        const savings = Math.max(0, totalIncome - totalExpenses);

        // Prepare data for Sankey diagram
        const nodes = [
          { name: "Income" },
          ...Object.keys(expensesByCategory).map((category) => ({
            name: category,
          })),
          { name: "Savings" },
        ];

        const links = [
          ...Object.entries(expensesByCategory).map(([category, amount]) => ({
            source: "Income",
            target: category,
            value: amount,
          })),
          { source: "Income", target: "Savings", value: savings },
        ];

        // Map node names to indices
        const nodeMap = {};
        nodes.forEach((node, i) => {
          nodeMap[node.name] = i;
        });

        // Format data for D3 Sankey
        const sankeyData = {
          nodes: nodes,
          links: links.map((link) => ({
            source: nodeMap[link.source],
            target: nodeMap[link.target],
            value: link.value,
          })),
        };

        // Set up dimensions
        const width = document.getElementById("sankeyDiagram").clientWidth;
        const height = 400;

        // Create SVG container
        const svg = d3
          .select("#sankeyDiagram")
          .append("svg")
          .attr("width", width)
          .attr("height", height);

        // Set up Sankey generator
        const sankey = d3
          .sankey()
          .nodeWidth(15)
          .nodePadding(10)
          .extent([
            [1, 1],
            [width - 1, height - 5],
          ]);

        // Compute node and link positions
        const { nodes: sankeyNodes, links: sankeyLinks } = sankey({
          nodes: sankeyData.nodes.map((d) => Object.assign({}, d)),
          links: sankeyData.links.map((d) => Object.assign({}, d)),
        });

        // Color scale
        const color = d3
          .scaleOrdinal()
          .domain([
            "Income",
            "Housing",
            "Utilities",
            "Other Expenses",
            "Savings",
            "Food",
            "Transportation",
            "Entertainment",
            "Healthcare",
            "Education",
            "Shopping",
            "Freelance",
            "Investments",
            "Gifts",
            "Other Income",
          ])
          .range([
            "#4b6cb7",
            "#e74c3c",
            "#f39c12",
            "#9b59b6",
            "#27ae60",
            "#e67e22",
            "#3498db",
            "#1abc9c",
            "#d35400",
            "#8e44ad",
            "#2c3e50",
            "#16a085",
            "#2980b9",
            "#c0392b",
            "#7f8c8d",
          ]);

        // Draw the links
        const link = svg
          .append("g")
          .selectAll("path")
          .data(sankeyLinks)
          .join("path")
          .attr("d", d3.sankeyLinkHorizontal())
          .attr("stroke", (d) => d3.color(color(d.source.name)).darker(0.5))
          .attr("stroke-width", (d) => Math.max(1, d.width))
          .attr("fill", "none")
          .attr("stroke-opacity", 0.6)
          .style("mix-blend-mode", "multiply");

        // Add a gradient to links
        link
          .style("stroke", (d) => {
            return `url(#gradient-${d.index})`;
          })
          .each(function (d) {
            // Create gradient for each link
            const sourceColor = d3.color(color(d.source.name)).darker(0.5);
            const targetColor = d3.color(color(d.target.name)).darker(0.5);

            const gradient = svg
              .append("linearGradient")
              .attr("id", `gradient-${d.index}`)
              .attr("gradientUnits", "userSpaceOnUse")
              .attr("x1", d.source.x1)
              .attr("x2", d.target.x0);

            gradient
              .append("stop")
              .attr("offset", "0%")
              .attr("stop-color", sourceColor);

            gradient
              .append("stop")
              .attr("offset", "100%")
              .attr("stop-color", targetColor);
          });

        // Draw the nodes
        const node = svg
          .append("g")
          .selectAll("g")
          .data(sankeyNodes)
          .join("g")
          .attr("transform", (d) => `translate(${d.x0},${d.y0})`);

        node
          .append("rect")
          .attr("height", (d) => d.y1 - d.y0)
          .attr("width", (d) => d.x1 - d.x0)
          .attr("fill", (d) => color(d.name))
          .attr("stroke", (d) => d3.rgb(color(d.name)).darker(0.5));

        // Add labels with amounts for all nodes
        node
          .append("text")
          .attr("x", (d) => (d.x0 < width / 2 ? d.x1 + 10 : d.x0 - 10))
          .attr("y", (d) => (d.y1 + d.y0) / 2)
          .attr("dy", "0.35em")
          .attr("text-anchor", (d) => (d.x0 < width / 2 ? "start" : "end"))
          .text((d) => `${d.name}: ₹${d.value.toLocaleString("en-IN")}`)
          .style("font-size", "13px")
          .style("font-weight", "600")
          .style("fill", "#2c3e50");

        // Add category + value tooltips to links
        link.append("title").text((d) => {
          let targetLabel = d.target.name;
          if (d.target.name !== "Savings" && d.target.name !== "Income") {
            targetLabel = `Expense (${d.target.name})`;
          }
          return `${d.source.name} → ${targetLabel}: ${formatCurrency(
            d.value
          )}`;
        });
      }
    </script>
  </body>
</html>
