<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Excel â†’ Grouped JSON â†’ Export</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300..700;1,9..40,300..700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f1117;
      --surface: #181a24;
      --surface-2: #1e2030;
      --surface-3: #252839;
      --border: #2a2d3e;
      --border-hover: #3d4158;
      --text: #e2e4ed;
      --text-muted: #8b8fa7;
      --text-dim: #5c6078;
      --accent: #6c5ce7;
      --accent-glow: rgba(108, 92, 231, 0.25);
      --accent-hover: #7b6df0;
      --green: #2ed573;
      --green-dim: rgba(46, 213, 115, 0.12);
      --orange: #ffa502;
      --orange-dim: rgba(255, 165, 2, 0.12);
      --red: #ff4757;
      --radius: 10px;
      --radius-lg: 14px;
      --mono: 'JetBrains Mono', ui-monospace, monospace;
      --sans: 'DM Sans', -apple-system, sans-serif;
      --transition: 180ms ease;
    }

    body {
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Subtle grid background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(108, 92, 231, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(108, 92, 231, 0.03) 1px, transparent 1px);
      background-size: 60px 60px;
      pointer-events: none;
      z-index: 0;
    }

    .app {
      position: relative;
      z-index: 1;
      max-width: 860px;
      margin: 0 auto;
      padding: 48px 20px 80px;
    }

    /* Header */
    .header {
      margin-bottom: 36px;
    }

    .header h1 {
      font-size: 26px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: var(--text);
      margin-bottom: 8px;
    }

    .header p {
      font-size: 14px;
      color: var(--text-muted);
      max-width: 520px;
    }

    /* Steps indicator */
    .steps {
      display: flex;
      gap: 4px;
      margin-bottom: 32px;
    }

    .step {
      flex: 1;
      height: 3px;
      border-radius: 99px;
      background: var(--surface-3);
      transition: background var(--transition), box-shadow var(--transition);
    }

    .step.active {
      background: var(--accent);
      box-shadow: 0 0 12px var(--accent-glow);
    }

    .step.done {
      background: var(--green);
    }

    /* Card */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 28px;
      margin-bottom: 16px;
      transition: border-color var(--transition);
    }

    .card:hover {
      border-color: var(--border-hover);
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--text-muted);
      margin-bottom: 18px;
    }

    /* Upload area */
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 36px 24px;
      text-align: center;
      cursor: pointer;
      transition: border-color var(--transition), background var(--transition);
      position: relative;
    }

    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--accent);
      background: rgba(108, 92, 231, 0.04);
    }

    .upload-zone.has-file {
      border-color: var(--green);
      border-style: solid;
      background: var(--green-dim);
    }

    .upload-zone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .upload-icon {
      width: 40px;
      height: 40px;
      margin: 0 auto 12px;
      border-radius: 10px;
      background: var(--surface-3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: background var(--transition);
    }

    .upload-zone.has-file .upload-icon {
      background: var(--green-dim);
    }

    .upload-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 4px;
    }

    .upload-hint {
      font-size: 12px;
      color: var(--text-dim);
    }

    .file-name {
      font-family: var(--mono);
      font-size: 13px;
      color: var(--green);
      margin-top: 6px;
    }

    /* Selects row */
    .selects-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    @media (max-width: 560px) {
      .selects-row { grid-template-columns: 1fr; }
    }

    .field label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 6px;
      letter-spacing: 0.3px;
    }

    .field select {
      width: 100%;
      padding: 10px 12px;
      font-family: var(--sans);
      font-size: 14px;
      color: var(--text);
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      outline: none;
      appearance: none;
      cursor: pointer;
      transition: border-color var(--transition);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238b8fa7'%3E%3Cpath d='M6 8.5L1 3.5h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }

    .field select:hover { border-color: var(--border-hover); }
    .field select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
    .field select:disabled { opacity: 0.35; cursor: not-allowed; }

    .field select option {
      background: var(--surface-2);
      color: var(--text);
    }

    /* Buttons */
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 11px 18px;
      font-family: var(--sans);
      font-size: 13px;
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all var(--transition);
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      pointer-events: none;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      box-shadow: 0 2px 12px var(--accent-glow);
    }
    .btn-primary:hover:not(:disabled) {
      background: var(--accent-hover);
      box-shadow: 0 4px 20px var(--accent-glow);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--surface-3);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover:not(:disabled) {
      background: var(--border);
      border-color: var(--border-hover);
    }

    .btn-success {
      background: var(--green);
      color: #0f1117;
    }
    .btn-success:hover:not(:disabled) {
      filter: brightness(1.1);
      transform: translateY(-1px);
    }

    /* Status bar */
    .status-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
      transition: all var(--transition);
    }

    .status-bar .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--text-dim);
      flex-shrink: 0;
      transition: background var(--transition);
    }

    .status-bar.success .dot { background: var(--green); box-shadow: 0 0 8px rgba(46, 213, 115, 0.5); }
    .status-bar.processing .dot { background: var(--orange); animation: pulse 1s ease-in-out infinite; }
    .status-bar.error .dot { background: var(--red); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Preview / Output */
    .output-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .output-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
    }

    .output-header span {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--text-muted);
    }

    .output-header .badge {
      font-family: var(--mono);
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 6px;
      background: var(--accent-glow);
      color: var(--accent-hover);
      font-weight: 500;
    }

    .preview-box {
      padding: 18px 20px;
      max-height: 340px;
      overflow: auto;
      font-family: var(--mono);
      font-size: 12.5px;
      line-height: 1.7;
      color: var(--text-muted);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .preview-box .empty {
      color: var(--text-dim);
      font-style: italic;
    }

    /* JSON syntax colors */
    .json-key { color: #6c5ce7; }
    .json-string { color: #2ed573; }
    .json-number { color: #ffa502; }
    .json-null { color: #636e8a; }
    .json-bracket { color: #636e8a; }

    /* Scrollbar */
    .preview-box::-webkit-scrollbar { width: 6px; height: 6px; }
    .preview-box::-webkit-scrollbar-track { background: transparent; }
    .preview-box::-webkit-scrollbar-thumb { background: var(--surface-3); border-radius: 3px; }
    .preview-box::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }

    /* Stats row */
    .stats {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .stat {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 16px;
      flex: 1;
      min-width: 140px;
    }

    .stat-value {
      font-family: var(--mono);
      font-size: 22px;
      font-weight: 600;
      color: var(--text);
    }

    .stat-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--text-dim);
      margin-top: 2px;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: var(--surface-2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px 20px;
      border-radius: var(--radius);
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
      z-index: 999;
      opacity: 0;
      transition: all 300ms cubic-bezier(0.16, 1, 0.3, 1);
      pointer-events: none;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Fade-in animations */
    .fade-in {
      animation: fadeUp 400ms cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .delay-1 { animation-delay: 60ms; }
    .delay-2 { animation-delay: 120ms; }
    .delay-3 { animation-delay: 180ms; }
    .delay-4 { animation-delay: 240ms; }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <div class="header fade-in">
      <h1>Excel â†’ Grouped JSON</h1>
      <p>Upload a spreadsheet, pick a column to group by, and get a clean JSON output you can export or copy.</p>
    </div>

    <!-- Step progress -->
    <div class="steps fade-in delay-1">
      <div class="step" id="step1"></div>
      <div class="step" id="step2"></div>
      <div class="step" id="step3"></div>
      <div class="step" id="step4"></div>
    </div>

    <!-- Upload -->
    <div class="card fade-in delay-1">
      <div class="card-title">1 Â· Upload</div>
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" accept=".xlsx" />
        <div class="upload-icon">ðŸ“„</div>
        <div class="upload-label">Drop your .xlsx file here or click to browse</div>
        <div class="upload-hint">Only .xlsx files supported</div>
        <div class="file-name" id="fileName" style="display:none;"></div>
      </div>
    </div>

    <!-- Configure -->
    <div class="card fade-in delay-2">
      <div class="card-title">2 Â· Configure</div>
      <div class="selects-row">
        <div class="field">
          <label>Sheet</label>
          <select id="sheetSelect" disabled>
            <option value="">Upload a file first</option>
          </select>
        </div>
        <div class="field">
          <label>Group by column</label>
          <select id="groupColSelect" disabled>
            <option value="">Select a sheet first</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="card fade-in delay-3">
      <div class="card-title">3 Â· Generate</div>
      <div class="actions">
        <button class="btn btn-primary" id="processBtn" disabled>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
          Process & Generate
        </button>
        <button class="btn btn-success" id="exportBtn" disabled>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Export Excel
        </button>
        <button class="btn btn-secondary" id="copyBtn" disabled>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
          Copy JSON
        </button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats fade-in delay-3" id="statsRow" style="display:none;">
      <div class="stat">
        <div class="stat-value" id="statRows">0</div>
        <div class="stat-label">Total rows</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="statGroups">0</div>
        <div class="stat-label">Groups created</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="statCols">0</div>
        <div class="stat-label">Columns</div>
      </div>
    </div>

    <!-- Status -->
    <div class="status-bar fade-in delay-3" id="statusBar">
      <div class="dot"></div>
      <span id="statusText">Waiting for file...</span>
    </div>

    <!-- Preview -->
    <div class="output-card fade-in delay-4" style="margin-top: 16px;">
      <div class="output-header">
        <span>Preview</span>
        <span class="badge" id="previewBadge">JSON</span>
      </div>
      <div class="preview-box" id="previewBox"><span class="empty">Upload a file and process it to see the output here.</span></div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const fileInput = document.getElementById("fileInput");
    const uploadZone = document.getElementById("uploadZone");
    const fileNameEl = document.getElementById("fileName");
    const sheetSelect = document.getElementById("sheetSelect");
    const groupColSelect = document.getElementById("groupColSelect");
    const processBtn = document.getElementById("processBtn");
    const exportBtn = document.getElementById("exportBtn");
    const copyBtn = document.getElementById("copyBtn");
    const statusBar = document.getElementById("statusBar");
    const statusText = document.getElementById("statusText");
    const previewBox = document.getElementById("previewBox");
    const previewBadge = document.getElementById("previewBadge");
    const statsRow = document.getElementById("statsRow");
    const statRows = document.getElementById("statRows");
    const statGroups = document.getElementById("statGroups");
    const statCols = document.getElementById("statCols");
    const toast = document.getElementById("toast");

    const steps = [
      document.getElementById("step1"),
      document.getElementById("step2"),
      document.getElementById("step3"),
      document.getElementById("step4")
    ];

    let workbook = null;
    let currentRows = [];
    let outputRows = [];
    let selectedGroupCol = "";

    // -- Helpers --

    function setStep(n) {
      steps.forEach((s, i) => {
        s.className = 'step';
        if (i < n - 1) s.classList.add('done');
        else if (i === n - 1) s.classList.add('active');
      });
    }

    function setStatus(msg, type = '') {
      statusText.textContent = msg;
      statusBar.className = 'status-bar' + (type ? ' ' + type : '');
    }

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2400);
    }

    function safeJsonStringify(obj) {
      try { return JSON.stringify(obj); }
      catch { return "[]"; }
    }

    // Syntax highlight JSON
    function highlightJSON(str) {
      return str
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/"([^"]+)"(?=\s*:)/g, '<span class="json-key">"$1"</span>')
        .replace(/:\s*"([^"]*?)"/g, ': <span class="json-string">"$1"</span>')
        .replace(/:\s*(\d+\.?\d*)/g, ': <span class="json-number">$1</span>')
        .replace(/:\s*null/g, ': <span class="json-null">null</span>')
        .replace(/[[\]{}]/g, '<span class="json-bracket">$&</span>');
    }

    function formatDateYYYYMMDD(dateObj) {
      const yyyy = dateObj.getFullYear();
      const mm = String(dateObj.getMonth() + 1).padStart(2, "0");
      const dd = String(dateObj.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function excelSerialToDate(serial) {
      const utc_days = Math.floor(serial - 25569);
      const utc_value = utc_days * 86400;
      const date_info = new Date(utc_value * 1000);
      return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate());
    }

    function normalizeRowDates(row) {
      const out = { ...row };
      for (const key of Object.keys(out)) {
        const val = out[key];
        if (val === "" || val === null || val === undefined) { out[key] = null; continue; }
        if (val instanceof Date && !isNaN(val)) { out[key] = formatDateYYYYMMDD(val); continue; }
        if (typeof val === "number" && Number.isInteger(val) && val >= 25569 && val <= 90000) {
          out[key] = formatDateYYYYMMDD(excelSerialToDate(val));
          continue;
        }
        out[key] = val;
      }
      return out;
    }

    function parseSheetToRows(sheet) {
      const rows = XLSX.utils.sheet_to_json(sheet, { defval: "", raw: true });
      return rows.map(normalizeRowDates);
    }

    function getHeadersFromRows(rows) {
      if (!rows.length) return [];
      const keys = new Set();
      rows.forEach(r => Object.keys(r).forEach(k => keys.add(k)));
      return [...keys];
    }

    function fillSelect(selectEl, options, placeholder) {
      selectEl.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = placeholder;
      selectEl.appendChild(ph);
      options.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        selectEl.appendChild(o);
      });
    }

    function groupBySelectedColumn(rows, groupCol) {
      const groups = new Map();
      rows.forEach(row => {
        const keyRaw = row[groupCol];
        const key = String(keyRaw).trim();
        if (!key) return;
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push({ ...row });
      });
      const result = [];
      for (const [groupValue, list] of groups.entries()) {
        const outRow = {};
        outRow[groupCol] = groupValue;
        outRow.json_list = safeJsonStringify(list);
        result.push(outRow);
      }
      return result;
    }

    function renderPreview(data, groupCol) {
      const preview = data.slice(0, 5).map(r => ({
        [groupCol]: r[groupCol],
        json_list: JSON.parse(r.json_list)
      }));
      const raw = JSON.stringify(preview, null, 2);
      previewBox.innerHTML = highlightJSON(raw);
      previewBadge.textContent = `JSON Â· ${data.length} groups`;
    }

    function exportToExcel(rows, groupCol) {
      const headers = [groupCol, "json_list"];
      const ws = XLSX.utils.json_to_sheet(rows, { header: headers });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Grouped_JSON");
      XLSX.writeFile(wb, "grouped_json_output.xlsx");
    }

    // -- Drag & drop --
    uploadZone.addEventListener("dragover", (e) => { e.preventDefault(); uploadZone.classList.add("dragover"); });
    uploadZone.addEventListener("dragleave", () => uploadZone.classList.remove("dragover"));
    uploadZone.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadZone.classList.remove("dragover");
      const file = e.dataTransfer.files?.[0];
      if (file && file.name.endsWith('.xlsx')) {
        loadFile(file);
      } else {
        showToast("Please drop an .xlsx file");
      }
    });

    // -- Events --

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (file) loadFile(file);
    });

    async function loadFile(file) {
      setStatus("Reading file...", "processing");
      setStep(1);
      outputRows = [];
      exportBtn.disabled = true;
      copyBtn.disabled = true;
      processBtn.disabled = true;
      groupColSelect.disabled = true;
      sheetSelect.disabled = true;
      statsRow.style.display = "none";

      uploadZone.classList.add("has-file");
      fileNameEl.textContent = file.name;
      fileNameEl.style.display = "block";

      const arrayBuffer = await file.arrayBuffer();
      workbook = XLSX.read(arrayBuffer, { type: "array", cellDates: true });

      const sheetNames = workbook.SheetNames || [];
      fillSelect(sheetSelect, sheetNames, "Select sheet");
      sheetSelect.disabled = false;

      // Auto-select if only one sheet
      if (sheetNames.length === 1) {
        sheetSelect.value = sheetNames[0];
        sheetSelect.dispatchEvent(new Event("change"));
      }

      setStatus(`Loaded "${file.name}" with ${sheetNames.length} sheet${sheetNames.length > 1 ? 's' : ''}`, "success");
      setStep(1);
      previewBox.innerHTML = '<span class="empty">Select a sheet and group column, then hit Process.</span>';
    }

    sheetSelect.addEventListener("change", () => {
      const sheetName = sheetSelect.value;
      if (!sheetName || !workbook) return;

      const sheet = workbook.Sheets[sheetName];
      currentRows = parseSheetToRows(sheet);
      const headers = getHeadersFromRows(currentRows);

      fillSelect(groupColSelect, headers, "Select group column");
      groupColSelect.disabled = false;
      processBtn.disabled = false;
      exportBtn.disabled = true;
      copyBtn.disabled = true;

      setStatus(`Sheet "${sheetName}" loaded Â· ${currentRows.length} rows Â· ${headers.length} columns`, "success");
      setStep(2);
      previewBox.innerHTML = '<span class="empty">Choose a group column and hit Process.</span>';
    });

    groupColSelect.addEventListener("change", () => {
      if (groupColSelect.value) setStep(3);
    });

    processBtn.addEventListener("click", () => {
      const groupCol = groupColSelect.value;
      if (!groupCol) {
        showToast("Pick a column to group by first");
        return;
      }

      selectedGroupCol = groupCol;
      setStatus("Processing...", "processing");

      // Small delay for visual feedback
      setTimeout(() => {
        outputRows = groupBySelectedColumn(currentRows, groupCol);
        const headers = getHeadersFromRows(currentRows);

        setStatus(`Done! ${outputRows.length} groups created. Dates formatted as yyyy-mm-dd.`, "success");
        setStep(4);
        renderPreview(outputRows, groupCol);

        statsRow.style.display = "flex";
        statRows.textContent = currentRows.length;
        statGroups.textContent = outputRows.length;
        statCols.textContent = headers.length;

        exportBtn.disabled = outputRows.length === 0;
        copyBtn.disabled = outputRows.length === 0;
      }, 150);
    });

    exportBtn.addEventListener("click", () => {
      if (!outputRows.length) return;
      exportToExcel(outputRows, selectedGroupCol);
      showToast("Downloaded grouped_json_output.xlsx");
    });

    copyBtn.addEventListener("click", async () => {
      if (!outputRows.length) return;
      const full = outputRows.map(r => ({
        [selectedGroupCol]: r[selectedGroupCol],
        json_list: JSON.parse(r.json_list)
      }));
      const text = JSON.stringify(full, null, 2);
      try {
        await navigator.clipboard.writeText(text);
        showToast("Copied to clipboard");
      } catch {
        showToast("Clipboard blocked. Copy from preview manually.");
      }
    });
  </script>
</body>
</html>
